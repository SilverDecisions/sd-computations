require=function e(t,n,o){function i(a,u){if(!n[a]){if(!t[a]){var s="function"==typeof require&&require;if(!u&&s)return s(a,!0);if(r)return r(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return i(n?n:e)},l,l.exports,e,t,n,o)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<o.length;a++)i(o[a]);return i}({1:[function(e,t,n){"use strict";!function(){function e(e){return Array.prototype.slice.call(e)}function n(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function o(e,t,o){var i,r=new Promise(function(r,a){i=e[t].apply(e,o),n(i).then(r,a)});return r.request=i,r}function i(e,t,n){var i=o(e,t,n);return i.then(function(e){if(e)return new l(e,i.request)})}function r(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function a(e,t,n,i){i.forEach(function(i){i in n.prototype&&(e.prototype[i]=function(){return o(this[t],i,arguments)})})}function u(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return this[t][o].apply(this[t],arguments)})})}function s(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return i(this[t],o,arguments)})})}function c(e){this._index=e}function l(e,t){this._cursor=e,this._request=t}function f(e){this._store=e}function p(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function d(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new p(n)}function b(e){this._db=e}r(c,"_index",["name","keyPath","multiEntry","unique"]),a(c,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(c,"_index",IDBIndex,["openCursor","openKeyCursor"]),r(l,"_cursor",["direction","key","primaryKey","value"]),a(l,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(l.prototype[e]=function(){var t=this,o=arguments;return Promise.resolve().then(function(){return t._cursor[e].apply(t._cursor,o),n(t._request).then(function(e){if(e)return new l(e,t._request)})})})}),f.prototype.createIndex=function(){return new c(this._store.createIndex.apply(this._store,arguments))},f.prototype.index=function(){return new c(this._store.index.apply(this._store,arguments))},r(f,"_store",["name","keyPath","indexNames","autoIncrement"]),a(f,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),s(f,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),u(f,"_store",IDBObjectStore,["deleteIndex"]),p.prototype.objectStore=function(){return new f(this._tx.objectStore.apply(this._tx,arguments))},r(p,"_tx",["objectStoreNames","mode"]),u(p,"_tx",IDBTransaction,["abort"]),d.prototype.createObjectStore=function(){return new f(this._db.createObjectStore.apply(this._db,arguments))},r(d,"_db",["name","version","objectStoreNames"]),u(d,"_db",IDBDatabase,["deleteObjectStore","close"]),b.prototype.transaction=function(){return new p(this._db.transaction.apply(this._db,arguments))},r(b,"_db",["name","version","objectStoreNames"]),u(b,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(t){[f,c].forEach(function(n){n.prototype[t.replace("open","iterate")]=function(){var n=e(arguments),o=n[n.length-1],i=this._store||this._index,r=i[t].apply(i,n.slice(0,-1));r.onsuccess=function(){o(r.result)}}})}),[c,f].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,o=[];return new Promise(function(i){n.iterateCursor(e,function(e){return e?(o.push(e.value),void 0!==t&&o.length==t?void i(o):void e["continue"]()):void i(o)})})})});var y={open:function(e,t,n){var i=o(indexedDB,"open",[e,t]),r=i.request;return r.onupgradeneeded=function(e){n&&n(new d(r.result,e.oldVersion,r.transaction))},i.then(function(e){return new b(e)})},"delete":function(e){return o(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof t?t.exports=y:self.idb=y}()},{}],2:[function(e,t,n){(function(t){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.ComputationsEngine=n.ComputationsEngineConfig=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=function p(e,t,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:p(i,t,n)}if("value"in o)return o.value;var r=o.get;if(void 0!==r)return r.call(n)},c=e("sd-utils"),l=e("sd-model"),f=e("./computations-manager");n.ComputationsEngineConfig=function(e){function t(e){o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.logLevel="warn",e&&c.Utils.deepExtend(n,e),n}return r(t,e),t}(f.ComputationsManagerConfig),n.ComputationsEngine=function(e){function n(e,r){o(this,n);var a=i(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,r));if(a.global=c.Utils.getGlobalObject(),a.isWorker=c.Utils.isWorker(),a.isWorker){a.jobsManger.registerJobExecutionListener({beforeJob:function(e){a.reply("beforeJob",e.getDTO())},afterJob:function(e){a.reply("afterJob",e.getDTO())}});var u=a;a.queryableFunctions={runJob:function(e,t,n){var o=new l.DataModel(n);u.runJob(e,t,o)},executeJob:function(e){u.jobsManger.execute(e)},recompute:function(e,t,n,o){t&&u.objectiveRulesManager.setCurrentRuleByName(t);var i=!t,r=new l.DataModel(e);u._checkValidityAndRecomputeObjective(r,i,n,o),this.reply("recomputed",r.getDTO())}},t.onmessage=function(e){e.data instanceof Object&&e.data.hasOwnProperty("queryMethod")&&e.data.hasOwnProperty("queryArguments")?u.queryableFunctions[e.data.queryMethod].apply(self,e.data.queryArguments):u.defaultReply(e.data)}}return a}return r(n,e),u(n,[{key:"setConfig",value:function(e){return s(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setConfig",this).call(this,e),this.setLogLevel(this.config.logLevel),this}},{key:"setLogLevel",value:function(e){c.log.setLevel(e)}},{key:"defaultReply",value:function(e){this.reply("test",e)}},{key:"reply",value:function(){if(arguments.length<1)throw new TypeError("reply - not enough arguments");this.global.postMessage({queryMethodListener:arguments[0],queryMethodArguments:Array.prototype.slice.call(arguments,1)})}}]),n}(f.ComputationsManager)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./computations-manager":3,"sd-model":"sd-model","sd-utils":"sd-utils"}],3:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ComputationsManager=n.ComputationsManagerConfig=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-expression-engine"),a=e("sd-utils"),u=e("./objective/objective-rules-manager"),s=e("./validation/tree-validator"),c=e("./operations/operations-manager"),l=e("./jobs/jobs-manager"),f=e("./expressions-evaluator"),p=(e("./jobs/engine/exceptions/job-data-invalid-exception"),e("./jobs/engine/exceptions/job-parameters-invalid-exception"),e("./jobs/job-instance-manager")),d=n.ComputationsManagerConfig=function b(e){o(this,b),this.logLevel=null,this.ruleName=null,this.worker={delegateRecomputation:!1,url:null},e&&a.Utils.deepExtend(this,e)};n.ComputationsManager=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;o(this,e),this.data=n,this.setConfig(t),this.expressionEngine=new r.ExpressionEngine,this.expressionsEvaluator=new f.ExpressionsEvaluator(this.expressionEngine),this.objectiveRulesManager=new u.ObjectiveRulesManager(this.data,this.expressionEngine,this.config.ruleName),this.operationsManager=new c.OperationsManager(this.data,this.expressionEngine),this.jobsManger=new l.JobsManager(this.expressionsEvaluator,this.objectiveRulesManager,this.config.worker.url),this.treeValidator=new s.TreeValidator(this.expressionEngine)}return i(e,[{key:"setConfig",value:function(e){return this.config=new d(e),this}},{key:"getCurrentRule",value:function(){return this.objectiveRulesManager.currentRule}},{key:"getJobByName",value:function(e){return this.jobsManger.getJobByName(e)}},{key:"runJob",value:function(e,t,n){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.jobsManger.run(e,t,n||this.data,o)}},{key:"runJobWithInstanceManager",value:function(e,t,n){var o=this;return this.runJob(e,t).then(function(e){return new p.JobInstanceManager(o.jobsManger,e,n)})}},{key:"getObjectiveRules",value:function(){return this.objectiveRulesManager.rules}},{key:"isRuleName",value:function(e){return this.objectiveRulesManager.isRuleName(e)}},{key:"setCurrentRuleByName",value:function(e){return this.config.ruleName=e,this.objectiveRulesManager.setCurrentRuleByName(e)}},{key:"operationsForObject",value:function(e){return this.operationsManager.operationsForObject(e)}},{key:"checkValidityAndRecomputeObjective",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return Promise.resolve().then(function(){if(t.config.worker.delegateRecomputation){var i={evalCode:n,evalNumeric:o};return e||(i.ruleName=t.getCurrentRule().name),t.runJob("recompute",i,t.data,!1).then(function(e){var n=e.getData();t.data.updateFrom(n)})}return t._checkValidityAndRecomputeObjective(t.data,e,n,o)}).then(function(){t.updateDisplayValues(t.data)})}},{key:"_checkValidityAndRecomputeObjective",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];e.validationResults=[],(o||i)&&this.expressionsEvaluator.evalExpressions(e,o,i),e.getRoots().forEach(function(o){var i=n.treeValidator.validate(e.getAllNodesInSubtree(o));e.validationResults.push(i),i.isValid()&&n.objectiveRulesManager.recomputeTree(o,t)})}},{key:"updateDisplayValues",value:function(e){var t=this;e.nodes.forEach(function(e){t.updateNodeDisplayValues(e)}),e.edges.forEach(function(e){t.updateEdgeDisplayValues(e)})}},{key:"updateNodeDisplayValues",value:function(e){var t=this;e.$DISPLAY_VALUE_NAMES.forEach(function(n){return e.displayValue(n,t.objectiveRulesManager.getNodeDisplayValue(e,n))})}},{key:"updateEdgeDisplayValues",value:function(e){var t=this;e.$DISPLAY_VALUE_NAMES.forEach(function(n){return e.displayValue(n,t.objectiveRulesManager.getEdgeDisplayValue(e,n))})}}]),e}()},{"./expressions-evaluator":4,"./jobs/engine/exceptions/job-data-invalid-exception":15,"./jobs/engine/exceptions/job-parameters-invalid-exception":19,"./jobs/job-instance-manager":40,"./jobs/jobs-manager":42,"./objective/objective-rules-manager":43,"./operations/operations-manager":54,"./validation/tree-validator":60,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],4:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ExpressionsEvaluator=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-expression-engine"),a=e("sd-model"),u=e("sd-utils");n.ExpressionsEvaluator=function(){function e(t){o(this,e),this.expressionEngine=t}return i(e,[{key:"clearTree",value:function(e,t){e.getAllNodesInSubtree(t).forEach(function(e){e.clearComputedValues(),e.childEdges.forEach(function(e){e.clearComputedValues()})})}},{key:"evalExpressions",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];u.log.debug("evalExpressions evalCode:"+t+" evalNumeric:"+o),t&&this.evalGlobalCode(e),e.getRoots().forEach(function(r){n.clearTree(e,r),n.evalExpressionsForNode(e,r,t,o,i)})}},{key:"evalGlobalCode",value:function(e){e.clearExpressionScope(),e.$codeDirty=!1;try{e.$codeError=null,this.expressionEngine.eval(e.code,!1,e.expressionScope)}catch(t){e.$codeError=t}}},{key:"evalExpressionsForNode",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=this,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if((!t.expressionScope||s||n)&&this.initScopeForNode(e,t),n&&(t.$codeDirty=!1,t.code))try{t.$codeError=null,this.expressionEngine.eval(t.code,!1,t.expressionScope)}catch(c){t.$codeError=c,u.log.debug(c)}if(i){var l=t.expressionScope,f=r.ExpressionEngine.toNumber(0),p=[],d=!1;if(t.childEdges.forEach(function(e){if(e.isFieldValid("payoff",!0,!1))try{e.computedValue(null,"payoff",o.expressionEngine.evalPayoff(e))}catch(n){}if(t instanceof a.domain.ChanceNode){if(r.ExpressionEngine.isHash(e.probability))return void p.push(e);if(r.ExpressionEngine.hasAssignmentExpression(e.probability))return u.log.warn("evalExpressionsForNode hasAssignmentExpression!",e),null;if(e.isFieldValid("probability",!0,!1))try{var i=o.expressionEngine.eval(e.probability,!0,l);e.computedValue(null,"probability",i),f=r.ExpressionEngine.add(f,i)}catch(n){d=!0}else d=!0}}),t instanceof a.domain.ChanceNode){var b=p.length&&!d&&f.compare(0)>=0&&f.compare(1)<=0;if(b){var y=r.ExpressionEngine.divide(r.ExpressionEngine.subtract(1,f),p.length);p.forEach(function(e){e.computedValue(null,"probability",y)})}}t.childEdges.forEach(function(t){o.evalExpressionsForNode(e,t.childNode,n,i,s)})}}},{key:"initScopeForNode",value:function(e,t){var n=t.$parent,o=n?n.expressionScope:e.expressionScope;t.expressionScope=u.Utils.cloneDeep(o)}}]),e}()},{"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./computations-engine");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var i=e("./computations-manager");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var r=e("./expressions-evaluator");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var a=e("./jobs/index");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}})})},{"./computations-engine":2,"./computations-manager":3,"./expressions-evaluator":4,"./jobs/index":39}],6:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.ProbabilisticSensitivityAnalysisJobParameters=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-utils"),c=e("../../engine/job-parameters"),l=e("../../engine/job-parameter-definition");n.ProbabilisticSensitivityAnalysisJobParameters=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),u(t,[{key:"initDefinitions",value:function(){this.definitions.push(new l.JobParameterDefinition("id",l.PARAMETER_TYPE.STRING,1,1,(!0))),this.definitions.push(new l.JobParameterDefinition("ruleName",l.PARAMETER_TYPE.STRING)),this.definitions.push(new l.JobParameterDefinition("numberOfRuns",l.PARAMETER_TYPE.INTEGER).set("singleValueValidator",function(e){return e>0})),this.definitions.push(new l.JobParameterDefinition("variables",[new l.JobParameterDefinition("name",l.PARAMETER_TYPE.STRING),new l.JobParameterDefinition("formula",l.PARAMETER_TYPE.NUMBER_EXPRESSION)],1,1/0,(!1),null,function(e){return s.Utils.isUnique(e,function(e){return e.name})}))}},{key:"initDefaultValues",value:function(){this.values={id:s.Utils.guid()}}}]),t}(c.JobParameters)},{"../../engine/job-parameter-definition":29,"../../engine/job-parameters":30,"sd-utils":"sd-utils"}],7:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.ProbabilisticSensitivityAnalysisJob=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("../../engine/simple-job"),c=e("../../engine/step"),l=e("../../engine/job-status"),f=e("../../../validation/tree-validator"),p=e("./probabilistic-sensitivity-analysis-job-parameters"),d=(e("sd-utils"),e("../../engine/batch/batch-step")),b=(e("sd-model"),e("sd-expression-engine")),y=e("../sensitivity-analysis/sensitivity-analysis-job"),h=(n.ProbabilisticSensitivityAnalysisJob=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"probabilistic-sensitivity-analysis",e));return a.addStep(new h(e)),a.addStep(new v(e)),a.addStep(new m(e,n,r)),a}return r(t,e),u(t,[{key:"createJobParameters",value:function(e){return new p.ProbabilisticSensitivityAnalysisJobParameters(e)}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return 1===e.getRoots().length}}}},{key:"getProgress",value:function(e){if(l.JOB_STATUS.COMPLETED===e.status)return 100;if(!e.stepExecutions.length)return 0;if(1==e.stepExecutions.length)return l.JOB_STATUS.COMPLETED===e.stepExecutions[0].status?1:0;if(2==e.stepExecutions.length)return l.JOB_STATUS.COMPLETED===e.stepExecutions[0].status?2:1;var t=e.stepExecutions[2];return l.JOB_STATUS.COMPLETED===t.status?100:Math.max(2,Math.round(.98*this.steps[2].getProgress(t)))}}]),t}(s.SimpleJob),function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"prepare_variables",e))}return r(t,e),u(t,[{key:"doExecute",value:function(e){var t=e.getJobParameters(),n=(t.value("variables"),[]);return e.executionContext.put("variableValues",n),e.getJobExecutionContext().put("variableValues",n),e.exitStatus=l.JOB_STATUS.COMPLETED,e}}]),t}(c.Step)),v=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"init_policies",e))}return r(t,e),u(t,[{key:"doExecute",value:function(e){var t=e.getData(),n=t.getRoots()[0],o=new y.PoliciesCollector(n);return console.log("policies",o.policies),e.executionContext.put("policies",o.policies),e.exitStatus=l.JOB_STATUS.COMPLETED,e}}]),t}(c.Step),m=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"calculate_step",e,5));return a.expressionsEvaluator=n,a.objectiveRulesManager=r,a.treeValidator=new f.TreeValidator,a}return r(t,e),u(t,[{key:"init",value:function(e){var t=e.getJobParameters(),n=t.value("ruleName");this.objectiveRulesManager.setCurrentRuleByName(n);var o=e.executionContext.get("variableValues"),i=t.value("variables").map(function(e){return e.name});if(e.executionContext.put("variableNames",i),!e.jobExecution.getResult()){var r=["policy"];i.forEach(function(e){return r.push(e)}),r.push("payoff"),e.jobExecution.setResult({headers:r,rows:[]})}return o.length}},{key:"readNextChunk",value:function(e,t,n){var o=e.executionContext.get("variableValues");return o.slice(t,t+n)}},{key:"processItem",value:function(e,t){var n=e.getJobParameters(),o=n.value("ruleName"),i=e.getData(),r=i.getRoots()[0],a=e.executionContext.get("variableNames");this.expressionsEvaluator.evalGlobalCode(i),a.forEach(function(e,n){i.expressionScope[e]=t[n]}),this.expressionsEvaluator.evalExpressionsForNode(i,r);var u=this.treeValidator.validate(i.getAllNodesInSubtree(r));if(!u.isValid())return null;this.objectiveRulesManager.recomputeTree(r,!1);var s=new y.PoliciesCollector(r,o).policies,c={data:i.getDTO(),policies:s,variables:t,payoff:r.computedValue(o,"payoff")};return c}},{key:"writeChunk",value:function(e,t){var n=e.jobExecution.getResult();t.forEach(function(e){e&&e.policies.forEach(function(t){var o=[t.key];e.variables.forEach(function(e){return o.push(e)}),o.push(b.ExpressionEngine.toFloat(e.payoff)),n.rows.push({cells:o,data:e.data})})})}}]),t}(d.BatchStep)},{"../../../validation/tree-validator":60,"../../engine/batch/batch-step":12,"../../engine/job-status":33,"../../engine/simple-job":35,"../../engine/step":38,"../sensitivity-analysis/sensitivity-analysis-job":11,"./probabilistic-sensitivity-analysis-job-parameters":6,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],8:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.RecomputeJobParameters=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-utils"),c=e("../../engine/job-parameters"),l=e("../../engine/job-parameter-definition");n.RecomputeJobParameters=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),u(t,[{key:"initDefinitions",value:function(){this.definitions.push(new l.JobParameterDefinition("id",l.PARAMETER_TYPE.STRING,1,1,(!0))),this.definitions.push(new l.JobParameterDefinition("ruleName",l.PARAMETER_TYPE.STRING,0)),this.definitions.push(new l.JobParameterDefinition("evalCode",l.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new l.JobParameterDefinition("evalNumeric",l.PARAMETER_TYPE.BOOLEAN))}},{key:"initDefaultValues",value:function(){this.values={id:s.Utils.guid(),ruleName:null,evalCode:!0,evalNumeric:!0}}}]),t}(c.JobParameters)},{"../../engine/job-parameter-definition":29,"../../engine/job-parameters":30,"sd-utils":"sd-utils"}],9:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.RecomputeJob=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=(e("../../engine/simple-job"),e("../../engine/step"),e("../../engine/job-status"),e("../../../validation/tree-validator")),c=(e("../../engine/batch/batch-step"),e("./recompute-job-parameters")),l=e("../../engine/job");n.RecomputeJob=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"recompute",e));return a.isRestartable=!1,a.expressionsEvaluator=n,a.objectiveRulesManager=r,a.treeValidator=new s.TreeValidator,a}return r(t,e),u(t,[{key:"doExecute",value:function(e){var t=e.getData(),n=e.jobParameters,o=n.value("ruleName"),i=!o;return o&&this.objectiveRulesManager.setCurrentRuleByName(o),this.checkValidityAndRecomputeObjective(t,i,n.value("evalCode"),n.value("evalNumeric")),e}},{key:"checkValidityAndRecomputeObjective",value:function(e,t,n,o){var i=this;e.validationResults=[],(n||o)&&this.expressionsEvaluator.evalExpressions(e,n,o),e.getRoots().forEach(function(n){var o=i.treeValidator.validate(e.getAllNodesInSubtree(n));e.validationResults.push(o),o.isValid()&&i.objectiveRulesManager.recomputeTree(n,t)})}},{key:"createJobParameters",value:function(e){return new c.RecomputeJobParameters(e)}}]),t}(l.Job)},{"../../../validation/tree-validator":60,"../../engine/batch/batch-step":12,"../../engine/job":34,"../../engine/job-status":33,"../../engine/simple-job":35,"../../engine/step":38,"./recompute-job-parameters":8}],10:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.SensitivityAnalysisJobParameters=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-utils"),c=e("../../engine/job-parameters"),l=e("../../engine/job-parameter-definition");n.SensitivityAnalysisJobParameters=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),u(t,[{key:"initDefinitions",value:function(){this.definitions.push(new l.JobParameterDefinition("id",l.PARAMETER_TYPE.STRING,1,1,(!0))),this.definitions.push(new l.JobParameterDefinition("ruleName",l.PARAMETER_TYPE.STRING)),this.definitions.push(new l.JobParameterDefinition("variables",[new l.JobParameterDefinition("name",l.PARAMETER_TYPE.STRING),new l.JobParameterDefinition("min",l.PARAMETER_TYPE.NUMBER),new l.JobParameterDefinition("max",l.PARAMETER_TYPE.NUMBER),new l.JobParameterDefinition("length",l.PARAMETER_TYPE.INTEGER).set("singleValueValidator",function(e){return e>=0})],1,1/0,(!1),function(e){return e.min<=e.max},function(e){return s.Utils.isUnique(e,function(e){return e.name})}))}},{key:"initDefaultValues",value:function(){this.values={id:s.Utils.guid(),attachDataModel:!0}}}]),t}(c.JobParameters)},{"../../engine/job-parameter-definition":29,"../../engine/job-parameters":30,"sd-utils":"sd-utils"}],11:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.SensitivityAnalysisJob=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o);
}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("../../engine/simple-job"),c=e("../../engine/step"),l=e("../../engine/job-status"),f=e("../../../validation/tree-validator"),p=e("./sensitivity-analysis-job-parameters"),d=e("sd-utils"),b=e("../../engine/batch/batch-step"),y=e("sd-expression-engine"),h=e("../../../policies/policies-collector"),v=(n.SensitivityAnalysisJob=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"sensitivity-analysis",e));return a.addStep(new v(e)),a.addStep(new m(e)),a.addStep(new g(e,n,r)),a}return r(t,e),u(t,[{key:"createJobParameters",value:function(e){return new p.SensitivityAnalysisJobParameters(e)}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return 1===e.getRoots().length}}}},{key:"getProgress",value:function(e){if(l.JOB_STATUS.COMPLETED===e.status)return 100;if(!e.stepExecutions.length)return 0;if(1==e.stepExecutions.length)return l.JOB_STATUS.COMPLETED===e.stepExecutions[0].status?1:0;if(2==e.stepExecutions.length)return l.JOB_STATUS.COMPLETED===e.stepExecutions[0].status?2:1;var t=e.stepExecutions[2];return l.JOB_STATUS.COMPLETED===t.status?100:Math.max(2,Math.round(.98*this.steps[2].getProgress(t)))}}]),t}(s.SimpleJob),function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"prepare_variables",e))}return r(t,e),u(t,[{key:"doExecute",value:function(e){var t=this,n=e.getJobParameters(),o=n.value("variables"),i=[];return o.forEach(function(e){i.push(t.sequence(e.min,e.max,e.length))}),i=d.Utils.cartesianProductOf(i),e.executionContext.put("variableValues",i),e.getJobExecutionContext().put("variableValues",i),e.exitStatus=l.JOB_STATUS.COMPLETED,e}},{key:"sequence",value:function(e,t,n){for(var o=t-e,i=o/(n-1),r=[e],a=e,u=0;u<n-2;u++)a+=i,r.push(a);return r.push(t),r}}]),t}(c.Step)),m=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"init_policies",e))}return r(t,e),u(t,[{key:"doExecute",value:function(e){var t=e.getData(),n=t.getRoots()[0],o=new h.PoliciesCollector(n);return console.log("policies",o.policies),e.executionContext.put("policies",o.policies),e.exitStatus=l.JOB_STATUS.COMPLETED,e}}]),t}(c.Step),g=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"calculate_step",e,5));return a.expressionsEvaluator=n,a.objectiveRulesManager=r,a.treeValidator=new f.TreeValidator,a}return r(t,e),u(t,[{key:"init",value:function(e){var t=e.getJobParameters(),n=t.value("ruleName");this.objectiveRulesManager.setCurrentRuleByName(n);var o=e.executionContext.get("variableValues"),i=t.value("variables").map(function(e){return e.name});if(e.executionContext.put("variableNames",i),!e.jobExecution.getResult()){var r=["policy"];i.forEach(function(e){return r.push(e)}),r.push("payoff"),e.jobExecution.setResult({headers:r,rows:[]})}return o.length}},{key:"readNextChunk",value:function(e,t,n){var o=e.executionContext.get("variableValues");return o.slice(t,t+n)}},{key:"processItem",value:function(e,t){var n=e.getJobParameters(),o=n.value("ruleName"),i=e.getData(),r=i.getRoots()[0],a=e.executionContext.get("variableNames");this.expressionsEvaluator.evalGlobalCode(i),a.forEach(function(e,n){i.expressionScope[e]=t[n]}),this.expressionsEvaluator.evalExpressionsForNode(i,r);var u=this.treeValidator.validate(i.getAllNodesInSubtree(r));if(!u.isValid())return null;this.objectiveRulesManager.recomputeTree(r,!1);var s=new h.PoliciesCollector(r,o).policies,c={data:i.getDTO(),policies:s,variables:t,payoff:r.computedValue(o,"payoff")};return c}},{key:"writeChunk",value:function(e,t){var n=e.jobExecution.getResult();t.forEach(function(e){e&&e.policies.forEach(function(t){var o=[t.key];e.variables.forEach(function(e){return o.push(e)}),o.push(y.ExpressionEngine.toFloat(e.payoff)),n.rows.push({cells:o,data:e.data,policy:t})})})}}]),t}(b.BatchStep)},{"../../../policies/policies-collector":56,"../../../validation/tree-validator":60,"../../engine/batch/batch-step":12,"../../engine/job-status":33,"../../engine/simple-job":35,"../../engine/step":38,"./sensitivity-analysis-job-parameters":10,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],12:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.BatchStep=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("../job-status"),c=e("sd-utils"),l=e("../step"),f=e("../exceptions/job-interrupted-exception"),p=n.BatchStep=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return a.chunkSize=r,a}return r(t,e),u(t,[{key:"init",value:function(e){throw"BatchStep.init function not implemented for step: "+this.name}},{key:"readNextChunk",value:function(e,t,n){throw"BatchStep.readNextChunk function not implemented for step: "+this.name}},{key:"processItem",value:function(e,t){throw"BatchStep.processItem function not implemented for step: "+this.name}},{key:"writeChunk",value:function(e,t){}},{key:"postProcess",value:function(e){}},{key:"setTotalItemCount",value:function(e,n){e.executionContext.put(t.TOTAL_ITEM_COUNT_PROP,n)}},{key:"getTotalItemCount",value:function(e){return e.executionContext.get(t.TOTAL_ITEM_COUNT_PROP)}},{key:"setCurrentItemCount",value:function(e,n){e.executionContext.put(t.CURRENT_ITEM_COUNT_PROP,n)}},{key:"getCurrentItemCount",value:function(e){return e.executionContext.get(t.CURRENT_ITEM_COUNT_PROP)||0}},{key:"doExecute",value:function(e){var t=this;return Promise.resolve().then(function(){return t.init(e)})["catch"](function(e){throw c.log.error("Failed to initialize batch step: "+t.name,e),e}).then(function(n){return Promise.resolve().then(function(){return t.setCurrentItemCount(e,t.getCurrentItemCount(e)),t.setTotalItemCount(e,n),t.handleNextChunk(e)})["catch"](function(e){throw e instanceof f.JobInterruptedException||c.log.error("Failed to handle batch step: "+t.name,e),e})}).then(function(){return Promise.resolve().then(function(){return t.postProcess(e)})["catch"](function(e){throw c.log.error("Failed to postProcess batch step: "+t.name,e),e})}).then(function(){return e.exitStatus=s.JOB_STATUS.COMPLETED,e})}},{key:"handleNextChunk",value:function(e){var t=this,n=this.getCurrentItemCount(e),o=this.getTotalItemCount(e),i=Math.min(this.chunkSize,o-n);return n>=o?e:this.checkJobExecutionFlags(e).then(function(){if(e.terminateOnly)throw new f.JobInterruptedException("JobExecution interrupted.");return e}).then(function(){return Promise.resolve().then(function(){return t.readNextChunk(e,n,i)})["catch"](function(e){throw c.log.error("Failed to read chunk ("+n+","+i+") in batch step: "+t.name,e),e})}).then(function(o){return Promise.resolve().then(function(){return t.processChunk(e,o)})["catch"](function(e){throw c.log.error("Failed to process chunk ("+n+","+i+") in batch step: "+t.name,e),e})}).then(function(o){return Promise.resolve().then(function(){return t.writeChunk(e,o)})["catch"](function(e){throw c.log.error("Failed to write chunk ("+n+","+i+") in batch step: "+t.name,e),e})}).then(function(o){return n+=i,t.setCurrentItemCount(e,n),t.updateJobProgress(e).then(function(){return t.handleNextChunk(e)})})}},{key:"processChunk",value:function(e,t){var n=this;return t.map(function(t){return n.processItem(e,t)})}},{key:"getProgress",value:function(e){return Math.round(100*this.getCurrentItemCount(e)/this.getTotalItemCount(e))}},{key:"updateJobProgress",value:function(e){var t=this.jobRepository.getJobByName(e.jobExecution.jobInstance.jobName).getProgress(e.jobExecution);return this.jobRepository.updateJobExecutionProgress(e.jobExecution.id,t)}},{key:"checkJobExecutionFlags",value:function(e){return this.jobRepository.getJobByName(e.jobExecution.jobInstance.jobName).checkExecutionFlags(e.jobExecution)}}]),t}(l.Step);p.CURRENT_ITEM_COUNT_PROP="batch_step_current_item_count",p.TOTAL_ITEM_COUNT_PROP="batch_step_total_item_count"},{"../exceptions/job-interrupted-exception":18,"../job-status":33,"../step":38,"sd-utils":"sd-utils"}],13:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":u(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":u(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e){function t(){var t=Reflect.construct(e,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0});n.ExtendableError=function(e){function t(e){o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.name=n.constructor.name,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(n,n.constructor):n.stack=new Error(e).stack,n}return r(t,e),t}(a(Error))},{}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./extendable-error");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var i=e("./job-data-invalid-exception");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var r=e("./job-execution-already-running-exception");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var a=e("./job-instance-already-complete-exception");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}})});var u=e("./job-interrupted-exception");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}})});var s=e("./job-parameters-invalid-exception");Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return s[e]}})});var c=e("./job-restart-exception");Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return c[e]}})})},{"./extendable-error":13,"./job-data-invalid-exception":15,"./job-execution-already-running-exception":16,"./job-instance-already-complete-exception":17,"./job-interrupted-exception":18,"./job-parameters-invalid-exception":19,"./job-restart-exception":20}],15:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobDataInvalidException=void 0;var u=e("./extendable-error");n.JobDataInvalidException=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),t}(u.ExtendableError)},{"./extendable-error":13}],16:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobExecutionAlreadyRunningException=void 0;var u=e("./extendable-error");n.JobExecutionAlreadyRunningException=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),t}(u.ExtendableError)},{"./extendable-error":13}],17:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobInstanceAlreadyCompleteException=void 0;var u=e("./extendable-error");n.JobInstanceAlreadyCompleteException=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),t}(u.ExtendableError)},{"./extendable-error":13}],18:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobInterruptedException=void 0;var u=e("./extendable-error");n.JobInterruptedException=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),t}(u.ExtendableError)},{"./extendable-error":13}],19:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobParametersInvalidException=void 0;var u=e("./extendable-error");n.JobParametersInvalidException=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),t}(u.ExtendableError)},{"./extendable-error":13}],20:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobRestartException=void 0;var u=e("./extendable-error");n.JobRestartException=function(e){function t(){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),t}(u.ExtendableError)},{"./extendable-error":13}],21:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ExecutionContext=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-utils");n.ExecutionContext=function(){function e(t){o(this,e),this.dirty=!1,this.context={},t&&(this.context=r.Utils.clone(t))}return i(e,[{key:"put",value:function(e,t){var n=this.context[e];if(null!=t){this.context[e]=t;this.dirty=null==n||null!=n&&n!=t}else delete this.context[e],this.dirty=null!=n}},{key:"get",value:function(e){return this.context[e]}},{key:"containsKey",value:function(e){return this.context.hasOwnProperty(e)}},{key:"remove",value:function(e){delete this.context[e]}},{key:"setData",value:function(e){return this.put("data",e)}},{key:"getData",value:function(){return this.get("data")}},{key:"getDTO",value:function(){var e=r.Utils.cloneDeep(this),t=this.getData();return t&&(t=t.getDTO(),e.context.data=t),e}}]),e}()},{"sd-utils":"sd-utils"}],22:[function(e,t,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.exceptions=void 0;var i=e("./execution-context");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var r=e("./job");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var a=e("./job-execution");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}})});var u=e("./job-execution-flag");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}})});var s=e("./job-execution-listener");Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return s[e]}})});var c=e("./job-instance");Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return c[e]}})});var l=e("./job-key-generator");Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return l[e]}})});var f=e("./job-launcher");Object.keys(f).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return f[e]}})});var p=e("./job-parameter-definition");Object.keys(p).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return p[e]}})});var d=e("./job-parameters");Object.keys(d).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return d[e]}})});var b=e("./job-status");Object.keys(b).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return b[e]}})});var y=e("./simple-job");Object.keys(y).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return y[e]}})});var h=e("./step");Object.keys(h).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return h[e]}})});var v=e("./step-execution");Object.keys(v).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return v[e]}})});var m=e("./step-execution-listener");Object.keys(m).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return m[e]}})});var g=e("./exceptions"),E=o(g);n.exceptions=E},{"./exceptions":14,"./execution-context":21,"./job":34,"./job-execution":25,"./job-execution-flag":23,"./job-execution-listener":24,"./job-instance":26,"./job-key-generator":27,"./job-launcher":28,"./job-parameter-definition":29,"./job-parameters":30,"./job-status":33,"./simple-job":35,"./step":38,"./step-execution":37,"./step-execution-listener":36}],23:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.JOB_EXECUTION_FLAG={STOP:"STOP"}},{}],24:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();n.JobExecutionListener=function(){function e(){o(this,e)}return i(e,[{key:"beforeJob",value:function(e){}},{key:"afterJob",value:function(e){}}]),e}()},{}],25:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.JobExecution=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("./job-status"),a=e("./step-execution"),u=e("sd-utils"),s=e("./execution-context");n.JobExecution=function(){function e(t,n,i){o(this,e),this.stepExecutions=[],this.status=r.JOB_STATUS.STARTING,this.exitStatus=r.JOB_STATUS.UNKNOWN,this.executionContext=new s.ExecutionContext,this.startTime=null,this.createTime=new Date,this.endTime=null,this.lastUpdated=null,this.failureExceptions=[],null===i||void 0===i?this.id=u.Utils.guid():this.id=i,this.id=u.Utils.guid(),this.jobInstance=t,this.jobParameters=n}return i(e,[{key:"createStepExecution",value:function(e){var t=new a.StepExecution(e,this);return this.stepExecutions.push(t),t}},{key:"isRunning",value:function(){return!this.endTime}},{key:"isStopping",value:function(){return this.status===r.JOB_STATUS.STOPPING}},{key:"stop",value:function(){this.stepExecutions.forEach(function(e){e.terminateOnly=!0}),this.status=r.JOB_STATUS.STOPPING}},{key:"getData",value:function(){return this.executionContext.getData()}},{key:"setResult",value:function(e){return this.executionContext.put("result",e)}},{key:"getResult",value:function(){return this.executionContext.get("result")}},{key:"getDTO",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=u.Utils.cloneDeepWith;return t||(n=u.Utils.cloneWith),u.Utils.assign({},n(this,function(n,o,i,r){return e.indexOf(o)>-1?null:["jobParameters","executionContext"].indexOf(o)>-1?n.getDTO():n instanceof Error?u.Utils.getErrorDTO(n):n instanceof a.StepExecution?n.getDTO(["jobExecution"],t):void 0}))}}]),e}()},{"./execution-context":21,"./job-status":33,"./step-execution":37,"sd-utils":"sd-utils"}],26:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});n.JobInstance=function i(e,t){o(this,i),this.id=e,this.jobName=t}},{}],27:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();n.JobKeyGenerator=function(){function e(){o(this,e)}return i(e,null,[{key:"generateKey",value:function(e){var t="";return e.definitions.forEach(function(n,o){n.identifying&&(t+=n.name+"="+e.values[n.name]+";")}),t}}]),e}()},{}],28:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.JobLauncher=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("./exceptions/job-restart-exception"),a=e("./job-status"),u=e("sd-utils"),s=e("./exceptions/job-parameters-invalid-exception"),c=e("./exceptions/job-data-invalid-exception");n.JobLauncher=function(){function e(t,n,i){o(this,e),this.jobRepository=t,this.jobWorker=n,this.dataModelSerializer=i}return i(e,[{key:"run",value:function(e,t,n){var o,i,a=this,s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return Promise.resolve().then(function(){if(o=u.Utils.isString(e)?a.jobRepository.getJobByName(e):e,!o)throw new r.JobRestartException("No such job: "+e);return i=o.createJobParameters(t),a.validate(o,i,n)}).then(function(e){return a.jobRepository.createJobExecution(o.name,i,n).then(function(e){if(a.jobWorker)return u.log.debug("Job: ["+o.name+"] execution ["+e.id+"] delegated to worker"),a.jobWorker.executeJob(e.id),e;var t=a._execute(o,e);return s?e:t})})}},{key:"validate",value:function(e,t,n){return this.jobRepository.getLastJobExecution(e.name,t).then(function(o){if(null!=o){if(!e.isRestartable)throw new r.JobRestartException("JobInstance already exists and is not restartable");o.stepExecutions.forEach(function(e){if(e.status==a.JOB_STATUS.UNKNOWN)throw new r.JobRestartException("Step ["+e.stepName+"] is of status UNKNOWN")})}if(e.jobParametersValidator&&!e.jobParametersValidator.validate(t))throw new s.JobParametersInvalidException("Invalid job parameters in jobLauncher.run for job: "+e.name);if(e.jobDataValidator&&!e.jobDataValidator.validate(n))throw new c.JobDataInvalidException("Invalid job data in jobLauncher.run for job: "+e.name);return!0})}},{key:"execute",value:function(e){var t=this;Promise.resolve().then(function(){return u.Utils.isString(e)?t.jobRepository.getJobExecutionById(e):e}).then(function(n){if(!n)throw new r.JobRestartException("JobExecution ["+e+"] is not found");if(n.status!==a.JOB_STATUS.STARTING)throw new r.JobRestartException("JobExecution ["+n.id+"] already started");var o=n.jobInstance.jobName,i=t.jobRepository.getJobByName(o);if(!i)throw new r.JobRestartException("No such job: "+o);return t._execute(i,n)})}},{key:"_execute",value:function(e,t){var n=e.name;return u.log.info("Job: ["+n+"] launched with the following parameters: ["+t.jobParameters+"]",t.getData()),e.execute(t).then(function(e){return u.log.info("Job: ["+n+"] completed with the following parameters: ["+e.jobParameters+"] and the following status: ["+e.status+"]"),e})["catch"](function(e){throw u.log.error("Job: ["+n+"] failed unexpectedly and fatally with the following parameters: ["+t.jobParameters+"]",e),e})}}]),e}()},{"./exceptions/job-data-invalid-exception":15,"./exceptions/job-parameters-invalid-exception":19,"./exceptions/job-restart-exception":20,"./job-status":33,"sd-utils":"sd-utils"}],29:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.JobParameterDefinition=n.PARAMETER_TYPE=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-utils"),a=n.PARAMETER_TYPE={STRING:"STRING",DATE:"DATE",INTEGER:"INTEGER",NUMBER:"FLOAT",BOOLEAN:"BOOLEAN",NUMBER_EXPRESSION:"NUMBER_EXPRESSION",COMPOSITE:"COMPOSITE"};n.JobParameterDefinition=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;o(this,e),this.nestedParameters=[],this.name=t,r.Utils.isArray(n)?(this.type=a.COMPOSITE,this.nestedParameters=n):this.type=n,this.validator=l,
this.singleValueValidator=c,this.identifying=s,this.minOccurs=i,this.maxOccurs=u}return i(e,[{key:"set",value:function(e,t){return this[e]=t,this}},{key:"validate",value:function(e){var t=r.Utils.isArray(e);return!(this.maxOccurs>1&&!t)&&(t?!(e.length<this.minOccurs||e.length>this.maxOccurs)&&(!!e.every(this.validateSingleValue,this)&&(!this.validator||this.validator(e))):this.validateSingleValue(e))}},{key:"validateSingleValue",value:function(e){if((null===e||void 0===e)&&this.minOccurs>0)return!1;if(a.STRING===this.type&&!r.Utils.isString(e))return!1;if(a.DATE===this.type&&!r.Utils.isDate(e))return!1;if(a.INTEGER===this.type&&!r.Utils.isInt(e))return!1;if(a.NUMBER===this.type&&!r.Utils.isNumber(e))return!1;if(a.COMPOSITE===this.type){if(!r.Utils.isObject(e))return!1;if(!this.nestedParameters.every(function(t,n){return t.validate(e[t.name])}))return!1}return!this.singleValueValidator||this.singleValueValidator(e)}}]),e}()},{"sd-utils":"sd-utils"}],30:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.JobParameters=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=(e("./job-parameter-definition"),e("sd-utils")),a=function(){function e(t){o(this,e),this.definitions=[],this.values={},this.initDefinitions(),this.initDefaultValues(),t&&r.Utils.deepExtend(this.values,t)}return i(e,[{key:"initDefinitions",value:function(){}},{key:"initDefaultValues",value:function(){}},{key:"validate",value:function(){var e=this;return this.definitions.every(function(t,n){return t.validate(e.values[t.name])})}},{key:"value",value:function(e,t){return 1===arguments.length?r.Utils.get(this.values,e,null):(r.Utils.set(this.values,e,t),t)}},{key:"toString",value:function(){var e=this,t="JobParameters[";return this.definitions.forEach(function(n,o){var i=e.values[n.name];t+=n.name+"="+i+";"}),t+="]"}},{key:"getDTO",value:function(){return{values:this.values}}}]),e}();n.JobParameters=a},{"./job-parameter-definition":29,"sd-utils":"sd-utils"}],31:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":u(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":u(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.IdbJobRepository=void 0;var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),c=e("./job-repository"),l=e("idb"),f=o(l),p=e("sd-utils"),d=e("../job-execution"),b=e("../job-instance"),y=e("../step-execution"),h=e("../execution-context"),v=e("sd-model"),m=(n.IdbJobRepository=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sd-job-repository",o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];i(this,t);var a=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.dbName=n,a.expressionsReviver=e,o?a.deleteDB().then(function(){a.initDB()}):a.initDB(),a.jobInstanceDao=new m("job-instances",a.dbPromise),a.jobExecutionDao=new m("job-executions",a.dbPromise),a.jobExecutionProgressDao=new m("job-execution-progress",a.dbPromise),a.jobExecutionFlagDao=new m("job-execution-flags",a.dbPromise),a.stepExecutionDao=new m("step-executions",a.dbPromise),a}return a(t,e),s(t,[{key:"initDB",value:function(){this.dbPromise=f["default"].open(this.dbName,1,function(e){e.createObjectStore("job-instances");var t=e.createObjectStore("job-executions");t.createIndex("jobInstanceId","jobInstance.id",{unique:!1}),t.createIndex("createTime","createTime",{unique:!1}),t.createIndex("status","status",{unique:!1}),e.createObjectStore("job-execution-progress"),e.createObjectStore("job-execution-flags");var n=e.createObjectStore("step-executions");n.createIndex("jobExecutionId","jobExecution.id",{unique:!1})})}},{key:"deleteDB",value:function(){var e=this;return Promise.resolve().then(function(t){return f["default"]["delete"](e.dbName)})}},{key:"getJobInstance",value:function(e,t){var n=this,o=this.generateJobInstanceKey(e,t);return this.jobInstanceDao.get(o).then(function(e){return e?n.reviveJobInstance(e):e})}},{key:"saveJobInstance",value:function(e,t){var n=this.generateJobInstanceKey(e.jobName,t);return this.jobInstanceDao.set(n,e).then(function(t){return e})}},{key:"saveJobExecution",value:function(e){var t=e.getDTO();return this.jobExecutionDao.set(e.id,t).then(function(t){return e})}},{key:"updateJobExecutionProgress",value:function(e,t){return this.jobExecutionProgressDao.set(e,t)}},{key:"getJobExecutionProgress",value:function(e){return this.jobExecutionProgressDao.get(e)}},{key:"saveJobExecutionFlag",value:function(e,t){return this.jobExecutionFlagDao.set(e,t)}},{key:"getJobExecutionFlag",value:function(e){return this.jobExecutionFlagDao.get(e)}},{key:"saveStepExecution",value:function(e){var t=e.getDTO();return this.jobExecutionDao.set(e.id,t).then(function(t){return e})}},{key:"getJobExecutionById",value:function(e){var t=this;return this.jobExecutionDao.get(e).then(function(e){return e?t.reviveJobExecution(e):e})}},{key:"findJobExecutions",value:function(e){var t=this;return this.jobExecutionDao.getAllByIndex("jobInstanceId",e.id).then(function(e){return e.sort(function(e,t){return e.createTime.getTime()-t.createTime.getTime()}).map(t.reviveJobExecution,t)})}},{key:"reviveJobInstance",value:function(e){return new b.JobInstance(e.id,e.jobName)}},{key:"reviveExecutionContext",value:function(e){var t=new h.ExecutionContext;t.context=e.context;var n=t.getData();if(n){var o=new v.DataModel;o.loadFromDTO(n,this.expressionsReviver),t.setData(o)}return t}},{key:"reviveJobExecution",value:function(e){var t=this,n=this.getJobByName(e.jobInstance.jobName),o=this.reviveJobInstance(e.jobInstance),i=n.createJobParameters(e.jobParameters.values),r=new d.JobExecution(o,i,e.id),a=this.reviveExecutionContext(e.executionContext);return p.Utils.mergeWith(r,e,function(e,n,u,s,c,l){return"jobInstance"===u?o:"executionContext"===u?a:"jobParameters"===u?i:"jobExecution"===u?r:"stepExecutions"===u?n.map(function(e){return t.reviveStepExecution(e,r)}):void 0})}},{key:"reviveStepExecution",value:function(e,t){var n=new y.StepExecution(e.stepName,t,e.id),o=this.reviveExecutionContext(e.executionContext);return p.Utils.mergeWith(n,e,function(e,n,i,r,a,u){return"jobExecution"===i?t:"executionContext"===i?o:void 0})}}]),t}(c.JobRepository),function(){function e(t,n){i(this,e),this.name=t,this.dbPromise=n}return s(e,[{key:"get",value:function(e){var t=this;return this.dbPromise.then(function(n){return n.transaction(t.name).objectStore(t.name).get(e)})}},{key:"getAllByIndex",value:function(e,t){var n=this;return this.dbPromise.then(function(o){return o.transaction(n.name).objectStore(n.name).index(e).getAll(t)})}},{key:"getByIndex",value:function(e,t){var n=this;return this.dbPromise.then(function(o){return o.transaction(n.name).objectStore(n.name).index(e).get(t)})}},{key:"set",value:function(e,t){var n=this;return this.dbPromise.then(function(o){var i=o.transaction(n.name,"readwrite");return i.objectStore(n.name).put(t,e),i.complete})}},{key:"remove",value:function(e){var t=this;return this.dbPromise.then(function(n){var o=n.transaction(t.name,"readwrite");return o.objectStore(t.name)["delete"](e),o.complete})}},{key:"clear",value:function(){var e=this;return this.dbPromise.then(function(t){var n=t.transaction(e.name,"readwrite");return n.objectStore(e.name).clear(),n.complete})}},{key:"keys",value:function(){var e=this;return this.dbPromise.then(function(t){var n=t.transaction(e.name),o=[],i=n.objectStore(e.name);return(i.iterateKeyCursor||i.iterateCursor).call(i,function(e){e&&(o.push(e.key),e["continue"]())}),n.complete.then(function(){return o})})}}]),e}())},{"../execution-context":21,"../job-execution":25,"../job-instance":26,"../step-execution":37,"./job-repository":32,idb:1,"sd-model":"sd-model","sd-utils":"sd-utils"}],32:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.JobRepository=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("../job-key-generator"),a=e("../job-instance"),u=e("sd-utils"),s=e("../job-execution"),c=e("../exceptions/job-execution-already-running-exception"),l=e("../job-status"),f=e("../exceptions/job-instance-already-complete-exception"),p=e("../execution-context"),d=e("../step-execution");n.JobRepository=function(){function e(){o(this,e),this.jobByName={}}return i(e,[{key:"registerJob",value:function(e){this.jobByName[e.name]=e}},{key:"getJobByName",value:function(e){return this.jobByName[e]}},{key:"getJobInstance",value:function(e,t){throw"JobRepository getJobInstance function not implemented!"}},{key:"saveJobInstance",value:function(e,t){throw"JobRepository.saveJobInstance function not implemented!"}},{key:"getJobExecutionById",value:function(e){throw"JobRepository.getJobExecutionById function not implemented!"}},{key:"saveJobExecution",value:function(e){throw"JobRepository.saveJobInstance function not implemented!"}},{key:"updateJobExecutionProgress",value:function(e,t){throw"JobRepository.saveJobInstance function not implemented!"}},{key:"getJobExecutionProgress",value:function(e){throw"JobRepository.getJobExecutionProgress function not implemented!"}},{key:"saveJobExecutionFlag",value:function(e,t){throw"JobRepository.saveJobExecutionFlag function not implemented!"}},{key:"getJobExecutionFlag",value:function(e){throw"JobRepository.getJobExecutionFlag function not implemented!"}},{key:"saveStepExecution",value:function(e){throw"JobRepository.saveStepExecution function not implemented!"}},{key:"findJobExecutions",value:function(e){throw"JobRepository.findJobExecutions function not implemented!"}},{key:"createJobInstance",value:function(e,t){var n=new a.JobInstance(u.Utils.guid(),e);return this.saveJobInstance(n,t)}},{key:"isJobInstanceExists",value:function(e,t){return this.getJobInstance(e,t).then(function(e){return!!e})["catch"](function(e){return!1})}},{key:"generateJobInstanceKey",value:function(e,t){return e+"|"+r.JobKeyGenerator.generateKey(t)}},{key:"createJobExecution",value:function(e,t,n){var o=this;return this.getJobInstance(e,t).then(function(i){if(null!=i)return o.findJobExecutions(i).then(function(e){e.forEach(function(e){if(e.isRunning())throw new c.JobExecutionAlreadyRunningException("A job execution for this job is already running: "+i.jobName);if(e.status==l.JOB_STATUS.COMPLETED||e.status==l.JOB_STATUS.ABANDONED)throw new f.JobInstanceAlreadyCompleteException("A job instance already exists and is complete for parameters="+t+".  If you want to run this job again, change the parameters.")});var n=e[e.length-1].executionContext;return[i,n]});i=o.createJobInstance(e,t);var r=new p.ExecutionContext;return r.setData(n),Promise.all([i,r])}).then(function(e){var n=new s.JobExecution(e[0],t);return n.executionContext=e[1],n.lastUpdated=new Date,o.saveJobExecution(n)})["catch"](function(e){throw e})}},{key:"getLastJobExecution",value:function(e,t){var n=this;return this.getJobInstance(e,t).then(function(e){return e?n.getLastJobExecutionByInstance(e):null})}},{key:"getLastJobExecutionByInstance",value:function(e){return this.findJobExecutions(e).then(function(e){return e[e.length-1]})}},{key:"getLastStepExecution",value:function(e,t){return this.findJobExecutions(e).then(function(e){var n=[];e.forEach(function(e){return e.stepExecutions.filter(function(e){return e.stepName===t}).forEach(function(e){return n.push(e)})});var o=null;return n.forEach(function(e){(null==o||o.startTime.getTime()<e.startTime.getTime())&&(o=e)}),o})}},{key:"addStepExecution",value:function(e){return e.lastUpdated=new Date,this.saveStepExecution(e)}},{key:"update",value:function(e){if(e.lastUpdated=new Date,e instanceof s.JobExecution)return this.saveJobExecution(e);if(e instanceof d.StepExecution)return this.saveStepExecution(e);throw"Object not updatable: "+e}},{key:"remove",value:function(){}},{key:"reviveJobInstance",value:function(e){return e}},{key:"reviveExecutionContext",value:function(e){return e}},{key:"reviveJobExecution",value:function(e){return e}},{key:"reviveStepExecution",value:function(e,t){return e}}]),e}()},{"../exceptions/job-execution-already-running-exception":16,"../exceptions/job-instance-already-complete-exception":17,"../execution-context":21,"../job-execution":25,"../job-instance":26,"../job-key-generator":27,"../job-status":33,"../step-execution":37,"sd-utils":"sd-utils"}],33:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.JOB_STATUS={COMPLETED:"COMPLETED",STARTING:"STARTING",STARTED:"STARTED",STOPPING:"STOPPING",STOPPED:"STOPPED",FAILED:"FAILED",UNKNOWN:"UNKNOWN",ABANDONED:"ABANDONED",EXECUTING:"EXECUTING"}},{}],34:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.Job=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-utils"),a=e("./job-status"),u=e("./exceptions/job-interrupted-exception"),s=e("./exceptions/job-parameters-invalid-exception"),c=e("./exceptions/job-data-invalid-exception"),l=e("./job-execution-flag");n.Job=function(){function e(t,n){o(this,e),this.steps=[],this.isRestartable=!0,this.executionListeners=[],this.name=t,this.jobParametersValidator=this.getJobParametersValidator(),this.jobDataValidator=this.getJobDataValidator(),this.jobRepository=n}return i(e,[{key:"setJobRepository",value:function(e){this.jobRepository=e}},{key:"execute",value:function(e){var t=this;return r.log.debug("Job execution starting: ",e),this.checkExecutionFlags(e).then(function(e){if(e.status===a.JOB_STATUS.STOPPING)return e.status=a.JOB_STATUS.STOPPED,e.exitStatus=a.JOB_STATUS.COMPLETED,r.log.debug("Job execution was stopped: "+e),e;if(t.jobParametersValidator&&!t.jobParametersValidator.validate(e.jobParameters))throw new s.JobParametersInvalidException("Invalid job parameters in job execute");if(t.jobDataValidator&&!t.jobDataValidator.validate(e.getData()))throw new c.JobDataInvalidException("Invalid job data in job execute");return e.startTime=new Date,Promise.all([t.updateStatus(e,a.JOB_STATUS.STARTED),t.updateProgress(e)]).then(function(n){return e=n[0],t.executionListeners.forEach(function(t){return t.beforeJob(e)}),t.doExecute(e)})}).then(function(e){return r.log.debug("Job execution complete: ",e),e})["catch"](function(t){return t instanceof u.JobInterruptedException?(r.log.info("Encountered interruption executing job",t),e.status=a.JOB_STATUS.STOPPED,e.exitStatus=a.JOB_STATUS.STOPPED):(r.log.error("Encountered fatal error executing job",t),e.status=a.JOB_STATUS.FAILED,e.exitStatus=a.JOB_STATUS.FAILED),e.failureExceptions.push(t),e}).then(function(e){e.endTime=new Date;try{t.executionListeners.forEach(function(t){return t.afterJob(e)})}catch(n){r.log.error("Exception encountered in afterStep callback",n)}return Promise.all([t.jobRepository.update(e),t.updateProgress(e)]).then(function(e){return e[0]})})}},{key:"updateStatus",value:function(e,t){return e.status=t,this.jobRepository.update(e)}},{key:"updateProgress",value:function(e){return this.jobRepository.updateJobExecutionProgress(e.id,this.getProgress(e))}},{key:"doExecute",value:function(e){throw"doExecute function not implemented for job: "+this.name}},{key:"getJobParametersValidator",value:function(){return{validate:function(e){return e.validate()}}}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return!0}}}},{key:"addStep",value:function(e){this.steps.push(e)}},{key:"createJobParameters",value:function(e){throw"createJobParameters function not implemented for job: "+this.name}},{key:"getProgress",value:function(e){return e.status===a.JOB_STATUS.COMPLETED?100:0}},{key:"registerExecutionListener",value:function(e){this.executionListeners.push(e)}},{key:"checkExecutionFlags",value:function(e){return this.jobRepository.getJobExecutionFlag(e.id).then(function(t){return l.JOB_EXECUTION_FLAG.STOP===t&&e.stop(),e})}}]),e}()},{"./exceptions/job-data-invalid-exception":15,"./exceptions/job-interrupted-exception":18,"./exceptions/job-parameters-invalid-exception":19,"./job-execution-flag":23,"./job-status":33,"sd-utils":"sd-utils"}],35:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.SimpleJob=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=function h(e,t,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:h(i,t,n)}if("value"in o)return o.value;var r=o.get;if(void 0!==r)return r.call(n)},c=e("sd-utils"),l=e("./job-status"),f=e("./job"),p=e("./execution-context"),d=e("./step"),b=e("./exceptions/job-interrupted-exception"),y=e("./exceptions/job-restart-exception");e("./job-execution-flag"),n.SimpleJob=function(e){function t(e,n){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return r(t,e),u(t,[{key:"getStep",value:function(e){return c.Utils.find(this.steps,function(t){return t.name==e})}},{key:"doExecute",value:function(e){return this.handleNextStep(e).then(function(t){return null!=t&&(c.log.debug("Updating JobExecution status: ",t),e.status=t.status,e.exitStatus=t.exitStatus),e})}},{key:"handleNextStep",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=0;if(n&&(i=this.steps.indexOf(n)+1),i>=this.steps.length)return Promise.resolve(o);var r=this.steps[i];return this.handleStep(r,e).then(function(n){return n.status!==l.JOB_STATUS.COMPLETED?n:t.handleNextStep(e,r,n)})}},{key:"handleStep",value:function(e,t){var n=this,o=t.jobInstance;return this.checkExecutionFlags(t).then(function(t){if(t.isStopping())throw new b.JobInterruptedException("JobExecution interrupted.");return n.jobRepository.getLastStepExecution(o,e.name)}).then(function(i){n.stepExecutionPartOfExistingJobExecution(t,i)&&(c.log.info("Duplicate step detected in execution of job. step: "+e.name+" jobName: ",o.jobName),i=null);var r=i;if(!n.shouldStart(r,t,e))return r;r=t.createStepExecution(e.name);var a=null!=i&&i.status!==l.JOB_STATUS.COMPLETED;return a?(r.executionContext=i.executionContext,i.executionContext.containsKey("executed")&&r.executionContext.remove("executed")):r.executionContext=new p.ExecutionContext(t.executionContext.context),n.jobRepository.addStepExecution(r).then(function(t){return r=t,c.log.info("Executing step: ["+e.name+"]"),e.execute(r)}).then(function(){return r.executionContext.put("executed",!0),r})["catch"](function(e){return t.status=l.JOB_STATUS.FAILED,n.jobRepository.update(t).then(function(t){throw e})})}).then(function(e){return e.status!=l.JOB_STATUS.STOPPING&&e.status!=l.JOB_STATUS.STOPPED||(t.status=l.JOB_STATUS.STOPPING),n.updateProgress(t).then(function(){return e})})}},{key:"stepExecutionPartOfExistingJobExecution",value:function(e,t){return null!=t&&t.jobExecution.id==e.id}},{key:"shouldStart",value:function(e,t,n){var o;if(o=null==e?l.JOB_STATUS.STARTING:e.status,o==l.JOB_STATUS.UNKNOWN)throw new y.JobRestartException("Cannot restart step from UNKNOWN status");return o!=l.JOB_STATUS.COMPLETED||n.isRestartable}},{key:"getProgress",value:function(e){var t=e.stepExecutions.length;return l.JOB_STATUS.COMPLETED!==e.stepExecutions[e.stepExecutions.length-1].status&&t--,Math.round(100*t/this.steps.length)}},{key:"addStep",value:function(){if(1===arguments.length)return s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"addStep",this).call(this,arguments[0]);var e=new d.Step(arguments[0],this.jobRepository);return e.doExecute=arguments[1],s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"addStep",this).call(this,e)}}]),t}(f.Job)},{"./exceptions/job-interrupted-exception":18,"./exceptions/job-restart-exception":20,"./execution-context":21,"./job":34,"./job-execution-flag":23,"./job-status":33,"./step":38,"sd-utils":"sd-utils"}],36:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();n.StepExecutionListener=function(){function e(){o(this,e)}return i(e,[{key:"beforeStep",value:function(e){}},{key:"afterStep",value:function(e){}}]),e}()},{}],37:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.StepExecution=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-utils"),a=e("./execution-context"),u=e("./job-status"),s=e("./job-execution");n.StepExecution=function(){function e(t,n,i){o(this,e),this.status=u.JOB_STATUS.STARTING,this.exitStatus=u.JOB_STATUS.EXECUTING,this.executionContext=new a.ExecutionContext,this.startTime=new Date,this.endTime=null,this.lastUpdated=null,this.terminateOnly=!1,this.failureExceptions=[],null===i||void 0===i?this.id=r.Utils.guid():this.id=i,this.stepName=t,this.jobExecution=n}return i(e,[{key:"getJobParameters",value:function(){return this.jobExecution.jobParameters}},{key:"getJobExecutionContext",value:function(){return this.jobExecution.executionContext}},{key:"getData",value:function(){return this.executionContext.get("data")}},{key:"getDTO",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=r.Utils.cloneDeepWith;return t||(n=r.Utils.cloneWith),r.Utils.assign({},n(this,function(n,o,i,a){return e.indexOf(o)>-1?null:["executionContext"].indexOf(o)>-1?n.getDTO():n instanceof Error?r.Utils.getErrorDTO(n):n instanceof s.JobExecution?n.getDTO(["stepExecutions"],t):void 0}))}}]),e}()},{"./execution-context":21,"./job-execution":25,"./job-status":33,"sd-utils":"sd-utils"}],38:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.Step=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("./job-status"),a=e("sd-utils"),u=e("./exceptions/job-interrupted-exception");n.Step=function(){function e(t,n){o(this,e),this.isRestartable=!0,this.steps=[],this.executionListeners=[],this.name=t,this.jobRepository=n}return i(e,[{key:"setJobRepository",value:function(e){this.jobRepository=e}},{key:"execute",value:function(e){var t=this;a.log.debug("Executing step: name="+this.name),e.startTime=new Date,e.status=r.JOB_STATUS.STARTED;var n;return this.jobRepository.update(e).then(function(e){return n=r.JOB_STATUS.EXECUTING,t.executionListeners.forEach(function(t){return t.beforeStep(e)}),t.open(e.executionContext),t.doExecute(e)}).then(function(o){if(e=o,n=e.exitStatus,e.terminateOnly)throw new u.JobInterruptedException("JobExecution interrupted.");return e.status=r.JOB_STATUS.COMPLETED,a.log.debug("Step execution success: name="+t.name),e})["catch"](function(o){return e.status=t.determineJobStatus(o),n=e.status,e.failureExceptions.push(o),e.status==r.JOB_STATUS.STOPPED?a.log.info("Encountered interruption executing step: "+t.name+" in job: "+e.jobExecution.jobInstance.jobName,o):a.log.error("Encountered an error executing step: "+t.name+" in job: "+e.jobExecution.jobInstance.jobName,o),e}).then(function(e){try{e.exitStatus=n,t.executionListeners.forEach(function(t){return t.afterStep(e)})}catch(o){a.log.error("Exception in afterStep callback in step "+t.name+" in job: "+e.jobExecution.jobInstance.jobName,o)}return e.endTime=new Date,e.exitStatus=n,t.jobRepository.update(e)}).then(function(e){try{t.close(e.executionContext)}catch(n){a.log.error("Exception while closing step execution resources in step: "+t.name+" in job: "+e.jobExecution.jobInstance.jobName,n),e.failureExceptions.push(n)}try{t.close(e.executionContext)}catch(n){a.log.error("Exception while closing step execution resources in step: "+t.name+" in job: "+e.jobExecution.jobInstance.jobName,n),e.failureExceptions.push(n)}return a.log.debug("Step execution complete: "+e.id),e})}},{key:"determineJobStatus",value:function(e){return e instanceof u.JobInterruptedException?r.JOB_STATUS.STOPPED:r.JOB_STATUS.FAILED}},{key:"doExecute",value:function(e){}},{key:"open",value:function(e){}},{key:"close",value:function(e){}},{key:"getProgress",value:function(e){return e.status===r.JOB_STATUS.COMPLETED?100:0}}]),e}()},{"./exceptions/job-interrupted-exception":18,"./job-status":33,"sd-utils":"sd-utils"}],39:[function(e,t,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.engine=void 0;var i=e("./jobs-manager");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var r=e("./job-worker");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var a=e("./engine/index"),u=o(a);n.engine=u},{"./engine/index":22,"./job-worker":41,"./jobs-manager":42}],40:[function(e,t,n){"use strict";function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobInstanceManager=n.JobInstanceManagerConfig=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("./engine/job-execution-listener"),c=e("./engine/job-status"),l=e("./engine/job-instance"),f=e("sd-utils"),p=n.JobInstanceManagerConfig=function d(e){r(this,d),this.onJobStarted=function(){},this.onJobCompleted=function(e){},this.onJobFailed=function(e){},this.onJobStopped=function(){},this.onJobTerminated=function(){},this.onProgress=function(e){},this.updateInterval=100,e&&f.Utils.deepExtend(this,e)};n.JobInstanceManager=function(e){function t(e,n,i){r(this,t);var a=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.progress=0,a.config=new p(i),a.jobsManger=e,n instanceof l.JobInstance?(a.jobInstance=n,a.getLastJobExecution().then(function(e){a.checkProgress()})):(a.lastJobExecution=n,a.jobInstance=a.lastJobExecution.jobInstance,a.checkProgress()),a.lastJobExecution&&!a.lastJobExecution.isRunning()?(a.afterJob(a.lastJobExecution),o(a)):(e.registerJobExecutionListener(a),a)}return i(t,e),u(t,[{key:"checkProgress",value:function(){var e=this,t=this;this.lastJobExecution.isRunning()&&100!==this.progress&&this.jobsManger.getProgress(this.lastJobExecution).then(function(n){e.lastUpdateTime=new Date,n&&e.progress<n&&(e.progress=n,e.config.onProgress.call(e.config.callbacksThisArg||e,n)),setTimeout(function(){t.checkProgress()},e.config.updateInterval)})}},{key:"beforeJob",value:function(e){e.jobInstance.id===this.jobInstance.id&&(this.lastJobExecution=e,this.config.onJobStarted.call(this.config.callbacksThisArg||this))}},{key:"afterJob",value:function(e){e.jobInstance.id===this.jobInstance.id&&(this.lastJobExecution=e,c.JOB_STATUS.COMPLETED===e.status?(this.jobsManger.deregisterJobExecutionListener(this),this.progress=100,this.config.onProgress.call(this.config.callbacksThisArg||this,100),this.config.onJobCompleted.call(this.config.callbacksThisArg||this,e.getResult())):c.JOB_STATUS.FAILED===e.status?this.config.onJobFailed.call(this.config.callbacksThisArg||this,e.failureExceptions):c.JOB_STATUS.STOPPED===e.status&&this.config.onJobStopped.call(this.config.callbacksThisArg||this))}},{key:"getLastJobExecution",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return!this.lastJobExecution||t?this.jobsManger.jobRepository.getLastJobExecutionByInstance(this.jobInstance).then(function(t){return e.lastJobExecution=t,t}):Promise.resolve(this.lastJobExecution)}},{key:"stop",value:function(){var e=this;
return this.getLastJobExecution().then(function(){return e.jobsManger.stop(e.lastJobExecution)})}},{key:"resume",value:function(){var e=this;return this.getLastJobExecution().then(function(){return console.log(e.jobInstance.jobName,e.lastJobExecution.jobParameters.values,e.lastJobExecution.getData()),e.jobsManger.run(e.jobInstance.jobName,e.lastJobExecution.jobParameters.values,e.lastJobExecution.getData()).then(function(t){e.lastJobExecution=t,console.log(t),e.checkProgress()})["catch"](function(e){f.log.error(e)})})}},{key:"terminate",value:function(){var e=this;return this.getLastJobExecution().then(function(){return e.jobsManger.terminate(e.jobInstance).then(function(){return e.config.onJobTerminated.call(e.config.callbacksThisArg||e,e.lastJobExecution),e.jobsManger.deregisterJobExecutionListener(e),e.lastJobExecution})})["catch"](function(e){f.log.error(e)})}}]),t}(s.JobExecutionListener)},{"./engine/job-execution-listener":24,"./engine/job-instance":26,"./engine/job-status":33,"sd-utils":"sd-utils"}],41:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();n.JobWorker=function(){function e(t,n,i){o(this,e),this.listeners={};var r=this;this.worker=new Worker(t),this.defaultListener=n||function(){},i&&(this.worker.onerror=i),this.worker.onmessage=function(e){if(e.data instanceof Object&&e.data.hasOwnProperty("queryMethodListener")&&e.data.hasOwnProperty("queryMethodArguments")){var t=r.listeners[e.data.queryMethodListener],n=e.data.queryMethodArguments;t.deserializer&&(n=t.deserializer(n)),t.fn.apply(t.thisArg,n)}else this.defaultListener.call(r,e.data)}}return i(e,[{key:"sendQuery",value:function(){if(arguments.length<1)throw new TypeError("JobWorker.sendQuery takes at least one argument");this.worker.postMessage({queryMethod:arguments[0],queryArguments:Array.prototype.slice.call(arguments,1)})}},{key:"runJob",value:function(e,t,n){this.sendQuery("runJob",e,t,n)}},{key:"executeJob",value:function(e){this.sendQuery("executeJob",e)}},{key:"recompute",value:function(e,t,n,o){this.sendQuery("recompute",e,t,n,o)}},{key:"postMessage",value:function(e){this.worker.postMessage(e)}},{key:"terminate",value:function(){this.worker.terminate()}},{key:"addListener",value:function(e,t,n,o){this.listeners[e]={fn:t,thisArg:n||this,deserializer:o}}},{key:"removeListener",value:function(e){delete this.listeners[e]}}]),e}()},{}],42:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.JobsManager=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-utils"),c=e("./configurations/sensitivity-analysis/sensitivity-analysis-job"),l=e("./engine/job-launcher"),f=e("./job-worker"),p=e("./engine/job-execution-listener"),d=e("./engine/job-parameters"),b=e("./engine/job-repository/idb-job-repository"),y=e("./engine/job-execution-flag"),h=e("./configurations/recompute/recompute-job"),v=e("./configurations/probabilistic-sensitivity-analysis/probabilistic-sensitivity-analysis-job");n.JobsManager=function(e){function t(e,n,r){o(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.jobExecutionListeners=[],a.afterJobExecutionPromiseResolves={},a.jobInstancesToTerminate={},a.expressionEngine=e.expressionEngine,a.expressionsEvaluator=e,a.objectiveRulesManager=n,a.jobRepository=new b.IdbJobRepository(a.expressionEngine.getJsonReviver()),a.registerJobs(),a.useWorker=!!r,a.useWorker&&a.initWorker(r),a.jobLauncher=new l.JobLauncher(a.jobRepository,a.jobWorker,function(e){return a.serializeData(e)}),a}return r(t,e),u(t,[{key:"serializeData",value:function(e){return e.serialize(!0,!1,!1,this.expressionEngine.getJsonReplacer())}},{key:"getProgress",value:function(e){var t=e;return s.Utils.isString(e)||(t=e.id),this.jobRepository.getJobExecutionProgress(t)}},{key:"run",value:function(e,t,n){var o=this,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.jobLauncher.run(e,t,n,i).then(function(e){return i||!e.isRunning()?e:new Promise(function(t,n){o.afterJobExecutionPromiseResolves[e.id]=t})})}},{key:"execute",value:function(e){return this.jobLauncher.execute(e)}},{key:"stop",value:function(e){var t=this,n=e;return s.Utils.isString(e)||(n=e.id),this.jobRepository.getJobExecutionById(n).then(function(n){return n?n.isRunning()?t.jobRepository.saveJobExecutionFlag(n.id,y.JOB_EXECUTION_FLAG.STOP).then(function(){return n}):(s.log.warn("Job Execution not running, status: "+n.status+", endTime: "+n.endTime),n):(s.log.error("Job Execution not found: "+e),null)})}},{key:"terminate",value:function(e){var t=this;return this.jobRepository.getLastJobExecutionByInstance(e).then(function(e){if(console.log("terminate",e),e&&e.isRunning())return t.jobRepository.saveJobExecutionFlag(e.id,y.JOB_EXECUTION_FLAG.STOP).then(function(){return e})}).then(function(){t.jobInstancesToTerminate[e.id]=e})}},{key:"getJobByName",value:function(e){return this.jobRepository.getJobByName(e)}},{key:"createJobParameters",value:function(e,t){var n=this.jobRepository.getJobByName(e);return n.createJobParameters(t)}},{key:"getLastJobExecution",value:function(e,t){return this.useWorker?this.jobWorker:(t instanceof d.JobParameters||(t=this.createJobParameters(t)),this.jobRepository.getLastJobExecution(e,t))}},{key:"initWorker",value:function(e){var t=this;this.jobWorker=new f.JobWorker(e);var n=function(e){return[t.jobRepository.reviveJobExecution(e[0])]};this.jobWorker.addListener("beforeJob",this.beforeJob,this,n),this.jobWorker.addListener("afterJob",this.afterJob,this,n)}},{key:"registerJobs",value:function(){this.registerJob(new c.SensitivityAnalysisJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager)),this.registerJob(new v.ProbabilisticSensitivityAnalysisJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager)),this.registerJob(new h.RecomputeJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager))}},{key:"registerJob",value:function(e){this.jobRepository.registerJob(e),e.registerExecutionListener(this)}},{key:"registerJobExecutionListener",value:function(e){this.jobExecutionListeners.push(e)}},{key:"deregisterJobExecutionListener",value:function(e){var t=this.jobExecutionListeners.indexOf(e);t>-1&&this.jobExecutionListeners.splice(t,1)}},{key:"beforeJob",value:function(e){s.log.debug("beforeJob",this.useWorker,e),this.jobExecutionListeners.forEach(function(t){return t.beforeJob(e)})}},{key:"afterJob",value:function(e){s.log.debug("afterJob",this.useWorker,e),this.jobExecutionListeners.forEach(function(t){return t.afterJob(e)});var t=this.afterJobExecutionPromiseResolves[e.id];t&&t(e),this.jobInstancesToTerminate[e.jobInstance.id]&&this.jobRepository.remove(e.jobInstance)}}]),t}(p.JobExecutionListener)},{"./configurations/probabilistic-sensitivity-analysis/probabilistic-sensitivity-analysis-job":7,"./configurations/recompute/recompute-job":9,"./configurations/sensitivity-analysis/sensitivity-analysis-job":11,"./engine/job-execution-flag":23,"./engine/job-execution-listener":24,"./engine/job-launcher":28,"./engine/job-parameters":30,"./engine/job-repository/idb-job-repository":31,"./job-worker":41,"sd-utils":"sd-utils"}],43:[function(e,t,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ObjectiveRulesManager=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),a=e("./rules"),u=e("sd-utils"),s=e("sd-model"),c=o(s);n.ObjectiveRulesManager=function(){function e(t,n,o){i(this,e),this.ruleByName={},this.data=t,this.expressionEngine=n;var r=new a.ExpectedValueMaximizationRule(n),u=new a.MaxiMinRule(n),s=new a.MaxiMaxRule(n),c=new a.ExpectedValueMinimizationRule(n),l=new a.MiniMinRule(n),f=new a.MiniMaxRule(n);this.ruleByName[r.name]=r,this.ruleByName[u.name]=u,this.ruleByName[s.name]=s,this.ruleByName[c.name]=c,this.ruleByName[l.name]=l,this.ruleByName[f.name]=f,this.rules=[r,c,u,s,l,f],o?this.currentRule=this.ruleByName[o]:this.currentRule=this.rules[0]}return r(e,[{key:"isRuleName",value:function(e){return!!this.ruleByName[e]}},{key:"setCurrentRuleByName",value:function(e){this.currentRule=this.ruleByName[e]}},{key:"recompute",value:function(e){var t=this,n=(new Date).getTime();u.log.trace("recomputing rules, all: "+e),this.data.getRoots().forEach(function(n){t.recomputeTree(n,e)});var o=(new Date).getTime()-n/1e3;return u.log.trace("recomputation took "+o+"s"),this}},{key:"recomputeTree",value:function(e,t){u.log.trace("recomputing rules for tree ...",e);var n=(new Date).getTime(),o=[this.currentRule];t&&(o=this.rules),o.forEach(function(t){t.computePayoff(e),t.computeOptimal(e)});var i=((new Date).getTime()-n)/1e3;return u.log.trace("recomputation took "+i+"s"),this}},{key:"getNodeDisplayValue",value:function(e,t){return e.computedValue(this.currentRule.name,t)}},{key:"getEdgeDisplayValue",value:function(e,t){return"probability"===t?e.parentNode instanceof c.domain.DecisionNode?e.computedValue(this.currentRule.name,"probability"):e.parentNode instanceof c.domain.ChanceNode?e.computedBaseProbability():null:"payoff"===t?e.computedBasePayoff():"optimal"===t?e.computedValue(this.currentRule.name,"optimal"):void 0}}]),e}()},{"./rules":46,"sd-model":"sd-model","sd-utils":"sd-utils"}],44:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.ExpectedValueMaximizationRule=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("./objective-rule"),l=n.ExpectedValueMaximizationRule=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.NAME,e))}return r(t,e),u(t,[{key:"computePayoff",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=0;if(e.childEdges.length){if(e instanceof s.domain.DecisionNode){var r=-(1/0);e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));r=Math.max(r,n)}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")<r?0:1)})}else e.childEdges.forEach(function(e){t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o)),t.clearComputedValues(e),t.cValue(e,"probability",t.baseProbability(e))});var a=0;e.childEdges.forEach(function(e){a=t.add(a,t.cValue(e,"probability"))}),e.childEdges.forEach(function(e){i=t.add(i,t.multiply(t.cValue(e,"probability"),t.cValue(e.childNode,"payoff")).div(a))})}return n=this.add(n,i),this.clearComputedValues(e),e instanceof s.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",i),this.cValue(e,"payoff",n)}},{key:"computeOptimal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.cValue(e,"optimal",!0),e instanceof s.domain.TerminalNode&&this.cValue(e,"probabilityToEnter",o),e.childEdges.forEach(function(i){!t.subtract(t.cValue(e,"payoff"),n).equals(t.cValue(i.childNode,"payoff"))&&e instanceof s.domain.DecisionNode?t.cValue(i,"optimal",!1):(t.cValue(i,"optimal",!0),t.computeOptimal(i.childNode,t.basePayoff(i),t.multiply(o,t.cValue(i,"probability"))))})}}]),t}(c.ObjectiveRule);l.NAME="expected-value-maximization"},{"./objective-rule":51,"sd-model":"sd-model"}],45:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.ExpectedValueMinimizationRule=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("./objective-rule"),l=n.ExpectedValueMinimizationRule=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.NAME,e))}return r(t,e),u(t,[{key:"computePayoff",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=0;if(e.childEdges.length){if(e instanceof s.domain.DecisionNode){var r=1/0;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));r=Math.min(r,n)}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")>r?0:1)})}else e.childEdges.forEach(function(e){t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o)),t.clearComputedValues(e),t.cValue(e,"probability",t.baseProbability(e))});var a=0;e.childEdges.forEach(function(e){a=t.add(a,t.cValue(e,"probability"))}),e.childEdges.forEach(function(e){i=t.add(i,t.multiply(t.cValue(e,"probability"),t.cValue(e.childNode,"payoff")).div(a))})}return n=this.add(n,i),this.clearComputedValues(e),e instanceof s.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",i),this.cValue(e,"payoff",n)}},{key:"computeOptimal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.cValue(e,"optimal",!0),e instanceof s.domain.TerminalNode&&this.cValue(e,"probabilityToEnter",o),e.childEdges.forEach(function(i){!t.subtract(t.cValue(e,"payoff"),n).equals(t.cValue(i.childNode,"payoff"))&&e instanceof s.domain.DecisionNode?t.cValue(i,"optimal",!1):(t.cValue(i,"optimal",!0),t.computeOptimal(i.childNode,t.basePayoff(i),t.multiply(o,t.cValue(i,"probability"))))})}}]),t}(c.ObjectiveRule);l.NAME="expected-value-minimization"},{"./objective-rule":51,"sd-model":"sd-model"}],46:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./objective-rule");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var i=e("./expected-value-maximization-rule");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var r=e("./expected-value-minimization-rule");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var a=e("./maxi-max-rule");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}})});var u=e("./maxi-min-rule");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}})});var s=e("./mini-max-rule");Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return s[e]}})});var c=e("./mini-min-rule");Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return c[e]}})})},{"./expected-value-maximization-rule":44,"./expected-value-minimization-rule":45,"./maxi-max-rule":47,"./maxi-min-rule":48,"./mini-max-rule":49,"./mini-min-rule":50,"./objective-rule":51}],47:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.MaxiMaxRule=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("./objective-rule"),l=e("sd-utils"),f=n.MaxiMaxRule=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.NAME,e))}return r(t,e),u(t,[{key:"computePayoff",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=0;if(e.childEdges.length){if(e instanceof s.domain.DecisionNode){var r=-(1/0);e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));r=Math.max(r,n)}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")<r?0:1)})}else{var r=-(1/0),a=1;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));n>r?(r=n,a=1):n.equals(r)&&a++}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")<r?0:1/a)})}var u=0;e.childEdges.forEach(function(e){u=t.add(u,t.cValue(e,"probability"))}),e.childEdges.forEach(function(e){i=t.add(i,t.multiply(t.cValue(e,"probability"),t.cValue(e.childNode,"payoff")).div(u))})}return n=this.add(n,i),this.clearComputedValues(e),e instanceof s.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",i),this.cValue(e,"payoff",n)}},{key:"computeOptimal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.cValue(e,"optimal",!0),e instanceof s.domain.TerminalNode&&this.cValue(e,"probabilityToEnter",o);var i=null;e instanceof s.domain.ChanceNode&&(i=l.Utils.maxBy(e.childEdges,function(e){return t.cValue(e.childNode,"payoff")})),e.childEdges.forEach(function(r){var a=!1;a=i?t.cValue(i.childNode,"payoff").equals(t.cValue(r.childNode,"payoff")):!(!t.subtract(t.cValue(e,"payoff"),n).equals(t.cValue(r.childNode,"payoff"))&&e instanceof s.domain.DecisionNode),a?(t.cValue(r,"optimal",!0),t.computeOptimal(r.childNode,t.basePayoff(r),t.multiply(o,t.cValue(r,"probability")))):t.cValue(r,"optimal",!1)})}}]),t}(c.ObjectiveRule);f.NAME="maxi-max"},{"./objective-rule":51,"sd-model":"sd-model","sd-utils":"sd-utils"}],48:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.MaxiMinRule=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("./objective-rule"),l=e("sd-utils"),f=n.MaxiMinRule=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.NAME,e))}return r(t,e),u(t,[{key:"computePayoff",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=0;if(e.childEdges.length){if(e instanceof s.domain.DecisionNode){var r=-(1/0);e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));r=Math.max(r,n)}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")<r?0:1)})}else{var a=1/0,u=1;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));n<a?(a=n,u=1):n.equals(a)&&u++}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")>a?0:1/u)})}var c=0;e.childEdges.forEach(function(e){c=t.add(c,t.cValue(e,"probability"))}),e.childEdges.forEach(function(e){i=t.add(i,t.multiply(t.cValue(e,"probability"),t.cValue(e.childNode,"payoff")).div(c))})}return n=this.add(n,i),this.clearComputedValues(e),e instanceof s.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",i),this.cValue(e,"payoff",n)}},{key:"computeOptimal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.cValue(e,"optimal",!0),e instanceof s.domain.TerminalNode&&this.cValue(e,"probabilityToEnter",o);var i=null;e instanceof s.domain.ChanceNode&&(i=l.Utils.minBy(e.childEdges,function(e){return t.cValue(e.childNode,"payoff")})),e.childEdges.forEach(function(r){var a=!1;a=i?t.cValue(i.childNode,"payoff").equals(t.cValue(r.childNode,"payoff")):!(!t.subtract(t.cValue(e,"payoff"),n).equals(t.cValue(r.childNode,"payoff"))&&e instanceof s.domain.DecisionNode),a?(t.cValue(r,"optimal",!0),t.computeOptimal(r.childNode,t.basePayoff(r),t.multiply(o,t.cValue(r,"probability")))):t.cValue(r,"optimal",!1)})}}]),t}(c.ObjectiveRule);f.NAME="maxi-min"},{"./objective-rule":51,"sd-model":"sd-model","sd-utils":"sd-utils"}],49:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.MiniMaxRule=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("./objective-rule"),l=e("sd-utils"),f=n.MiniMaxRule=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.NAME,e))}return r(t,e),u(t,[{key:"computePayoff",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=0;if(e.childEdges.length){if(e instanceof s.domain.DecisionNode){var r=1/0;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));r=Math.min(r,n)}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")>r?0:1)})}else{var a=-(1/0),u=1;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));n>a?(a=n,u=1):n.equals(a)&&u++}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")<a?0:1/u)})}var c=0;e.childEdges.forEach(function(e){c=t.add(c,t.cValue(e,"probability"))}),e.childEdges.forEach(function(e){i=t.add(i,t.multiply(t.cValue(e,"probability"),t.cValue(e.childNode,"payoff")).div(c))})}return n=this.add(n,i),this.clearComputedValues(e),e instanceof s.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",i),this.cValue(e,"payoff",n)}},{key:"computeOptimal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.cValue(e,"optimal",!0),e instanceof s.domain.TerminalNode&&this.cValue(e,"probabilityToEnter",o);var i=null;e instanceof s.domain.ChanceNode&&(i=l.Utils.maxBy(e.childEdges,function(e){return t.cValue(e.childNode,"payoff")})),e.childEdges.forEach(function(r){var a=!1;a=i?t.cValue(i.childNode,"payoff").equals(t.cValue(r.childNode,"payoff")):!(!t.subtract(t.cValue(e,"payoff"),n).equals(t.cValue(r.childNode,"payoff"))&&e instanceof s.domain.DecisionNode),a?(t.cValue(r,"optimal",!0),t.computeOptimal(r.childNode,t.basePayoff(r),t.multiply(o,t.cValue(r,"probability")))):t.cValue(r,"optimal",!1)})}}]),t}(c.ObjectiveRule);f.NAME="mini-max"},{"./objective-rule":51,"sd-model":"sd-model","sd-utils":"sd-utils"}],50:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.MiniMinRule=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("./objective-rule"),l=e("sd-utils"),f=n.MiniMinRule=function(e){function t(e){return o(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.NAME,e))}return r(t,e),u(t,[{key:"computePayoff",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=0;if(e.childEdges.length){if(e instanceof s.domain.DecisionNode){var r=1/0;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));r=Math.min(r,n)}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")>r?0:1)})}else{var r=1/0,a=1;e.childEdges.forEach(function(e){var n=t.computePayoff(e.childNode,t.basePayoff(e),t.add(t.basePayoff(e),o));n<r?(r=n,a=1):n.equals(r)&&a++}),e.childEdges.forEach(function(e){t.clearComputedValues(e),t.cValue(e,"probability",t.cValue(e.childNode,"payoff")>r?0:1/a)})}var u=0;e.childEdges.forEach(function(e){u=t.add(u,t.cValue(e,"probability"))}),e.childEdges.forEach(function(e){i=t.add(i,t.multiply(t.cValue(e,"probability"),t.cValue(e.childNode,"payoff")).div(u))})}return n=this.add(n,i),this.clearComputedValues(e),e instanceof s.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",i),this.cValue(e,"payoff",n)}},{key:"computeOptimal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;
this.cValue(e,"optimal",!0),e instanceof s.domain.TerminalNode&&this.cValue(e,"probabilityToEnter",o);var i=null;e instanceof s.domain.ChanceNode&&(i=l.Utils.minBy(e.childEdges,function(e){return t.cValue(e.childNode,"payoff")})),e.childEdges.forEach(function(r){var a=!1;a=i?t.cValue(i.childNode,"payoff").equals(t.cValue(r.childNode,"payoff")):!(!t.subtract(t.cValue(e,"payoff"),n).equals(t.cValue(r.childNode,"payoff"))&&e instanceof s.domain.DecisionNode),a?(t.cValue(r,"optimal",!0),t.computeOptimal(r.childNode,t.basePayoff(r),t.multiply(o,t.cValue(r,"probability")))):t.cValue(r,"optimal",!1)})}}]),t}(c.ObjectiveRule);f.NAME="mini-min"},{"./objective-rule":51,"sd-model":"sd-model","sd-utils":"sd-utils"}],51:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ObjectiveRule=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-expression-engine");n.ObjectiveRule=function(){function e(t,n){o(this,e),this.name=t,this.expressionEngine=n}return i(e,[{key:"computePayoff",value:function(e){arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;throw"computePayoff function not implemented for rule: "+this.name}},{key:"computeOptimal",value:function(e){throw"computeOptimal function not implemented for rule: "+this.name}},{key:"cValue",value:function(e,t,n){return e.computedValue(this.name,t,n)}},{key:"baseProbability",value:function(e){return e.computedBaseProbability()}},{key:"basePayoff",value:function(e){return e.computedBasePayoff()}},{key:"clearComputedValues",value:function(e){e.clearComputedValues(this.name)}},{key:"add",value:function(e,t){return r.ExpressionEngine.add(e,t)}},{key:"subtract",value:function(e,t){return r.ExpressionEngine.subtract(e,t)}},{key:"divide",value:function(e,t){return r.ExpressionEngine.divide(e,t)}},{key:"multiply",value:function(e,t){return r.ExpressionEngine.multiply(e,t)}}]),e}()},{"sd-expression-engine":"sd-expression-engine"}],52:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(n,"__esModule",{value:!0}),n.FlipSubtree=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=e("sd-model"),c=e("sd-expression-engine"),l=e("sd-utils"),f=e("./operation"),p=e("../validation/tree-validator"),d=n.FlipSubtree=function(e){function t(e,n){o(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.$NAME));return r.data=e,r.expressionEngine=n,r.treeValidator=new p.TreeValidator(n),r}return r(t,e),u(t,[{key:"isApplicable",value:function(e){return e instanceof s.domain.ChanceNode}},{key:"canPerform",value:function(e){if(!this.isApplicable(e))return!1;if(!this.treeValidator.validate(this.data.getAllNodesInSubtree(e)).isValid())return!1;if(e.childEdges.length<1)return!1;var t,n=null,o=[],i=new Set;return!!e.childEdges.every(function(e){var r=e.childNode;return r instanceof s.domain.ChanceNode&&(!i.has(e.name.trim())&&(i.add(e.name.trim()),null===n?(n=r.childEdges.length,!(n<1)&&(r.childEdges.forEach(function(e){o.push(e.name.trim())}),t=new Set(o),t.size===o.length)):r.childEdges.length==n&&!!r.childEdges.every(function(e,t){return o[t]===e.name.trim()})))})}},{key:"perform",value:function(e){var t=this,n=this.data.cloneSubtree(e,!0),o=e.childEdges.length,i=e.childEdges[0].childNode.childEdges.length,r=i,a=o,u=this.data.callbacksDisabled;this.data.callbacksDisabled=!0;var l=e.childEdges[0].childNode.location.x,f=e.childEdges[0].childNode.childEdges[0].childNode.location.y,p=e.childEdges[o-1].childNode.childEdges[i-1].childNode.location.y,d=p-f,b=d/(r+1);e.childEdges.slice().forEach(function(e){return t.data.removeNode(e.childNode)});for(var y=0;y<r;y++){var h=new s.domain.ChanceNode(new s.domain.Point(l,f+(y+1)*b)),v=this.data.addNode(h,e);v.name=n.childEdges[0].childNode.childEdges[y].name,v.probability=0;for(var m=0;m<a;m++){var g=n.childEdges[m].childNode.childEdges[y].childNode,E=this.data.attachSubtree(g,h);E.name=n.childEdges[m].name,E.payoff=c.ExpressionEngine.add(n.childEdges[m].computedBasePayoff(),n.childEdges[m].childNode.childEdges[y].computedBasePayoff()),E.probability=c.ExpressionEngine.multiply(n.childEdges[m].computedBaseProbability(),n.childEdges[m].childNode.childEdges[y].computedBaseProbability()),v.probability=c.ExpressionEngine.add(v.probability,E.probability)}var x=function(e){return c.ExpressionEngine.divide(e,v.probability)};if(v.probability.equals(0)){var j=c.ExpressionEngine.divide(1,a);x=function(e){return j}}var O=0;h.childEdges.forEach(function(e){e.probability=x(e.probability),O=c.ExpressionEngine.add(O,e.probability),e.probability=t.expressionEngine.serialize(e.probability)}),this._normalizeProbabilitiesAfterFlip(h.childEdges,O),v.probability=this.expressionEngine.serialize(v.probability)}this._normalizeProbabilitiesAfterFlip(e.childEdges),this.data.callbacksDisabled=u,this.data._fireNodeAddedCallback()}},{key:"_normalizeProbabilitiesAfterFlip",value:function(e,t){var n=this;if(t||(t=0,e.forEach(function(e){t=c.ExpressionEngine.add(t,e.probability)})),!t.equals(1)){l.log.info("Sum of the probabilities in child nodes is not equal to 1 : ",t);var o=0,i=1e12,r=12;e.forEach(function(e){e.probability=parseInt(c.ExpressionEngine.round(e.probability,r)*i),o+=e.probability});var a=i-o;l.log.info("Normalizing with rounding to precision: "+r,a),e[0].probability=c.ExpressionEngine.add(a,e[0].probability),o=0,e.forEach(function(e){e.probability=n.expressionEngine.serialize(c.ExpressionEngine.divide(parseInt(e.probability),i))})}}}]),t}(f.Operation);d.$NAME="flipSubtree"},{"../validation/tree-validator":60,"./operation":53,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],53:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();n.Operation=function(){function e(t){o(this,e),this.name=t}return i(e,[{key:"isApplicable",value:function(){throw"isApplicable function not implemented for operation: "+this.name}},{key:"canPerform",value:function(e){throw"canPerform function not implemented for operation: "+this.name}},{key:"perform",value:function(e){throw"perform function not implemented for operation: "+this.name}}]),e}()},{}],54:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.OperationsManager=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("./flip-subtree");n.OperationsManager=function(){function e(t,n){o(this,e),this.operations=[],this.operationByName={},this.data=t,this.expressionEngine=n,this.registerOperation(new r.FlipSubtree(t,n))}return i(e,[{key:"registerOperation",value:function(e){this.operations.push(e),this.operationByName[e.name]=e}},{key:"getOperationByName",value:function(e){return this.operationByName[e]}},{key:"operationsForObject",value:function(e){return this.operations.filter(function(t){return t.isApplicable(e)})}}]),e}()},{"./flip-subtree":52}],55:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();n.Decision=function(){function e(t,n){o(this,e),this.children=[],this.node=t,this.decisionValue=n,this.key=e.generateKey(this)}return i(e,[{key:"addDecision",value:function(t,n){var o=new e(t,n);return this.children.push(o),this.key=e.generateKey(this),o}},{key:"toDecisionString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e.toDecisionString(this,t)}}],[{key:"generateKey",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"$id",n=e.node.childEdges[e.decisionValue];return e.node[t]+":"+(n[t]?n[t]:e.decisionValue+1)}},{key:"toDecisionString",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"name",i=e.generateKey(t,o),r="";return t.children.forEach(function(t){r&&(r+=", "),r+=e.toDecisionString(t,n)}),t.children.length>1&&(r="("+r+")"),r.length&&(i+=" - "+r),i}}]),e}()},{}],56:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.PoliciesCollector=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("./policy"),a=e("sd-model"),u=e("sd-utils"),s=e("./decision");n.PoliciesCollector=function(){function e(t){var n=this;o(this,e),this.policies=[],this.collect(t).forEach(function(e,t){n.policies.push(new r.Policy(t,e))})}return i(e,[{key:"collect",value:function(e){for(var t,n=this,o=[e],i=[];o.length;)t=o.shift(),t instanceof a.domain.DecisionNode?i.push(t):t.childEdges.forEach(function(e,t){o.push(e.childNode)});return u.Utils.cartesianProductOf(i.map(function(e){var t=[];return e.childEdges.forEach(function(o,i){var r=n.collect(o.childNode);r.forEach(function(n){var o=new s.Decision(e,i);t.push(o),o.children=n})}),t}))}}]),e}()},{"./decision":55,"./policy":57,"sd-model":"sd-model","sd-utils":"sd-utils"}],57:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.Policy=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("./decision");n.Policy=function(){function e(t,n){o(this,e),this.decisions=[],this.id=t,this.decisions=n||[]}return i(e,[{key:"addDecision",value:function(t,n){var o=new r.Decision(t,n);return this.decisions.push(o),this.key=e.generateKey(this),o}},{key:"equals",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.key==e.key&&(t||this.id===e.id)}},{key:"toPolicyString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e.toPolicyString(this,t)}}],[{key:"generateKey",value:function(e){var t="";return e.decisions.forEach(function(e){return t+=(t?"&":"")+e.key}),t}},{key:"toPolicyString",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n="";return e.decisions.forEach(function(e){n&&(n+=", "),n+=e.toDecisionString(t)}),n}}]),e}()},{"./decision":55}],58:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.PayoffValueValidator=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-expression-engine");e("sd-utils"),n.PayoffValueValidator=function(){function e(t){o(this,e),this.expressionEngine=t}return i(e,[{key:"validate",value:function(e){if(null===e||void 0===e)return!1;var e=r.ExpressionEngine.toNumber(e);return e.compare(Number.MIN_SAFE_INTEGER)>=0&&e.compare(Number.MAX_SAFE_INTEGER)<=0}}]),e}()},{"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],59:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.ProbabilityValueValidator=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=e("sd-expression-engine");e("sd-utils"),n.ProbabilityValueValidator=function(){function e(t){o(this,e),this.expressionEngine=t}return i(e,[{key:"validate",value:function(e,t){if(null===e||void 0===e)return!1;var e=r.ExpressionEngine.toNumber(e);return e.compare(0)>=0&&e.compare(1)<=0}}]),e}()},{"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],60:[function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.TreeValidator=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=(e("sd-utils"),e("sd-model")),a=e("sd-expression-engine"),u=e("./probability-value-validator"),s=e("./payoff-value-validator");n.TreeValidator=function(){function e(t){o(this,e),this.expressionEngine=t,this.probabilityValueValidator=new u.ProbabilityValueValidator(t),this.payoffValueValidator=new s.PayoffValueValidator(t)}return i(e,[{key:"validate",value:function(e){var t=this,n=new r.ValidationResult;return e.forEach(function(e){t.validateNode(e,n)}),n}},{key:"validateNode",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.ValidationResult;if(!(e instanceof r.domain.TerminalNode)){e.childEdges.length||n.addError("incompletePath",e);var o=a.ExpressionEngine.toNumber(0);return e.childEdges.forEach(function(i,u){if(i.setValueValidity("probability",!0),i.setValueValidity("payoff",!0),e instanceof r.domain.ChanceNode){var s=i.computedBaseProbability();t.probabilityValueValidator.validate(s)?o=a.ExpressionEngine.add(o,s):a.ExpressionEngine.isHash(i.probability)||(n.addError({name:"invalidProbability",data:{number:u+1}},e),i.setValueValidity("probability",!1))}var c=i.computedBasePayoff();t.payoffValueValidator.validate(c)||(n.addError({name:"invalidPayoff",data:{number:u+1}},e),i.setValueValidity("payoff",!1))}),e instanceof r.domain.ChanceNode&&(!isNaN(o)&&o.equals(1)||n.addError("probabilityDoNotSumUpTo1",e)),n}}}]),e}()},{"./payoff-value-validator":58,"./probability-value-validator":59,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],"sd-computations":[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./src/index");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})})},{"./src/index":5}]},{},[]);
//# sourceMappingURL=sd-computations.min.js.map
