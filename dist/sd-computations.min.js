require=function i(u,a,s){function c(t,e){if(!a[t]){if(!u[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(l)return l(t,!0);var o=new Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}var r=a[t]={exports:{}};u[t][0].call(r.exports,function(e){return c(u[t][1][e]||e)},r,r.exports,i,u,a,s)}return a[t].exports}for(var l="function"==typeof require&&require,e=0;e<s.length;e++)c(s[e]);return c}({1:[function(e,t,n){var o,r;o=this,r=function(e){"use strict";function u(n){return new Promise(function(e,t){n.onsuccess=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function i(n,o,r){var i,e=new Promise(function(e,t){u(i=n[o].apply(n,r)).then(e,t)});return e.request=i,e}function t(e,n,t){t.forEach(function(t){Object.defineProperty(e.prototype,t,{get:function(){return this[n][t]},set:function(e){this[n][t]=e}})})}function n(t,n,o,e){e.forEach(function(e){e in o.prototype&&(t.prototype[e]=function(){return i(this[n],e,arguments)})})}function o(t,n,o,e){e.forEach(function(e){e in o.prototype&&(t.prototype[e]=function(){return this[n][e].apply(this[n],arguments)})})}function r(e,o,t,n){n.forEach(function(n){n in t.prototype&&(e.prototype[n]=function(){return e=this[o],(t=i(e,n,arguments)).then(function(e){if(e)return new s(e,t.request)});var e,t})})}function a(e){this._index=e}function s(e,t){this._cursor=e,this._request=t}function c(e){this._store=e}function l(n){this._tx=n,this.complete=new Promise(function(e,t){n.oncomplete=function(){e()},n.onerror=function(){t(n.error)},n.onabort=function(){t(n.error)}})}function f(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new l(n)}function p(e){this._db=e}t(a,"_index",["name","keyPath","multiEntry","unique"]),n(a,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),r(a,"_index",IDBIndex,["openCursor","openKeyCursor"]),t(s,"_cursor",["direction","key","primaryKey","value"]),n(s,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(n){n in IDBCursor.prototype&&(s.prototype[n]=function(){var t=this,e=arguments;return Promise.resolve().then(function(){return t._cursor[n].apply(t._cursor,e),u(t._request).then(function(e){if(e)return new s(e,t._request)})})})}),c.prototype.createIndex=function(){return new a(this._store.createIndex.apply(this._store,arguments))},c.prototype.index=function(){return new a(this._store.index.apply(this._store,arguments))},t(c,"_store",["name","keyPath","indexNames","autoIncrement"]),n(c,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),r(c,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(c,"_store",IDBObjectStore,["deleteIndex"]),l.prototype.objectStore=function(){return new c(this._tx.objectStore.apply(this._tx,arguments))},t(l,"_tx",["objectStoreNames","mode"]),o(l,"_tx",IDBTransaction,["abort"]),f.prototype.createObjectStore=function(){return new c(this._db.createObjectStore.apply(this._db,arguments))},t(f,"_db",["name","version","objectStoreNames"]),o(f,"_db",IDBDatabase,["deleteObjectStore","close"]),p.prototype.transaction=function(){return new l(this._db.transaction.apply(this._db,arguments))},t(p,"_db",["name","version","objectStoreNames"]),o(p,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(i){[c,a].forEach(function(e){i in e.prototype&&(e.prototype[i.replace("open","iterate")]=function(){var e,t=(e=arguments,Array.prototype.slice.call(e)),n=t[t.length-1],o=this._store||this._index,r=o[i].apply(o,t.slice(0,-1));r.onsuccess=function(){n(r.result)}})})}),[a,c].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,n){var o=this,r=[];return new Promise(function(t){o.iterateCursor(e,function(e){e?(r.push(e.value),void 0===n||r.length!=n?e.continue():t(r)):t(r)})})})}),e.openDb=function(e,t,n){var o=i(indexedDB,"open",[e,t]),r=o.request;return r&&(r.onupgradeneeded=function(e){n&&n(new f(r.result,e.oldVersion,r.transaction))}),o.then(function(e){return new p(e)})},e.deleteDb=function(e){return i(indexedDB,"deleteDatabase",[e])},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof n&&void 0!==t?r(n):"function"==typeof define&&define.amd?define(["exports"],r):r((o=o||self).idb={})},{}],2:[function(h,e,m){(function(i){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(m,"__esModule",{value:!0}),m.ComputationsEngine=m.ComputationsEngineConfig=void 0;var a=h("sd-utils"),s=h("sd-model"),u=h("./computations-manager");function n(e){return(n="function"==typeof Symbol&&"symbol"===t(Symbol.iterator)?function(e){return t(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t,n){return(l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=b(e)););return e}(e,t);if(o){var r=Object.getOwnPropertyDescriptor(o,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?y(e):t}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var e=function(e){function n(e){var t;return f(this,n),(t=p(this,b(n).call(this))).logLevel="warn",e&&a.Utils.deepExtend(y(t),e),t}return d(n,u.ComputationsManagerConfig),n}();m.ComputationsEngineConfig=e;var r=function(e){function o(e,t){var n;if(f(this,o),(n=p(this,b(o).call(this,e,t))).global=a.Utils.getGlobalObject(),n.isWorker=a.Utils.isWorker(),n.isWorker){n.jobsManger.registerJobExecutionListener({beforeJob:function(e){n.reply("beforeJob",e.getDTO())},afterJob:function(e){n.reply("afterJob",e.getDTO())}});var u=y(n);n.queryableFunctions={runJob:function(e,t,n){var o=new s.DataModel(n);u.runJob(e,t,o)},executeJob:function(t){u.jobsManger.execute(t).catch(function(e){u.reply("jobFatalError",t,a.Utils.getErrorDTO(e))})},recompute:function(e,t,n,o){t&&u.objectiveRulesManager.setCurrentRuleByName(t);var r=!t,i=new s.DataModel(e);u._checkValidityAndRecomputeObjective(i,r,n,o),this.reply("recomputed",i.getDTO())}},i.onmessage=function(e){e.data instanceof Object&&e.data.hasOwnProperty("queryMethod")&&e.data.hasOwnProperty("queryArguments")?u.queryableFunctions[e.data.queryMethod].apply(self,e.data.queryArguments):u.defaultReply(e.data)}}return n}var t,n,r;return d(o,u.ComputationsManager),t=o,(n=[{key:"setConfig",value:function(e){return l(b(o.prototype),"setConfig",this).call(this,e),this.config.logLevel&&this.setLogLevel(this.config.logLevel),this}},{key:"setLogLevel",value:function(e){a.log.setLevel(e)}},{key:"defaultReply",value:function(e){this.reply("test",e)}},{key:"reply",value:function(){if(arguments.length<1)throw new TypeError("reply - not enough arguments");this.global.postMessage({queryMethodListener:arguments[0],queryMethodArguments:Array.prototype.slice.call(arguments,1)})}}])&&c(t.prototype,n),r&&c(t,r),o}();m.ComputationsEngine=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./computations-manager":3,"sd-model":"sd-model","sd-utils":"sd-utils"}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ComputationsManager=n.ComputationsManagerConfig=void 0;var r=e("sd-expression-engine"),o=e("sd-utils"),i=e("./objective/objective-rules-manager"),u=e("./validation/tree-validator"),a=e("./operations/operations-manager"),s=e("./jobs/jobs-manager"),c=e("./expressions-evaluator"),l=e("./jobs/job-instance-manager"),f=e("sd-model"),p=e("./policies/policy"),b=e("./validation/mcdm-weight-value-validator");function y(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var h=function e(t){d(this,e),this.logLevel=null,this.ruleName=null,this.worker={delegateRecomputation:!1,url:null},this.jobRepositoryType="idb",this.clearRepository=!1,t&&o.Utils.deepExtend(this,t)};n.ComputationsManagerConfig=h;var m=function(){function n(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;d(this,n),this.data=t,this.setConfig(e),this.expressionEngine=new r.ExpressionEngine,this.expressionsEvaluator=new c.ExpressionsEvaluator(this.expressionEngine),this.objectiveRulesManager=new i.ObjectiveRulesManager(this.expressionEngine,this.config.ruleName),this.jobsManger=new s.JobsManager(this.expressionsEvaluator,this.objectiveRulesManager,{workerUrl:this.config.worker.url,repositoryType:this.config.jobRepositoryType,clearRepository:this.config.clearRepository}),this.operationsManager=new a.OperationsManager(this.data,this.expressionEngine,new s.JobsManager(this.expressionsEvaluator,this.objectiveRulesManager,{repositoryType:"timeout"})),this.treeValidator=new u.TreeValidator(this.expressionEngine),this.mcdmWeightValueValidator=new b.McdmWeightValueValidator}var e,t,o;return e=n,(t=[{key:"setConfig",value:function(e){return this.config=new h(e),this}},{key:"setData",value:function(e){this.data=e,this.operationsManager.setData(e)}},{key:"recompute",value:function(){return this.checkValidityAndRecomputeObjective.apply(this,arguments)}},{key:"checkValidityAndRecomputeObjective",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return Promise.resolve().then(function(){if(n.config.worker.delegateRecomputation){var e={evalCode:o,evalNumeric:r};return t||(e.ruleName=n.getCurrentRule().name),n.runJob("recompute",e,n.data,!1).then(function(e){var t=e.getData();n.data.updateFrom(t)})}return n._checkValidityAndRecomputeObjective(n.data,t,o,r)}).then(function(){n.updateDisplayValues(n.data)})}},{key:"_checkValidityAndRecomputeObjective",value:function(n,o){var r=this,e=2<arguments.length&&void 0!==arguments[2]&&arguments[2],t=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];this.objectiveRulesManager.updateDefaultCriterion1Weight(n.defaultCriterion1Weight),n.validationResults=[],(e||t)&&this.expressionsEvaluator.evalExpressions(n,e,t);var i=this.mcdmWeightValueValidator.validate(n.defaultCriterion1Weight),u=this.getCurrentRule().multiCriteria;n.getRoots().forEach(function(e){var t=r.treeValidator.validate(n.getAllNodesInSubtree(e));n.validationResults.push(t),!t.isValid()||u&&!i||r.objectiveRulesManager.recomputeTree(e,o)})}},{key:"getCurrentRule",value:function(){return this.objectiveRulesManager.currentRule}},{key:"setCurrentRuleByName",value:function(e){return this.config.ruleName=e,this.objectiveRulesManager.setCurrentRuleByName(e)}},{key:"getJobByName",value:function(e){return this.jobsManger.getJobByName(e)}},{key:"operationsForObject",value:function(e){return this.operationsManager.operationsForObject(e)}},{key:"isValid",value:function(e){return(e=e||this.data).validationResults.every(function(e){return e.isValid()})}},{key:"runJob",value:function(e,t,n){var o=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return this.jobsManger.run(e,t,n||this.data,o)}},{key:"runJobWithInstanceManager",value:function(e,t,n){var o=this;return this.runJob(e,t).then(function(e){return new l.JobInstanceManager(o.jobsManger,e,n)})}},{key:"performOperation",value:function(e,t,n){return this.operationsManager.performOperation(e,t,n)}},{key:"getObjectiveRules",value:function(){return this.objectiveRulesManager.rules}},{key:"getObjectiveRuleByName",value:function(e){return this.objectiveRulesManager.getObjectiveRuleByName(e)}},{key:"isRuleName",value:function(e){return this.objectiveRulesManager.isRuleName(e)}},{key:"flipCriteria",value:function(e){(e=e||this.data).reversePayoffs();var t=e.weightLowerBound;return e.weightLowerBound=this.flip(e.weightUpperBound),e.weightUpperBound=this.flip(t),e.defaultCriterion1Weight=this.flip(e.defaultCriterion1Weight),this.objectiveRulesManager.flipRule(),this.checkValidityAndRecomputeObjective(!1)}},{key:"flip",value:function(e){return e==1/0?0:0==e?1/0:this.expressionEngine.serialize(r.ExpressionEngine.divide(1,e))}},{key:"updateDisplayValues",value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e=e||this.data,n)return this.displayPolicy(e,n);e.nodes.forEach(function(e){t.updateNodeDisplayValues(e)}),e.edges.forEach(function(e){t.updateEdgeDisplayValues(e)})}},{key:"updateNodeDisplayValues",value:function(t){var n=this;t.$DISPLAY_VALUE_NAMES.forEach(function(e){return t.displayValue(e,n.objectiveRulesManager.getNodeDisplayValue(t,e))})}},{key:"updateEdgeDisplayValues",value:function(t){var n=this;t.$DISPLAY_VALUE_NAMES.forEach(function(e){return t.displayValue(e,n.objectiveRulesManager.getEdgeDisplayValue(t,e))})}},{key:"displayPolicy",value:function(t,e){var n=this;(e=e||this.data).nodes.forEach(function(e){e.clearDisplayValues()}),e.edges.forEach(function(e){e.clearDisplayValues()}),e.getRoots().forEach(function(e){return n.displayPolicyForNode(e,t)})}},{key:"displayPolicyForNode",value:function(e,t){var n=this;if(e instanceof f.domain.DecisionNode){var o=p.Policy.getDecision(t,e);if(o){e.displayValue("optimal",!0);var r=e.childEdges[o.decisionValue];return r.displayValue("optimal",!0),this.displayPolicyForNode(r.childNode,t)}}else e instanceof f.domain.ChanceNode?(e.displayValue("optimal",!0),e.childEdges.forEach(function(e){e.displayValue("optimal",!0),n.displayPolicyForNode(e.childNode,t)})):e instanceof f.domain.TerminalNode&&e.displayValue("optimal",!0)}}])&&y(e.prototype,t),o&&y(e,o),n}();n.ComputationsManager=m},{"./expressions-evaluator":5,"./jobs/job-instance-manager":62,"./jobs/jobs-manager":64,"./objective/objective-rules-manager":65,"./operations/operations-manager":82,"./policies/policy":86,"./validation/mcdm-weight-value-validator":87,"./validation/tree-validator":90,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ComputationsUtils=void 0;var s=e("sd-expression-engine");function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,o=[{key:"sequence",value:function(e,t,n){var o=s.ExpressionEngine.subtract(t,e),r=[e];if(!(n-1))return r;for(var i=s.ExpressionEngine.divide(o,n-1),u=e,a=0;a<n-2;a++)u=s.ExpressionEngine.add(u,i),r.push(s.ExpressionEngine.toFloat(u));return r.push(t),r}}],(n=null)&&r(t.prototype,n),o&&r(t,o),e}();n.ComputationsUtils=o},{"sd-expression-engine":"sd-expression-engine"}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ExpressionsEvaluator=void 0;var p=e("sd-expression-engine"),b=e("sd-model"),y=e("sd-utils");function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.expressionEngine=e}var e,n,o;return e=t,(n=[{key:"clear",value:function(e){e.nodes.forEach(function(e){e.clearComputedValues()}),e.edges.forEach(function(e){e.clearComputedValues()})}},{key:"clearTree",value:function(e,t){e.getAllNodesInSubtree(t).forEach(function(e){e.clearComputedValues(),e.childEdges.forEach(function(e){e.clearComputedValues()})})}},{key:"evalExpressions",value:function(t){var n=this,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],r=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=3<arguments.length&&void 0!==arguments[3]&&arguments[3];y.log.debug("evalExpressions evalCode:"+o+" evalNumeric:"+r),o&&this.evalGlobalCode(t),t.getRoots().forEach(function(e){n.clearTree(t,e),n.evalExpressionsForNode(t,e,o,r,i)})}},{key:"evalGlobalCode",value:function(t){t.clearExpressionScope(),t.$codeDirty=!1;try{t.$codeError=null,this.expressionEngine.eval(t.code,!1,t.expressionScope)}catch(e){t.$codeError=e}}},{key:"evalPayoff",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return p.ExpressionEngine.hasAssignmentExpression(e.payoff[t])?null:this.expressionEngine.eval(e.payoff[t],!0,e.parentNode.expressionScope)}},{key:"evalExpressionsForNode",value:function(t,n){var r=this,o=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],u=4<arguments.length&&void 0!==arguments[4]&&arguments[4];if((!n.expressionScope||u||o)&&this.initScopeForNode(t,n),o&&(n.$codeDirty=!1,n.code))try{n.$codeError=null,this.expressionEngine.eval(n.code,!1,n.expressionScope)}catch(e){n.$codeError=e,y.log.debug(e)}if(i){var a=n.expressionScope,s=p.ExpressionEngine.toNumber(0),c=[],l=!1;if(n.childEdges.forEach(function(o){if(o.payoff.forEach(function(e,t){var n="payoff["+t+"]";if(o.isFieldValid(n,!0,!1))try{o.computedValue(null,n,r.evalPayoff(o,t))}catch(e){}}),n instanceof b.domain.ChanceNode){if(p.ExpressionEngine.isHash(o.probability))return void c.push(o);if(p.ExpressionEngine.hasAssignmentExpression(o.probability))return y.log.warn("evalExpressionsForNode hasAssignmentExpression!",o),null;if(o.isFieldValid("probability",!0,!1))try{var e=r.expressionEngine.eval(o.probability,!0,a);o.computedValue(null,"probability",e),s=p.ExpressionEngine.add(s,e)}catch(e){l=!0}else l=!0}}),n instanceof b.domain.ChanceNode)if(c.length&&!l&&0<=s.compare(0)&&s.compare(1)<=0){var f=p.ExpressionEngine.divide(p.ExpressionEngine.subtract(1,s),c.length);c.forEach(function(e){e.computedValue(null,"probability",f)})}n.childEdges.forEach(function(e){r.evalExpressionsForNode(t,e.childNode,o,i,u)})}}},{key:"initScopeForNode",value:function(e,t){var n=t.$parent,o=n?n.expressionScope:e.expressionScope;t.expressionScope=y.Utils.cloneDeep(o)}}])&&r(e.prototype,n),o&&r(e,o),t}();n.ExpressionsEvaluator=o},{"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./computations-engine");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var r=e("./computations-manager");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var i=e("./expressions-evaluator");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var u=e("./jobs/index");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}})})},{"./computations-engine":2,"./computations-manager":3,"./expressions-evaluator":5,"./jobs/index":61}],7:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.LeagueTableJobParameters=void 0;var i=e("sd-utils"),u=e("../../engine/job-parameters"),a=e("../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("ruleName",a.PARAMETER_TYPE.STRING)),this.definitions.push(new a.JobParameterDefinition("extendedPolicyDescription",a.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new a.JobParameterDefinition("weightLowerBound",a.PARAMETER_TYPE.NUMBER_EXPRESSION).set("singleValueValidator",function(e,t){return 0<=e&&e<=a.JobParameterDefinition.computeNumberExpression(t.weightUpperBound)})),this.definitions.push(new a.JobParameterDefinition("defaultWeight",a.PARAMETER_TYPE.NUMBER_EXPRESSION).set("singleValueValidator",function(e,t){return 0<=e&&e>=a.JobParameterDefinition.computeNumberExpression(t.weightLowerBound)&&e<=a.JobParameterDefinition.computeNumberExpression(t.weightUpperBound)})),this.definitions.push(new a.JobParameterDefinition("weightUpperBound",a.PARAMETER_TYPE.NUMBER_EXPRESSION).set("singleValueValidator",function(e,t){return 0<=e&&e>=a.JobParameterDefinition.computeNumberExpression(t.weightLowerBound)}))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),nameOfCriterion1:"Cost",nameOfCriterion2:"Effect",extendedPolicyDescription:!0,weightLowerBound:0,defaultWeight:0,weightUpperBound:1/0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.LeagueTableJobParameters=p},{"../../engine/job-parameter-definition":48,"../../engine/job-parameters":49,"sd-utils":"sd-utils"}],8:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.LeagueTableJob=void 0;var i=e("../../engine/simple-job"),u=e("../../../policies/policy"),a=(e("sd-expression-engine"),e("./steps/calculate-step")),s=e("./league-table-job-parameters");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=l(this,f(r).call(this,"league-table",e,t,n))).initSteps(),o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(r,i.SimpleJob),t=r,(n=[{key:"initSteps",value:function(){this.calculateStep=new a.CalculateStep(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager),this.addStep(this.calculateStep)}},{key:"createJobParameters",value:function(e){return new s.LeagueTableJobParameters(e)}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return 1===e.getRoots().length}}}},{key:"jobResultToCsvRows",value:function(e,o){var t=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=[];if(t){var n=["policy_id","policy",e.payoffNames[0],e.payoffNames[1],"dominated_by","extended-dominated_by","incratio","optimal","optimal_for_default_weight"];r.push(n)}return e.rows.forEach(function(n){n.policies.forEach(function(e){var t=[n.id,u.Policy.toPolicyString(e,o.values.extendedPolicyDescription),n.payoffs[1],n.payoffs[0],n.dominatedBy,null===n.extendedDominatedBy?null:n.extendedDominatedBy[0]+", "+n.extendedDominatedBy[1],n.incratio,n.optimal,n.optimalForDefaultWeight];r.push(t)})}),r}}])&&c(t.prototype,n),o&&c(t,o),r}();n.LeagueTableJob=b},{"../../../policies/policy":86,"../../engine/simple-job":57,"./league-table-job-parameters":7,"./steps/calculate-step":9,"sd-expression-engine":"sd-expression-engine"}],9:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.CalculateStep=void 0;var i=e("../../../engine/step"),j=e("../../../engine/job-status"),x=e("../../../../policies/policies-collector"),P=e("sd-expression-engine"),u=e("../../../../validation/tree-validator");e("../../../../policies/policy");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function O(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=s(this,c(r).call(this,"calculate_step",e))).expressionsEvaluator=t,o.objectiveRulesManager=n,o.treeValidator=new u.TreeValidator,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(r,i.Step),t=r,(n=[{key:"doExecute",value:function(e,t){var r=this,n=e.getData(),o=e.getJobParameters(),i=o.value("ruleName");this.objectiveRulesManager.setCurrentRuleByName(i);var u=this.objectiveRulesManager.currentRule,a=n.getRoots()[0],s=new x.PoliciesCollector(a).policies,c=this.payoffCoeffs=u.payoffCoeffs;if(this.expressionsEvaluator.evalExpressions(n),!this.treeValidator.validate(n.getAllNodesInSubtree(a)).isValid())return e;var l=function(e,t){return-c[0]*(t.payoffs[0]-e.payoffs[0])||-c[1]*(e.payoffs[1]-t.payoffs[1])},f=s.map(function(e){return r.objectiveRulesManager.recomputeTree(a,!1,e),{policies:[e],payoffs:a.computedValue(i,"payoff").slice(),dominatedBy:null,extendedDominatedBy:null,incratio:null,optimal:!1,optimalForDefaultWeight:!1}}).sort(l);(f=f.reduce(function(e,t,n,o){if(!e.length)return[t];var r,i=e[e.length-1];return 0!=l(i,t)?e.concat(t):((r=i.policies).push.apply(r,O(t.policies)),e)},[])).sort(function(e,t){return c[0]*(e.payoffs[0]-t.payoffs[0])||-c[1]*(e.payoffs[1]-t.payoffs[1])}),f.forEach(function(e,t){e.id=t+1}),f.sort(function(e,t){return-c[0]*(e.payoffs[0]-t.payoffs[0])||-c[1]*(e.payoffs[1]-t.payoffs[1])});var p=-c[1]*(1/0),b=null,y=function(e,t){return t<e};c[1]<0&&(y=function(e,t){return e<t}),f.forEach(function(e,t){y(e.payoffs[1],p)?(p=e.payoffs[1],b=e):b&&(e.dominatedBy=b.id)}),y=function(e,t){return e<t},0<c[0]&&c[1]<0?y=function(e,t){return e<t}:c[0]<0&&0<c[1]?y=function(e,t){return e<t}:c[1]<0&&(y=function(e,t){return t<e});var d=null;f.filter(function(e){return!e.dominatedBy}).sort(function(e,t){return c[0]*(e.payoffs[0]-t.payoffs[0])}).forEach(function(e,t,n){if(t){var o=n[t-1];e.incratio=r.computeICER(e,o),t<2||(d||(d=n[t-2]),y(e.incratio,o.incratio)?(o.incratio=null,o.extendedDominatedBy=[d.id,e.id],e.incratio=r.computeICER(e,d)):d=o)}else e.incratio=0});var h=o.value("weightLowerBound"),m=o.value("defaultWeight"),v=o.value("weightUpperBound"),g=null,E=null;return f.slice().filter(function(e){return!e.dominatedBy&&!e.extendedDominatedBy}).sort(function(e,t){var n=e.incratio-t.incratio;return n||c[0]*(e.payoffs[0]-t.payoffs[0])}).forEach(function(e,t,n){e.incratio<h&&(g=e),e.incratio<m&&(E=e),e.optimal=e.incratio>=h&&e.incratio<=v,e.optimalForDefaultWeight=e.incratio==m}),g&&(g.optimal=!0),E&&(E.optimalForDefaultWeight=!0),f.forEach(function(e){e.payoffs[0]=P.ExpressionEngine.toFloat(e.payoffs[0]),e.payoffs[1]=P.ExpressionEngine.toFloat(e.payoffs[1]),e.incratio=null===e.incratio?null:P.ExpressionEngine.toFloat(e.incratio)}),t.data={payoffNames:n.payoffNames.slice(),payoffCoeffs:c,rows:f.sort(function(e,t){return e.id-t.id}),weightLowerBound:P.ExpressionEngine.toFloat(h),defaultWeight:P.ExpressionEngine.toFloat(m),weightUpperBound:P.ExpressionEngine.toFloat(v)},e.exitStatus=j.JOB_STATUS.COMPLETED,e}},{key:"computeICER",value:function(e,t){var n=P.ExpressionEngine.subtract(e.payoffs[0],t.payoffs[0]),o=P.ExpressionEngine.subtract(e.payoffs[1],t.payoffs[1]);return 0==n?o<0?-1/0:1/0:Math.abs(P.ExpressionEngine.divide(o,n))}}])&&a(t.prototype,n),o&&a(t,o),r}();n.CalculateStep=f},{"../../../../policies/policies-collector":85,"../../../../policies/policy":86,"../../../../validation/tree-validator":90,"../../../engine/job-status":55,"../../../engine/step":60,"sd-expression-engine":"sd-expression-engine"}],10:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.PayoffsTransformationJobParameters=void 0;var i=e("sd-utils"),u=e("../../engine/job-parameters"),a=e("../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("objectId",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("functionName",a.PARAMETER_TYPE.STRING).set("required",!0)),this.definitions.push(new a.JobParameterDefinition("functionBody",a.PARAMETER_TYPE.STRING).set("required",!0)),this.definitions.push(new a.JobParameterDefinition("functionArgumentName",a.PARAMETER_TYPE.STRING).set("required",!0)),this.definitions.push(new a.JobParameterDefinition("makeClone",a.PARAMETER_TYPE.BOOLEAN))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),functionName:"transformPayoff",functionBody:"log(p)",functionArgumentName:"p",makeClone:!0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.PayoffsTransformationJobParameters=p},{"../../engine/job-parameter-definition":48,"../../engine/job-parameters":49,"sd-utils":"sd-utils"}],11:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.PayoffsTransformationJob=void 0;e("../../engine/simple-job"),e("../../engine/step"),e("../../engine/job-status");var i=e("../../../validation/tree-validator"),u=e("./payoffs-transformation-job-parameters"),a=e("../../engine/job"),s=e("sd-model"),c=e("sd-expression-engine");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function l(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function f(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=f(this,p(r).call(this,r.$NAME,e))).isRestartable=!1,o.expressionsEvaluator=t,o.objectiveRulesManager=n,o.treeValidator=new i.TreeValidator,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}(r,a.Job),t=r,(n=[{key:"doExecute",value:function(e){var t=e.getData(),n=e.jobParameters,o=n.value("functionName"),r=t.findNodeById(n.value("objectId")),i=n.value("makeClone"),u=i?t.cloneSubtree(r,!0):r;u.code+="\n"+o+"("+n.value("functionArgumentName")+") = "+n.value("functionBody");var a=t.getAllNodesInSubtree(u);if(this.processNodePayoff(u,n),i){var s=Number.MAX_VALUE,c=Number.MIN_VALUE;a.forEach(function(e){e.location.y<s&&(s=e.location.y),e.location.y>c&&(c=e.location.y)});var l=c-s+30;u.move(0,l),t.attachSubtree(u)}return e}},{key:"processNodePayoff",value:function(e,t){var o=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[0,0];e.type!==s.domain.TerminalNode.$TYPE?(n&&n.payoff.fill(0),e.childEdges.forEach(function(n){o.processNodePayoff(n.childNode,t,n,r.map(function(e,t){return c.ExpressionEngine.add(e,n.computedBasePayoff(void 0,t))}))})):n.payoff=r.map(function(e){return t.value("functionName")+"("+c.ExpressionEngine.toNumber(e).toFraction(!1)+")"})}},{key:"createJobParameters",value:function(e){return new u.PayoffsTransformationJobParameters(e)}}])&&l(t.prototype,n),o&&l(t,o),r}();(n.PayoffsTransformationJob=y).$NAME="payoffs-transformation"},{"../../../validation/tree-validator":90,"../../engine/job":56,"../../engine/job-status":55,"../../engine/simple-job":57,"../../engine/step":60,"./payoffs-transformation-job-parameters":10,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model"}],12:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.RecomputeJobParameters=void 0;var i=e("sd-utils"),u=e("../../engine/job-parameters"),a=e("../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("ruleName",a.PARAMETER_TYPE.STRING).set("required",!1)),this.definitions.push(new a.JobParameterDefinition("evalCode",a.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new a.JobParameterDefinition("evalNumeric",a.PARAMETER_TYPE.BOOLEAN))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),ruleName:null,evalCode:!0,evalNumeric:!0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.RecomputeJobParameters=p},{"../../engine/job-parameter-definition":48,"../../engine/job-parameters":49,"sd-utils":"sd-utils"}],13:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.RecomputeJob=void 0;e("../../engine/simple-job"),e("../../engine/step"),e("../../engine/job-status");var i=e("../../../validation/tree-validator"),u=(e("../../engine/batch/batch-step"),e("./recompute-job-parameters")),a=e("../../engine/job");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=c(this,l(r).call(this,"recompute",e))).isRestartable=!1,o.expressionsEvaluator=t,o.objectiveRulesManager=n,o.treeValidator=new i.TreeValidator,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(r,a.Job),t=r,(n=[{key:"doExecute",value:function(e){var t=e.getData(),n=e.jobParameters,o=n.value("ruleName"),r=!o;return o&&this.objectiveRulesManager.setCurrentRuleByName(o),this.checkValidityAndRecomputeObjective(t,r,n.value("evalCode"),n.value("evalNumeric")),e}},{key:"checkValidityAndRecomputeObjective",value:function(n,o,e,t){var r=this;n.validationResults=[],(e||t)&&this.expressionsEvaluator.evalExpressions(n,e,t),n.getRoots().forEach(function(e){var t=r.treeValidator.validate(n.getAllNodesInSubtree(e));n.validationResults.push(t),t.isValid()&&r.objectiveRulesManager.recomputeTree(e,o)})}},{key:"createJobParameters",value:function(e){return new u.RecomputeJobParameters(e)}}])&&s(t.prototype,n),o&&s(t,o),r}();n.RecomputeJob=p},{"../../../validation/tree-validator":90,"../../engine/batch/batch-step":30,"../../engine/job":56,"../../engine/job-status":55,"../../engine/simple-job":57,"../../engine/step":60,"./recompute-job-parameters":12}],14:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.SensitivityAnalysisJobParameters=void 0;var i=e("sd-utils"),u=e("../../../engine/job-parameters"),a=e("../../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("ruleName",a.PARAMETER_TYPE.STRING)),this.definitions.push(new a.JobParameterDefinition("extendedPolicyDescription",a.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new a.JobParameterDefinition("failOnInvalidTree",a.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new a.JobParameterDefinition("variables",[new a.JobParameterDefinition("name",a.PARAMETER_TYPE.STRING),new a.JobParameterDefinition("min",a.PARAMETER_TYPE.NUMBER),new a.JobParameterDefinition("max",a.PARAMETER_TYPE.NUMBER),new a.JobParameterDefinition("length",a.PARAMETER_TYPE.INTEGER).set("singleValueValidator",function(e){return 2<=e})],1,1/0,!1,function(e){return e.min<e.max},function(e){return i.Utils.isUnique(e,function(e){return e.name})}))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),extendedPolicyDescription:!0,failOnInvalidTree:!0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.SensitivityAnalysisJobParameters=p},{"../../../engine/job-parameter-definition":48,"../../../engine/job-parameters":49,"sd-utils":"sd-utils"}],15:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.SensitivityAnalysisJob=void 0;var i=e("../../../engine/simple-job"),u=e("./sensitivity-analysis-job-parameters"),a=e("./steps/prepare-variables-step"),s=e("./steps/init-policies-step"),c=e("./steps/calculate-step"),l=e("../../../../policies/policy"),f=e("sd-utils");e("sd-expression-engine");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function p(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function b(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h=function(e){function r(e,t,n){var o;3<arguments.length&&void 0!==arguments[3]&&arguments[3];return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=b(this,y(r).call(this,"sensitivity-analysis",e,t,n))).batchSize=5,o.initSteps(),o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(r,i.SimpleJob),t=r,(n=[{key:"initSteps",value:function(){this.addStep(new a.PrepareVariablesStep(this.jobRepository,this.expressionsEvaluator.expressionEngine)),this.addStep(new s.InitPoliciesStep(this.jobRepository)),this.calculateStep=new c.CalculateStep(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager,this.batchSize),this.addStep(this.calculateStep)}},{key:"createJobParameters",value:function(e){return new u.SensitivityAnalysisJobParameters(e)}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return 1===e.getRoots().length}}}},{key:"setBatchSize",value:function(e){this.batchSize=e,this.calculateStep.chunkSize=e}},{key:"jobResultToCsvRows",value:function(o,r){var e=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=[];if(e){var t=["policy_number","policy"];o.variableNames.forEach(function(e){return t.push(e)}),t.push("payoff"),i.push(t)}return!!r.values.roundVariables&&this.roundVariables(o),o.rows.forEach(function(e){var t=o.policies[e.policyIndex],n=[e.policyIndex+1,l.Policy.toPolicyString(t,r.values.extendedPolicyDescription)];e.variables.forEach(function(e){return n.push(e)}),n.push(e.payoff),i.push(n),e._variables&&(e.variables=e._variables,delete e._variables)}),i}},{key:"roundVariables",value:function(e){var r=e.variableNames.map(function(){return new Set});e.rows.forEach(function(e){e._variables=e.variables.slice(),e.variables.forEach(function(e,t){r[t].add(e)})});for(var n=r.map(function(e){return e.size}),i=2,u=e.variableNames.map(function(e,t){return t});i<=14&&u.length;){r=u.map(function(){return new Set}),e.rows.forEach(function(o){u.forEach(function(e,t){var n=o._variables[e];n=f.Utils.round(n,i),r[t].add(n),o.variables[e]=n})});var o=[];r.forEach(function(e,t){n[u[t]]==e.size&&o.push(t)}),o.length&&(o.reverse(),o.forEach(function(e){u.splice(e,1)})),i++}}},{key:"getProgress",value:function(e){return e.stepExecutions.length<=2?{total:1,current:0}:this.steps[2].getProgress(e.stepExecutions[2])}}])&&p(t.prototype,n),o&&p(t,o),r}();n.SensitivityAnalysisJob=h},{"../../../../policies/policy":86,"../../../engine/simple-job":57,"./sensitivity-analysis-job-parameters":14,"./steps/calculate-step":16,"./steps/init-policies-step":17,"./steps/prepare-variables-step":18,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],16:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.CalculateStep=void 0;var s=e("sd-utils"),r=e("sd-expression-engine"),u=e("../../../../engine/batch/batch-step"),a=e("../../../../../validation/tree-validator"),b=(e("../../../../../policies/policy"),e("../../../../engine/exceptions/job-computation-exception"));function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=function(e){function i(e,t,n,o){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(r=l(this,f(i).call(this,"calculate_step",e,o))).expressionsEvaluator=t,r.objectiveRulesManager=n,r.treeValidator=new a.TreeValidator,r}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(i,u.BatchStep),t=i,(n=[{key:"init",value:function(e,t){e.getJobExecutionContext();var n=e.getJobParameters(),o=n.value("ruleName");this.objectiveRulesManager.setCurrentRuleByName(o);var r=t.data.variableValues,i=n.value("variables").map(function(e){return e.name});return e.executionContext.put("variableNames",i),t.data.rows||(t.data.rows=[],t.data.variableNames=i),r.length}},{key:"readNextChunk",value:function(e,t,n,o){return o.data.variableValues.slice(t,t+n)}},{key:"processItem",value:function(e,n){var o=this,t=e.getJobParameters(),r=t.value("ruleName"),i=t.value("failOnInvalidTree"),u=e.getData(),a=u.getRoots()[0],s=e.executionContext.get("variableNames"),c=e.getJobExecutionContext().get("policies");this.expressionsEvaluator.clear(u),this.expressionsEvaluator.evalGlobalCode(u),s.forEach(function(e,t){u.expressionScope[e]=n[t]}),this.expressionsEvaluator.evalExpressionsForNode(u,a);var l=this.treeValidator.validate(u.getAllNodesInSubtree(a)).isValid();if(!l&&i){var f={variables:{}};throw s.forEach(function(e,t){f.variables[e]=n[t]}),new b.JobComputationException("computations",f)}var p=[];return c.forEach(function(e){var t="n/a";l&&(o.objectiveRulesManager.recomputeTree(a,!1,e),t=a.computedValue(r,"payoff")[0]),p.push(t)}),{policies:c,variables:n,payoffs:p}}},{key:"writeChunk",value:function(e,t,u){var a=this;e.getJobParameters().value("extendedPolicyDescription");t.forEach(function(i){i&&i.policies.forEach(function(e,t){var n=i.variables.map(function(e){return a.toFloat(e)}),o=i.payoffs[t],r={policyIndex:t,variables:n,payoff:s.Utils.isString(o)?o:a.toFloat(o)};u.data.rows.push(r)})})}},{key:"postProcess",value:function(e,t){delete t.data.variableValues}},{key:"toFloat",value:function(e){return r.ExpressionEngine.toFloat(e)}}])&&c(t.prototype,n),o&&c(t,o),i}();n.CalculateStep=y},{"../../../../../policies/policy":86,"../../../../../validation/tree-validator":90,"../../../../engine/batch/batch-step":30,"../../../../engine/exceptions/job-computation-exception":33,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],17:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.InitPoliciesStep=void 0;var i=e("../../../../engine/step"),u=e("../../../../engine/job-status"),a=e("../../../../../policies/policies-collector");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).call(this,"init_policies",e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.Step),n=t,(o=[{key:"doExecute",value:function(e,t){var n=e.getData().getRoots()[0],o=new a.PoliciesCollector(n).policies;return e.getJobExecutionContext().put("policies",o),t.data||(t.data={}),t.data.policies=o,e.exitStatus=u.JOB_STATUS.COMPLETED,e}}])&&s(n.prototype,o),r&&s(n,r),t}();n.InitPoliciesStep=p},{"../../../../../policies/policies-collector":85,"../../../../engine/job-status":55,"../../../../engine/step":60}],18:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.PrepareVariablesStep=void 0;var i=e("sd-utils"),u=e("../../../../engine/step"),a=e("../../../../engine/job-status"),s=e("../../../../../computations-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=function(e){function o(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(n=l(this,f(o).call(this,"prepare_variables",e))).expressionEngine=t,n}var t,n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(o,u.Step),t=o,(n=[{key:"doExecute",value:function(e,t){var n=e.getJobParameters().value("variables"),o=[];return n.forEach(function(e){o.push(s.ComputationsUtils.sequence(e.min,e.max,e.length))}),o=i.Utils.cartesianProductOf(o),t.data={variableValues:o},e.exitStatus=a.JOB_STATUS.COMPLETED,e}}])&&c(t.prototype,n),r&&c(t,r),o}();n.PrepareVariablesStep=b},{"../../../../../computations-utils":4,"../../../../engine/job-status":55,"../../../../engine/step":60,"sd-utils":"sd-utils"}],19:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.ProbabilisticSensitivityAnalysisJobParameters=void 0;var i=e("sd-utils"),u=e("../../../engine/job-parameters"),a=e("../../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("ruleName",a.PARAMETER_TYPE.STRING)),this.definitions.push(new a.JobParameterDefinition("failOnInvalidTree",a.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new a.JobParameterDefinition("extendedPolicyDescription",a.PARAMETER_TYPE.BOOLEAN)),this.definitions.push(new a.JobParameterDefinition("numberOfRuns",a.PARAMETER_TYPE.INTEGER).set("singleValueValidator",function(e){return 0<e})),this.definitions.push(new a.JobParameterDefinition("variables",[new a.JobParameterDefinition("name",a.PARAMETER_TYPE.STRING),new a.JobParameterDefinition("formula",a.PARAMETER_TYPE.NUMBER_EXPRESSION)],1,1/0,!1,null,function(e){return i.Utils.isUnique(e,function(e){return e.name})}))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),extendedPolicyDescription:!0,failOnInvalidTree:!0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.ProbabilisticSensitivityAnalysisJobParameters=p},{"../../../engine/job-parameter-definition":48,"../../../engine/job-parameters":49,"sd-utils":"sd-utils"}],20:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.ProbabilisticSensitivityAnalysisJob=void 0;var r=e("./probabilistic-sensitivity-analysis-job-parameters"),u=e("../n-way/steps/init-policies-step"),a=e("../n-way/sensitivity-analysis-job"),s=e("./steps/prob-calculate-step"),c=e("./steps/compute-policy-stats-step");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function l(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function f(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=function(e){function i(e,t,n){var o,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:5;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(o=f(this,p(i).call(this,e,t,n,r))).name="probabilistic-sensitivity-analysis",o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}(i,a.SensitivityAnalysisJob),t=i,(n=[{key:"initSteps",value:function(){this.addStep(new u.InitPoliciesStep(this.jobRepository)),this.calculateStep=new s.ProbCalculateStep(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager,this.batchSize),this.addStep(this.calculateStep),this.addStep(new c.ComputePolicyStatsStep(this.expressionsEvaluator.expressionEngine,this.objectiveRulesManager,this.jobRepository))}},{key:"createJobParameters",value:function(e){return new r.ProbabilisticSensitivityAnalysisJobParameters(e)}},{key:"getProgress",value:function(e){return e.stepExecutions.length<=1?{total:1,current:0}:this.steps[1].getProgress(e.stepExecutions[1])}}])&&l(t.prototype,n),o&&l(t,o),i}();n.ProbabilisticSensitivityAnalysisJob=y},{"../n-way/sensitivity-analysis-job":15,"../n-way/steps/init-policies-step":17,"./probabilistic-sensitivity-analysis-job-parameters":19,"./steps/compute-policy-stats-step":21,"./steps/prob-calculate-step":22}],21:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.ComputePolicyStatsStep=void 0;var a=e("sd-utils"),i=e("../../../../engine/step"),s=e("../../../../engine/job-status"),c=e("sd-expression-engine");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=l(this,f(r).call(this,"compute_policy_stats",n))).expressionEngine=e,o.objectiveRulesManager=t,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(r,i.Step),t=r,(n=[{key:"doExecute",value:function(e,t){var n=e.getJobParameters(),o=n.value("numberOfRuns"),r=n.value("ruleName"),i=this.objectiveRulesManager.ruleByName[r],u=t.data.policies.map(function(){return[]});return t.data.rows.forEach(function(e){u[e.policyIndex].push(a.Utils.isString(e.payoff)?0:e.payoff)}),a.log.debug("payoffsPerPolicy",u,t.data.rows.length,i.maximization),t.data.medians=u.map(function(e){return c.ExpressionEngine.median(e)}),t.data.standardDeviations=u.map(function(e){return c.ExpressionEngine.std(e)}),i.maximization?t.data.policyIsBestProbabilities=t.data.policyToHighestPayoffCount.map(function(e){return c.ExpressionEngine.toFloat(c.ExpressionEngine.divide(e,o))}):t.data.policyIsBestProbabilities=t.data.policyToLowestPayoffCount.map(function(e){return c.ExpressionEngine.toFloat(c.ExpressionEngine.divide(e,o))}),t.data.policyToHighestPayoffCount=t.data.policyToHighestPayoffCount.map(function(e){return c.ExpressionEngine.toFloat(e)}),t.data.policyToLowestPayoffCount=t.data.policyToLowestPayoffCount.map(function(e){return c.ExpressionEngine.toFloat(e)}),e.exitStatus=s.JOB_STATUS.COMPLETED,e}}])&&u(t.prototype,n),o&&u(t,o),r}();n.ComputePolicyStatsStep=b},{"../../../../engine/job-status":55,"../../../../engine/step":60,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],22:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.ProbCalculateStep=void 0;var p=e("sd-utils"),b=e("sd-expression-engine"),r=e("../../n-way/steps/calculate-step"),y=e("../../../../engine/exceptions/job-computation-exception");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function c(e,t,n){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(o){var r=Object.getOwnPropertyDescriptor(o,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var a=function(e){function a(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),s(this,l(a).apply(this,arguments))}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(a,r.CalculateStep),t=a,(n=[{key:"init",value:function(e,t){e.getJobExecutionContext();var n=e.getJobParameters(),o=n.value("ruleName");this.objectiveRulesManager.setCurrentRuleByName(o);var r=n.value("variables").map(function(e){return e.name});return e.executionContext.put("variableNames",r),t.data.rows||(t.data.rows=[],t.data.variableNames=r,t.data.expectedValues=p.Utils.fill(new Array(t.data.policies.length),0),t.data.policyToHighestPayoffCount=p.Utils.fill(new Array(t.data.policies.length),0),t.data.policyToLowestPayoffCount=p.Utils.fill(new Array(t.data.policies.length),0)),n.value("numberOfRuns")}},{key:"readNextChunk",value:function(e,t,n,o){for(var r=this,i=e.getJobParameters().value("variables"),u=e.getData(),a=[],s=0;s<n;s++){var c=[],l=[];if(i.forEach(function(t){try{var e=r.expressionsEvaluator.expressionEngine.eval(t.formula,!0,p.Utils.cloneDeep(u.expressionScope));c.push(b.ExpressionEngine.toFloat(e))}catch(e){l.push({variable:t,error:e})}}),l.length){var f={variables:[]};throw l.forEach(function(e){f.variables[e.variable.name]=e.error.message}),new y.JobComputationException("param-computation",f)}a.push(c)}return a}},{key:"processItem",value:function(e,t,n,o){var r=c(l(a.prototype),"processItem",this).call(this,e,t,o),i=e.getJobParameters().value("numberOfRuns"),u=e.getJobExecutionContext().get("policies");return this.updatePolicyStats(r,u,i,o),r}},{key:"updatePolicyStats",value:function(o,e,r,i){var u=-1/0,a=1/0,s=[],c=[],l=b.ExpressionEngine.toNumber(0);e.forEach(function(e,t){var n=o.payoffs[t];p.Utils.isString(n)&&(n=l),n<a?(a=n,c=[t]):n.equals(a)&&c.push(t),u<n?(u=n,s=[t]):n.equals(u)&&s.push(t),i.data.expectedValues[t]=b.ExpressionEngine.add(i.data.expectedValues[t],b.ExpressionEngine.divide(n,r))}),s.forEach(function(e){i.data.policyToHighestPayoffCount[e]=b.ExpressionEngine.add(i.data.policyToHighestPayoffCount[e],b.ExpressionEngine.divide(1,s.length))}),c.forEach(function(e){i.data.policyToLowestPayoffCount[e]=b.ExpressionEngine.add(i.data.policyToLowestPayoffCount[e],b.ExpressionEngine.divide(1,c.length))})}},{key:"postProcess",value:function(e,t){var n=this;t.data.expectedValues=t.data.expectedValues.map(function(e){return n.toFloat(e)})}},{key:"toFloat",value:function(e){return b.ExpressionEngine.toFloat(e)}}])&&u(t.prototype,n),o&&u(t,o),a}();n.ProbCalculateStep=a},{"../../../../engine/exceptions/job-computation-exception":33,"../../n-way/steps/calculate-step":16,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],23:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.SpiderPlotJobParameters=void 0;var i=e("sd-utils"),u=e("../../../engine/job-parameters"),a=e("../../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("ruleName",a.PARAMETER_TYPE.STRING)),this.definitions.push(new a.JobParameterDefinition("percentageChangeRange",a.PARAMETER_TYPE.NUMBER).set("singleValueValidator",function(e){return 0<e&&e<=100})),this.definitions.push(new a.JobParameterDefinition("length",a.PARAMETER_TYPE.INTEGER).set("singleValueValidator",function(e){return 0<=e})),this.definitions.push(new a.JobParameterDefinition("variables",[new a.JobParameterDefinition("name",a.PARAMETER_TYPE.STRING)],1,1/0,!1,null,function(e){return i.Utils.isUnique(e,function(e){return e.name})})),this.definitions.push(new a.JobParameterDefinition("failOnInvalidTree",a.PARAMETER_TYPE.BOOLEAN))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),failOnInvalidTree:!0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.SpiderPlotJobParameters=p},{"../../../engine/job-parameter-definition":48,"../../../engine/job-parameters":49,"sd-utils":"sd-utils"}],24:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.SpiderPlotJob=void 0;var i=e("../../../engine/simple-job"),u=e("./steps/calculate-step"),a=e("./spider-plot-job-parameters");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=l(this,f(r).call(this,"spider-plot",e))).addStep(new u.CalculateStep(e,t,n)),o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(r,i.SimpleJob),t=r,(n=[{key:"createJobParameters",value:function(e){return new a.SpiderPlotJobParameters(e)}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return 1===e.getRoots().length}}}},{key:"getProgress",value:function(e){return e.stepExecutions.length<1?{total:1,current:0}:this.steps[0].getProgress(e.stepExecutions[0])}},{key:"jobResultToCsvRows",value:function(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],o=[];return n&&o.push(["variable_name","policy_no"].concat(e.percentageRangeValues)),e.rows.forEach(function(n,e){o.push.apply(o,s(n.payoffs.map(function(e,t){return[n.variableName,t+1].concat(s(e))})))}),o}}])&&c(t.prototype,n),o&&c(t,o),r}();n.SpiderPlotJob=b},{"../../../engine/simple-job":57,"./spider-plot-job-parameters":23,"./steps/calculate-step":25}],25:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.CalculateStep=void 0;e("sd-utils");var h=e("sd-expression-engine"),m=e("../../../../engine/exceptions/job-computation-exception"),i=e("../../../../engine/batch/batch-step"),u=e("../../../../../validation/tree-validator"),v=(e("../../../../../policies/policy"),e("../../../../../policies/policies-collector")),g=e("../../../../../computations-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function a(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=c(this,l(r).call(this,"calculate_step",e,1))).expressionsEvaluator=t,o.objectiveRulesManager=n,o.treeValidator=new u.TreeValidator,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(r,i.BatchStep),t=r,(n=[{key:"init",value:function(e,t){var o=this,n=(e.getJobExecutionContext(),e.getJobParameters()),r=n.value("ruleName"),i=n.value("percentageChangeRange"),u=n.value("length"),a=n.value("variables");this.objectiveRulesManager.setCurrentRuleByName(r);var s=n.value("variables").map(function(e){return e.name});e.executionContext.put("variableNames",s);var c=e.getData(),l=c.getRoots()[0],f=l.computedValue(r,"payoff");this.expressionsEvaluator.clear(c),this.expressionsEvaluator.evalExpressions(c),this.objectiveRulesManager.recomputeTree(l,!1);var p=new v.PoliciesCollector(l,r),b={};c.getGlobalVariableNames().forEach(function(t){var n=c.expressionScope[t];try{b[t]=o.toFloat(n)}catch(e){throw new m.JobComputationException("error computing float value of a variable",{name:t,value:n})}});var y=g.ComputationsUtils.sequence(-i,i,2*u+1),d=[];return a.forEach(function(e){var t=b[e.name];d.push(y.map(function(e){return o.toFloat(h.ExpressionEngine.add(t,h.ExpressionEngine.multiply(h.ExpressionEngine.divide(e,100),t)))}))}),t.data||(t.data={variableNames:s,defaultValues:b,percentageRangeValues:y,defaultPayoff:this.toFloat(f)[0],policies:p.policies,rows:[]}),e.getJobExecutionContext().put("variableValues",d),d.length}},{key:"readNextChunk",value:function(e,t,n){return e.getJobExecutionContext().get("variableValues").slice(t,t+n)}},{key:"processItem",value:function(e,t,n,o){var r=this,i=e.getJobParameters(),u=i.value("ruleName"),a=i.value("failOnInvalidTree"),s=e.getData(),c=s.getRoots()[0],l=e.executionContext.get("variableNames")[n],f=o.data.policies.map(function(e){return[]});return this.expressionsEvaluator.clear(s),this.expressionsEvaluator.evalGlobalCode(s),t.forEach(function(e){if(s.expressionScope[l]=e,r.expressionsEvaluator.evalExpressionsForNode(s,c),!r.treeValidator.validate(s.getAllNodesInSubtree(c)).isValid()&&a){var t={variables:{}};throw t.variables[l]=e,new m.JobComputationException("computations",t)}o.data.policies.forEach(function(e,t){r.objectiveRulesManager.recomputeTree(c,!1,e);var n=c.computedValue(u,"payoff")[0];f[t].push(r.toFloat(n))})}),{variableName:l,variableIndex:n,variableValues:t,payoffs:f}}},{key:"writeChunk",value:function(e,t,n){var o;(o=n.data.rows).push.apply(o,a(t))}},{key:"toFloat",value:function(e){return h.ExpressionEngine.toFloat(e)}}])&&s(t.prototype,n),o&&s(t,o),r}();n.CalculateStep=p},{"../../../../../computations-utils":4,"../../../../../policies/policies-collector":85,"../../../../../policies/policy":86,"../../../../../validation/tree-validator":90,"../../../../engine/batch/batch-step":30,"../../../../engine/exceptions/job-computation-exception":33,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],26:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.CalculateStep=void 0;e("sd-utils");var i=e("sd-expression-engine"),b=e("../../../../engine/exceptions/job-computation-exception"),u=e("../../../../engine/batch/batch-step"),a=e("../../../../../validation/tree-validator"),y=(e("../../../../../policies/policy"),e("../../../../../policies/policies-collector"));function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var d=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=l(this,f(r).call(this,"calculate_step",e,1))).expressionsEvaluator=t,o.objectiveRulesManager=n,o.treeValidator=new a.TreeValidator,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(r,u.BatchStep),t=r,(n=[{key:"init",value:function(e,t){var o=this,n=e.getJobExecutionContext(),r=e.getJobParameters(),i=r.value("ruleName");this.objectiveRulesManager.setCurrentRuleByName(i);var u=n.get("variableValues"),a=r.value("variables").map(function(e){return e.name});e.executionContext.put("variableNames",a);var s=e.getData(),c=s.getRoots()[0],l=c.computedValue(i,"payoff");this.expressionsEvaluator.clear(s),this.expressionsEvaluator.evalExpressions(s),this.objectiveRulesManager.recomputeTree(c,!1);var f=new y.PoliciesCollector(c,i),p={};return s.getGlobalVariableNames().forEach(function(t){var n=s.expressionScope[t];try{p[t]=o.toFloat(n)}catch(e){throw new b.JobComputationException("error computing float value of a variable",{name:t,value:n})}}),t.data||(t.data={variableNames:a,defaultValues:p,variableExtents:u.map(function(e){return[e[0],e[e.length-1]]}),defaultPayoff:this.toFloat(l)[0],policies:f.policies,rows:[]}),u.length}},{key:"readNextChunk",value:function(e,t,n){return e.getJobExecutionContext().get("variableValues").slice(t,t+n)}},{key:"processItem",value:function(e,t,n,r){var i=this,o=e.getJobParameters(),u=o.value("ruleName"),a=o.value("failOnInvalidTree"),s=e.getData(),c=s.getRoots()[0],l=e.executionContext.get("variableNames")[n],f=r.data.policies.map(function(e){return{min:1/0,max:-1/0}}),p=r.data.policies.map(function(e){return{min:null,max:null}});return this.expressionsEvaluator.clear(s),this.expressionsEvaluator.evalGlobalCode(s),t.forEach(function(o){if(s.expressionScope[l]=o,i.expressionsEvaluator.evalExpressionsForNode(s,c),!i.treeValidator.validate(s.getAllNodesInSubtree(c)).isValid()&&a){var e={variables:{}};throw e.variables[l]=o,new b.JobComputationException("computations",e)}r.data.policies.forEach(function(e,t){i.objectiveRulesManager.recomputeTree(c,!1,e);var n=c.computedValue(u,"payoff")[0];n<f[t].min&&(f[t].min=n,p[t].min=o),n>f[t].max&&(f[t].max=n,p[t].max=o)})}),{variableName:l,variableIndex:n,extents:f.map(function(e){return[i.toFloat(e.min),i.toFloat(e.max)]}),extentVariableValues:p.map(function(e){return[i.toFloat(e.min),i.toFloat(e.max)]})}}},{key:"writeChunk",value:function(e,t,n){var o;(o=n.data.rows).push.apply(o,s(t))}},{key:"postProcess",value:function(e,t){t.data.rows.sort(function(e,t){return t.extents[0][1]-t.extents[0][0]-(e.extents[0][1]-e.extents[0][0])})}},{key:"toFloat",value:function(e){return i.ExpressionEngine.toFloat(e)}}])&&c(t.prototype,n),o&&c(t,o),r}();n.CalculateStep=d},{"../../../../../policies/policies-collector":85,"../../../../../policies/policy":86,"../../../../../validation/tree-validator":90,"../../../../engine/batch/batch-step":30,"../../../../engine/exceptions/job-computation-exception":33,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],27:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.PrepareVariablesStep=void 0;e("sd-utils");var i=e("../../../../engine/step"),u=e("../../../../engine/job-status"),a=(e("sd-expression-engine"),e("../../../../../computations-utils"));function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).call(this,"prepare_variables",e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.Step),n=t,(o=[{key:"doExecute",value:function(e){var t=e.getJobParameters().value("variables"),n=[];return t.forEach(function(e){n.push(a.ComputationsUtils.sequence(e.min,e.max,e.length))}),e.getJobExecutionContext().put("variableValues",n),e.exitStatus=u.JOB_STATUS.COMPLETED,e}}])&&s(n.prototype,o),r&&s(n,r),t}();n.PrepareVariablesStep=p},{"../../../../../computations-utils":4,"../../../../engine/job-status":55,"../../../../engine/step":60,"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],28:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.TornadoDiagramJobParameters=void 0;var i=e("sd-utils"),u=e("../../../engine/job-parameters"),a=e("../../../engine/job-parameter-definition");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,u.JobParameters),n=t,(o=[{key:"initDefinitions",value:function(){this.definitions.push(new a.JobParameterDefinition("id",a.PARAMETER_TYPE.STRING,1,1,!0)),this.definitions.push(new a.JobParameterDefinition("ruleName",a.PARAMETER_TYPE.STRING)),this.definitions.push(new a.JobParameterDefinition("variables",[new a.JobParameterDefinition("name",a.PARAMETER_TYPE.STRING),new a.JobParameterDefinition("min",a.PARAMETER_TYPE.NUMBER),new a.JobParameterDefinition("max",a.PARAMETER_TYPE.NUMBER),new a.JobParameterDefinition("length",a.PARAMETER_TYPE.INTEGER).set("singleValueValidator",function(e){return 0<=e})],1,1/0,!1,function(e){return e.min<=e.max},function(e){return i.Utils.isUnique(e,function(e){return e.name})})),this.definitions.push(new a.JobParameterDefinition("failOnInvalidTree",a.PARAMETER_TYPE.BOOLEAN))}},{key:"initDefaultValues",value:function(){this.values={id:i.Utils.guid(),failOnInvalidTree:!0}}}])&&s(n.prototype,o),r&&s(n,r),t}();n.TornadoDiagramJobParameters=p},{"../../../engine/job-parameter-definition":48,"../../../engine/job-parameters":49,"sd-utils":"sd-utils"}],29:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.TornadoDiagramJob=void 0;var i=e("../../../engine/simple-job"),u=e("./steps/prepare-variables-step"),a=e("./steps/calculate-step"),s=e("./tornado-diagram-job-parameters");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function l(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function f(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var y=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=f(this,p(r).call(this,"tornado-diagram",e))).addStep(new u.PrepareVariablesStep(e)),o.addStep(new a.CalculateStep(e,t,n)),o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}(r,i.SimpleJob),t=r,(n=[{key:"createJobParameters",value:function(e){return new s.TornadoDiagramJobParameters(e)}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return 1===e.getRoots().length}}}},{key:"getProgress",value:function(e){return e.stepExecutions.length<=1?{total:1,current:0}:this.steps[1].getProgress(e.stepExecutions[1])}},{key:"jobResultToCsvRows",value:function(o,e){var t=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=[];return t&&r.push(["variable_name","default_var_value","min_var_value","max_var_value","default_payoff","min_payoff","max_payoff","policy_no"]),o.rows.forEach(function(n,e){r.push.apply(r,c(n.extents.map(function(e,t){return[n.variableName,o.defaultValues[n.variableName],n.extentVariableValues[t][0],n.extentVariableValues[t][1],o.defaultPayoff,e[0],e[1],t+1]})))}),r}}])&&l(t.prototype,n),o&&l(t,o),r}();n.TornadoDiagramJob=y},{"../../../engine/simple-job":57,"./steps/calculate-step":26,"./steps/prepare-variables-step":27,"./tornado-diagram-job-parameters":28}],30:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.BatchStep=void 0;var i=e("../job-status"),u=e("sd-utils"),a=e("../step"),s=e("../exceptions/job-interrupted-exception");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=l(this,f(r).call(this,e,t))).chunkSize=n,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(r,a.Step),t=r,(n=[{key:"init",value:function(e,t){throw"BatchStep.init function not implemented for step: "+this.name}},{key:"readNextChunk",value:function(e,t,n,o){throw"BatchStep.readNextChunk function not implemented for step: "+this.name}},{key:"processItem",value:function(e,t,n,o){throw"BatchStep.processItem function not implemented for step: "+this.name}},{key:"writeChunk",value:function(e,t,n){}},{key:"postProcess",value:function(e,t){}},{key:"setTotalItemCount",value:function(e,t){e.executionContext.put(r.TOTAL_ITEM_COUNT_PROP,t)}},{key:"getTotalItemCount",value:function(e){return e.executionContext.get(r.TOTAL_ITEM_COUNT_PROP)}},{key:"setCurrentItemCount",value:function(e,t){e.executionContext.put(r.CURRENT_ITEM_COUNT_PROP,t)}},{key:"getCurrentItemCount",value:function(e){return e.executionContext.get(r.CURRENT_ITEM_COUNT_PROP)||0}},{key:"doExecute",value:function(t,n){var o=this;return Promise.resolve().then(function(){return o.init(t,n)}).catch(function(e){throw u.log.error("Failed to initialize batch step: "+o.name,e),e}).then(function(e){return Promise.resolve().then(function(){return o.setCurrentItemCount(t,o.getCurrentItemCount(t)),o.setTotalItemCount(t,e),o.handleNextChunk(t,n)}).catch(function(e){throw e instanceof s.JobInterruptedException||u.log.error("Failed to handle batch step: "+o.name,e),e})}).then(function(){return Promise.resolve().then(function(){return o.postProcess(t,n)}).catch(function(e){throw u.log.error("Failed to postProcess batch step: "+o.name,e),e})}).then(function(){return t.exitStatus=i.JOB_STATUS.COMPLETED,t})}},{key:"handleNextChunk",value:function(t,n){var o=this,r=this.getCurrentItemCount(t),e=this.getTotalItemCount(t),i=Math.min(this.chunkSize,e-r);return e<=r?t:this.checkJobExecutionFlags(t).then(function(){if(t.terminateOnly)throw new s.JobInterruptedException("JobExecution interrupted.");return t}).then(function(){return Promise.resolve().then(function(){return o.readNextChunk(t,r,i,n)}).catch(function(e){throw u.log.error("Failed to read chunk ("+r+","+i+") in batch step: "+o.name,e),e})}).then(function(e){return Promise.resolve().then(function(){return o.processChunk(t,e,r,n)}).catch(function(e){throw u.log.error("Failed to process chunk ("+r+","+i+") in batch step: "+o.name,e),e})}).then(function(e){return Promise.resolve().then(function(){return o.writeChunk(t,e,n)}).catch(function(e){throw u.log.error("Failed to write chunk ("+r+","+i+") in batch step: "+o.name,e),e})}).then(function(e){return r+=i,o.setCurrentItemCount(t,r),o.updateJobProgress(t).then(function(){return o.handleNextChunk(t,n)})})}},{key:"processChunk",value:function(n,e,o,r){var i=this;return e.map(function(e,t){return i.processItem(n,e,o+t,r)})}},{key:"getProgress",value:function(e){return{total:this.getTotalItemCount(e),current:this.getCurrentItemCount(e)}}},{key:"updateJobProgress",value:function(e){var t=this.jobRepository.getJobByName(e.jobExecution.jobInstance.jobName).getProgress(e.jobExecution);return this.jobRepository.updateJobExecutionProgress(e.jobExecution.id,t)}},{key:"checkJobExecutionFlags",value:function(e){return this.jobRepository.getJobByName(e.jobExecution.jobInstance.jobName).checkExecutionFlags(e.jobExecution)}}])&&c(t.prototype,n),o&&c(t,o),r}();(n.BatchStep=b).CURRENT_ITEM_COUNT_PROP="batch_step_current_item_count",b.TOTAL_ITEM_COUNT_PROP="batch_step_total_item_count"},{"../exceptions/job-interrupted-exception":37,"../job-status":55,"../step":60,"sd-utils":"sd-utils"}],31:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ExtendableError=void 0;n.ExtendableError=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.message=t,this.data=n,this.name=this.constructor.name}},{}],32:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./extendable-error");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var r=e("./job-data-invalid-exception");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var i=e("./job-execution-already-running-exception");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var u=e("./job-instance-already-complete-exception");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}})});var a=e("./job-interrupted-exception");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}})});var s=e("./job-parameters-invalid-exception");Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return s[e]}})});var c=e("./job-restart-exception");Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return c[e]}})})},{"./extendable-error":31,"./job-data-invalid-exception":34,"./job-execution-already-running-exception":35,"./job-instance-already-complete-exception":36,"./job-interrupted-exception":37,"./job-parameters-invalid-exception":38,"./job-restart-exception":39}],33:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobComputationException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobComputationException=c},{"./extendable-error":31}],34:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobDataInvalidException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobDataInvalidException=c},{"./extendable-error":31}],35:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobExecutionAlreadyRunningException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobExecutionAlreadyRunningException=c},{"./extendable-error":31}],36:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobInstanceAlreadyCompleteException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobInstanceAlreadyCompleteException=c},{"./extendable-error":31}],37:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobInterruptedException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobInterruptedException=c},{"./extendable-error":31}],38:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobParametersInvalidException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobParametersInvalidException=c},{"./extendable-error":31}],39:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobRestartException=void 0;var r=e("./extendable-error");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.ExtendableError),t}();n.JobRestartException=c},{"./extendable-error":31}],40:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ExecutionContext=void 0;var u=e("sd-utils"),a=e("sd-model");e("./step-execution");function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.dirty=!1,this.context={},e&&(this.context=u.Utils.clone(e))}var e,n,o;return e=t,(n=[{key:"put",value:function(e,t){var n=this.context[e];if(null!=t){this.context[e]=t;this.dirty=null==n||null!=n&&n!=t}else delete this.context[e],this.dirty=null!=n}},{key:"get",value:function(e){return this.context[e]}},{key:"containsKey",value:function(e){return this.context.hasOwnProperty(e)}},{key:"remove",value:function(e){delete this.context[e]}},{key:"setData",value:function(e){return this.put("data",e)}},{key:"getData",value:function(){return this.get("data")}},{key:"getDTO",value:function(){var r=this,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],t=u.Utils.cloneDeepWith;return e||(t=u.Utils.cloneWith),u.Utils.assign({},t(this,function(e,t,n,o){return-1<i.indexOf(t)?null:e instanceof a.DataModel?e.getDTO():e&&e.$ObjectWithIdAndEditableFields&&e.id&&r.getData().findById(e.id)?{$ObjectWithIdAndEditableFields:!0,id:e.id}:e instanceof Error?u.Utils.getErrorDTO(e):void 0}))}}])&&r(e.prototype,n),o&&r(e,o),t}();n.ExecutionContext=o},{"./step-execution":59,"sd-model":"sd-model","sd-utils":"sd-utils"}],41:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o={exceptions:!0};n.exceptions=void 0;var r=function(e){if(e&&e.__esModule)return e;var t=E();if(t&&t.has(e))return t.get(e);var n={};if(null!=e){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=o?Object.getOwnPropertyDescriptor(e,r):null;i&&(i.get||i.set)?Object.defineProperty(n,r,i):n[r]=e[r]}}n.default=e,t&&t.set(e,n);return n}(e("./exceptions"));n.exceptions=r;var i=e("./execution-context");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}}))});var u=e("./job");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}}))});var a=e("./job-execution");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}}))});var s=e("./job-execution-flag");Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return s[e]}}))});var c=e("./job-execution-listener");Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return c[e]}}))});var l=e("./job-instance");Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return l[e]}}))});var f=e("./job-key-generator");Object.keys(f).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return f[e]}}))});var p=e("./job-launcher");Object.keys(p).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return p[e]}}))});var b=e("./job-parameter-definition");Object.keys(b).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return b[e]}}))});var y=e("./job-parameters");Object.keys(y).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return y[e]}}))});var d=e("./job-status");Object.keys(d).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return d[e]}}))});var h=e("./simple-job");Object.keys(h).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return h[e]}}))});var m=e("./step");Object.keys(m).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return m[e]}}))});var v=e("./step-execution");Object.keys(v).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return v[e]}}))});var g=e("./step-execution-listener");function E(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return E=function(){return e},e}Object.keys(g).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return g[e]}}))})},{"./exceptions":32,"./execution-context":40,"./job":56,"./job-execution":44,"./job-execution-flag":42,"./job-execution-listener":43,"./job-instance":45,"./job-key-generator":46,"./job-launcher":47,"./job-parameter-definition":48,"./job-parameters":49,"./job-status":55,"./simple-job":57,"./step":60,"./step-execution":59,"./step-execution-listener":58}],42:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JOB_EXECUTION_FLAG=void 0;n.JOB_EXECUTION_FLAG={STOP:"STOP"}},{}],43:[function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.JobExecutionListener=void 0;var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,(n=[{key:"beforeJob",value:function(e){}},{key:"afterJob",value:function(e){}}])&&r(t.prototype,n),o&&r(t,o),e}();n.JobExecutionListener=o},{}],44:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobExecution=void 0;var r=e("./job-status"),u=e("./step-execution"),a=e("sd-utils"),i=e("./execution-context");function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.stepExecutions=[],this.status=r.JOB_STATUS.STARTING,this.exitStatus=r.JOB_STATUS.UNKNOWN,this.executionContext=new i.ExecutionContext,this.startTime=null,this.createTime=new Date,this.endTime=null,this.lastUpdated=null,this.failureExceptions=[],this.id=null==n?a.Utils.guid():n,this.jobInstance=e,this.jobParameters=t}var e,t,n;return e=o,(t=[{key:"createStepExecution",value:function(e){var t=new u.StepExecution(e,this);return this.stepExecutions.push(t),t}},{key:"isRunning",value:function(){return!this.endTime}},{key:"isStopping",value:function(){return this.status===r.JOB_STATUS.STOPPING}},{key:"stop",value:function(){this.stepExecutions.forEach(function(e){e.terminateOnly=!0}),this.status=r.JOB_STATUS.STOPPING}},{key:"getData",value:function(){return this.executionContext.getData()}},{key:"getDTO",value:function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],e=a.Utils.cloneDeepWith;return i||(e=a.Utils.cloneWith),a.Utils.assign({},e(this,function(e,t,n,o){return-1<r.indexOf(t)?null:-1<["jobParameters","executionContext"].indexOf(t)?e.getDTO():e instanceof Error?a.Utils.getErrorDTO(e):e instanceof u.StepExecution?e.getDTO(["jobExecution"],i):void 0}))}}])&&s(e.prototype,t),n&&s(e,n),o}();n.JobExecution=o},{"./execution-context":40,"./job-status":55,"./step-execution":59,"sd-utils":"sd-utils"}],45:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobInstance=void 0;n.JobInstance=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=t,this.jobName=n}},{}],46:[function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.JobKeyGenerator=void 0;var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,o=[{key:"generateKey",value:function(n){var o="";return n.definitions.forEach(function(e,t){e.identifying&&(o+=e.name+"="+n.values[e.name]+";")}),o}}],(n=null)&&r(t.prototype,n),o&&r(t,o),e}();n.JobKeyGenerator=o},{}],47:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobLauncher=void 0;var a=e("./exceptions/job-restart-exception"),i=e("./job-status"),s=e("sd-utils"),r=e("./exceptions/job-parameters-invalid-exception"),u=e("./exceptions/job-data-invalid-exception");function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.jobRepository=e,this.jobWorker=t,this.dataModelSerializer=n}var e,t,n;return e=o,(t=[{key:"run",value:function(e,t,n){var o,r,i=this,u=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return Promise.resolve().then(function(){if(!(o=s.Utils.isString(e)?i.jobRepository.getJobByName(e):e))throw new a.JobRestartException("No such job: "+e);return r=o.createJobParameters(t),i.validate(o,r,n)}).then(function(e){return i.jobRepository.createJobExecution(o.name,r,n).then(function(e){if(i.jobWorker)return s.log.debug("Job: ["+o.name+"] execution ["+e.id+"] delegated to worker"),i.jobWorker.executeJob(e.id),e;var t=i._execute(o,e);return u?e:t})})}},{key:"validate",value:function(t,n,o){return this.jobRepository.getLastJobExecution(t.name,n).then(function(e){if(null!=e){if(!t.isRestartable)throw new a.JobRestartException("JobInstance already exists and is not restartable");e.stepExecutions.forEach(function(e){if(e.status==i.JOB_STATUS.UNKNOWN)throw new a.JobRestartException("Step ["+e.stepName+"] is of status UNKNOWN")})}if(t.jobParametersValidator&&!t.jobParametersValidator.validate(n))throw new r.JobParametersInvalidException("Invalid job parameters in jobLauncher.run for job: "+t.name);if(t.jobDataValidator&&!t.jobDataValidator.validate(o))throw new u.JobDataInvalidException("Invalid job data in jobLauncher.run for job: "+t.name);return!0})}},{key:"execute",value:function(o){var r=this;return Promise.resolve().then(function(){return s.Utils.isString(o)?r.jobRepository.getJobExecutionById(o):o}).then(function(e){if(!e)throw new a.JobRestartException("JobExecution ["+o+"] is not found");if(e.status!==i.JOB_STATUS.STARTING)throw new a.JobRestartException("JobExecution ["+e.id+"] already started");var t=e.jobInstance.jobName,n=r.jobRepository.getJobByName(t);if(!n)throw new a.JobRestartException("No such job: "+t);return r._execute(n,e)})}},{key:"_execute",value:function(e,t){var n=e.name;return s.log.info("Job: ["+n+"] launched with the following parameters: ["+t.jobParameters+"]",t.getData()),e.execute(t).then(function(e){return s.log.info("Job: ["+n+"] completed with the following parameters: ["+e.jobParameters+"] and the following status: ["+e.status+"]"),e}).catch(function(e){throw s.log.error("Job: ["+n+"] failed unexpectedly and fatally with the following parameters: ["+t.jobParameters+"]",e),e})}}])&&c(e.prototype,t),n&&c(e,n),o}();n.JobLauncher=o},{"./exceptions/job-data-invalid-exception":34,"./exceptions/job-parameters-invalid-exception":38,"./exceptions/job-restart-exception":39,"./job-status":55,"sd-utils":"sd-utils"}],48:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobParameterDefinition=n.PARAMETER_TYPE=void 0;var s=e("sd-utils"),o=e("sd-expression-engine");function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var c={STRING:"STRING",DATE:"DATE",INTEGER:"INTEGER",NUMBER:"FLOAT",BOOLEAN:"BOOLEAN",NUMBER_EXPRESSION:"NUMBER_EXPRESSION",COMPOSITE:"COMPOSITE"};n.PARAMETER_TYPE=c;var i=function(){function a(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]&&arguments[4],i=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,u=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),this.nestedParameters=[],this.required=!0,this.name=e,s.Utils.isArray(t)?(this.type=c.COMPOSITE,this.nestedParameters=t):this.type=t,this.validator=u,this.singleValueValidator=i,this.identifying=r,this.minOccurs=n,this.maxOccurs=o}var e,t,n;return e=a,n=[{key:"computeNumberExpression",value:function(e){var t=parseFloat(e);return t===1/0||t===-1/0?t:o.ExpressionEngine.validate(e,{},!1)?o.ExpressionEngine.eval(e,!0):null}}],(t=[{key:"set",value:function(e,t){return this[e]=t,this}},{key:"validate",value:function(t,e){var n=this,o=s.Utils.isArray(t);return!(1<this.maxOccurs&&!o)&&(o?!(t.length<this.minOccurs||t.length>this.maxOccurs)&&(!!t.every(function(e){return n.validateSingleValue(e,t)})&&(!this.validator||this.validator(t,e))):this.validateSingleValue(t,e))}},{key:"validateSingleValue",value:function(n,e){if(!n&&0!==n&&!1!==n&&0<this.minOccurs)return!this.required;if(c.STRING===this.type&&!s.Utils.isString(n))return!1;if(c.DATE===this.type&&!s.Utils.isDate(n))return!1;if(c.INTEGER===this.type&&!s.Utils.isInt(n))return!1;if(c.NUMBER===this.type&&!s.Utils.isNumber(n))return!1;if(c.BOOLEAN===this.type&&!s.Utils.isBoolean(n))return!1;if(c.NUMBER_EXPRESSION===this.type&&null===(n=a.computeNumberExpression(n)))return!1;if(c.COMPOSITE===this.type){if(!s.Utils.isObject(n))return!1;if(!this.nestedParameters.every(function(e,t){return e.validate(n[e.name])}))return!1}return!this.singleValueValidator||this.singleValueValidator(n,e)}},{key:"value",value:function(e){return c.NUMBER_EXPRESSION===this.type?a.computeNumberExpression(e):e}}])&&r(e.prototype,t),n&&r(e,n),a}();n.JobParameterDefinition=i},{"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],49:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobParameters=void 0;e("./job-parameter-definition");var r=e("sd-utils");function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.definitions=[],this.values={},this.initDefinitions(),this.initDefaultValues(),e&&r.Utils.deepExtend(this.values,e)}var e,n,o;return e=t,(n=[{key:"initDefinitions",value:function(){}},{key:"initDefaultValues",value:function(){}},{key:"validate",value:function(){var n=this;return this.definitions.every(function(e,t){return e.validate(n.values[e.name],n.values)})}},{key:"getDefinition",value:function(e){var n=this.definitions,o=null;return e.split().every(function(t){return!!(o=r.Utils.find(n,function(e){return e.name==t}))&&(n=o.nestedParameters,!0)})?o:null}},{key:"value",value:function(e,t){if(1!==arguments.length)return r.Utils.set(this.values,e,t),t;var n=this.getDefinition(e),o=r.Utils.get(this.values,e,null);return n?n.value(o):o}},{key:"toString",value:function(){var o=this,r="JobParameters[";return this.definitions.forEach(function(e,t){var n=o.values[e.name];r+=e.name+"="+n+";"}),r+="]"}},{key:"getDTO",value:function(){return{values:this.values}}}])&&i(e.prototype,n),o&&i(e,o),t}();n.JobParameters=o},{"./job-parameter-definition":48,"sd-utils":"sd-utils"}],50:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.IdbJobRepository=void 0;var i=e("./job-repository"),u=e("idb"),f=e("sd-utils"),p=e("../job-execution"),a=e("../job-instance"),s=e("../step-execution"),c=e("../execution-context"),l=e("sd-model"),b=e("../job-result");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function h(e,t,n){return t&&d(e.prototype,t),n&&d(e,n),e}function m(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function v(e){return(v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var E=function(e){function r(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"sd-job-repository",o=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return y(this,r),(t=m(this,v(r).call(this))).dbName=n,t.expressionsReviver=e,o?t.deleteDB().then(function(){t.initDB()}).catch(function(e){f.log.error(e),t.initDB()}):t.initDB(),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&g(e,t)}(r,i.JobRepository),h(r,[{key:"initDB",value:function(){this.dbPromise=(0,u.openDb)(this.dbName,2,function(e){switch(e.oldVersion){case 0:e.createObjectStore("job-instances");var t=e.createObjectStore("job-executions");t.createIndex("jobInstanceId","jobInstance.id",{unique:!1}),t.createIndex("createTime","createTime",{unique:!1}),t.createIndex("status","status",{unique:!1}),e.createObjectStore("job-execution-progress"),e.createObjectStore("job-execution-flags"),e.createObjectStore("step-executions").createIndex("jobExecutionId","jobExecutionId",{unique:!1}),e.createObjectStore("job-results").createIndex("jobInstanceId","jobInstance.id",{unique:!0});case 1:e.transaction.objectStore("job-instances").createIndex("id","id",{unique:!0})}}),this.jobInstanceDao=new j("job-instances",this.dbPromise),this.jobExecutionDao=new j("job-executions",this.dbPromise),this.jobExecutionProgressDao=new j("job-execution-progress",this.dbPromise),this.jobExecutionFlagDao=new j("job-execution-flags",this.dbPromise),this.stepExecutionDao=new j("step-executions",this.dbPromise),this.jobResultDao=new j("job-results",this.dbPromise)}},{key:"deleteDB",value:function(){var t=this;return Promise.resolve().then(function(e){return(0,u.deleteDb)(t.dbName)})}},{key:"removeJobInstance",value:function(e,t){var n=this,o=this.generateJobInstanceKey(e.jobName,t);return this.jobInstanceDao.remove(o).then(function(){n.findJobExecutions(e,!1).then(function(e){e.forEach(n.removeJobExecution,n)}),n.getJobResultByInstance(e).then(function(e){return n.removeJobResult(e)})})}},{key:"removeJobExecution",value:function(e){var t=this;return this.jobExecutionDao.remove(e.id).then(function(){return t.findStepExecutions(e.id,!1).then(function(e){e.forEach(t.removeStepExecution,t)})})}},{key:"removeStepExecution",value:function(e){return this.stepExecutionDao.remove(e.id)}},{key:"removeJobResult",value:function(e){return this.jobResultDao.remove(e.id)}},{key:"getJobResult",value:function(e){var t=this,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.jobResultDao.get(e).then(function(e){return e&&n?t.reviveJobResult(e):e})}},{key:"getJobResultByInstance",value:function(e){var t=this,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.jobResultDao.getByIndex("jobInstanceId",e.id).then(function(e){return e&&n?t.reviveJobResult(e):e})}},{key:"getJobResultByExecution",value:function(t){var n=this,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.getJobResultByInstance(t.jobInstance,!1).then(function(e){return e&&o?n.reviveJobResult(e,t):e})}},{key:"saveJobResult",value:function(t){var e=t.getDTO();return this.jobResultDao.set(t.id,e).then(function(e){return t})}},{key:"getJobInstance",value:function(e,t){var n=this,o=this.generateJobInstanceKey(e,t);return this.jobInstanceDao.get(o).then(function(e){return e?n.reviveJobInstance(e):e})}},{key:"saveJobInstance",value:function(t,e){var n=this.generateJobInstanceKey(t.jobName,e);return this.jobInstanceDao.set(n,t).then(function(e){return t})}},{key:"saveJobExecution",value:function(t){var n=this,e=t.getDTO(),o=e.stepExecutions;return e.stepExecutions=null,this.jobExecutionDao.set(t.id,e).then(function(e){return n.saveStepExecutionsDTOS(o)}).then(function(e){return t})}},{key:"updateJobExecutionProgress",value:function(e,t){return this.jobExecutionProgressDao.set(e,t)}},{key:"getJobExecutionProgress",value:function(e){return this.jobExecutionProgressDao.get(e)}},{key:"saveJobExecutionFlag",value:function(e,t){return this.jobExecutionFlagDao.set(e,t)}},{key:"getJobExecutionFlag",value:function(e){return this.jobExecutionFlagDao.get(e)}},{key:"saveStepExecution",value:function(t){var e=t.getDTO(["jobExecution"]);return this.stepExecutionDao.set(t.id,e).then(function(e){return t})}},{key:"saveStepExecutionsDTOS",value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(e.length<=n.length)return Promise.resolve(n);var o=e[n.length];return this.stepExecutionDao.set(o.id,o).then(function(){return n.push(o),t.saveStepExecutionsDTOS(e,n)})}},{key:"getJobExecutionById",value:function(e){var t=this;return this.jobExecutionDao.get(e).then(function(e){return t.fetchJobExecutionRelations(e)})}},{key:"fetchJobExecutionRelations",value:function(t){var n=this,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return t?this.findStepExecutions(t.id,!1).then(function(e){return t.stepExecutions=e,o?n.reviveJobExecution(t):t}):Promise.resolve(null)}},{key:"fetchJobExecutionsRelations",value:function(t){var n=this,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return t.length<=r.length?Promise.resolve(r):this.fetchJobExecutionRelations(t[r.length],o).then(function(e){return r.push(e),n.fetchJobExecutionsRelations(t,o,r)})}},{key:"findStepExecutions",value:function(e){var t=this,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.stepExecutionDao.getAllByIndex("jobExecutionId",e).then(function(e){return n?e.map(function(e){return t.reviveStepExecution(e)}):e})}},{key:"findJobExecutions",value:function(e){var n=this,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.jobExecutionDao.getAllByIndex("jobInstanceId",e.id).then(function(e){var t=e.sort(function(e,t){return e.createTime.getTime()-t.createTime.getTime()});return o?n.fetchJobExecutionsRelations(t,!0):t})}},{key:"getLastJobExecutionByInstance",value:function(e){var n=this,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.findJobExecutions(e,!1).then(function(e){var t=e[e.length-1];if(!o)return t;n.fetchJobExecutionRelations(t)})}},{key:"getLastStepExecution",value:function(e,o){return this.findJobExecutions(e).then(function(e){var t=[];e.forEach(function(e){return e.stepExecutions.filter(function(e){return e.stepName===o}).forEach(function(e){return t.push(e)})});var n=null;return t.forEach(function(e){(null==n||n.startTime.getTime()<e.startTime.getTime())&&(n=e)}),n})}},{key:"reviveJobInstance",value:function(e){return new a.JobInstance(e.id,e.jobName)}},{key:"reviveExecutionContext",value:function(e){var t=new c.ExecutionContext;t.context=e.context;var n=t.getData();if(n){var o=new l.DataModel;o.loadFromDTO(n,this.expressionsReviver),t.setData(null),this.reviveFromDTO(t.context,e.context,o),t.setData(o)}return t}},{key:"reviveFromDTO",value:function(e,t,o){return f.Utils.mergeWith(e,t,function(e,t,n){if(t&&t.$ObjectWithIdAndEditableFields&&t.id)return o.findById(t.id)||e})}},{key:"reviveJobExecution",value:function(e){var u=this,t=this.getJobByName(e.jobInstance.jobName),a=this.reviveJobInstance(e.jobInstance),s=t.createJobParameters(e.jobParameters.values),c=new p.JobExecution(a,s,e.id),l=this.reviveExecutionContext(e.executionContext);return f.Utils.mergeWith(c,e,function(e,t,n,o,r,i){return"jobInstance"===n?a:"executionContext"===n?l:"jobParameters"===n?s:"jobExecution"===n?c:"stepExecutions"===n?t.map(function(e){return u.reviveStepExecution(e,c)}):void 0})}},{key:"reviveStepExecution",value:function(e,u){var t=new s.StepExecution(e.stepName,u,e.id),a=this.reviveExecutionContext(e.executionContext);return f.Utils.mergeWith(t,e,function(e,t,n,o,r,i){return"jobExecution"===n?u:"executionContext"===n?a:void 0})}},{key:"reviveJobResult",value:function(t){var n=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,o=this.getJobByName(t.jobInstance.jobName),r=this.reviveJobInstance(t.jobInstance);return(null!=e?Promise.resolve(e.executionContext):this.getLastJobExecutionByInstance(r,!1).then(function(e){return n.reviveExecutionContext(e.executionContext)})).then(function(e){return o.reviveResultData(n.reviveFromDTO({},t.data,e.getData()),e)}).then(function(e){return new b.JobResult(r,t.id,e)})}}]),r}();n.IdbJobRepository=E;var j=function(){function n(e,t){y(this,n),this.name=e,this.dbPromise=t}return h(n,[{key:"get",value:function(t){var n=this;return this.dbPromise.then(function(e){return e.transaction(n.name).objectStore(n.name).get(t)})}},{key:"getAllByIndex",value:function(t,n){var o=this;return this.dbPromise.then(function(e){return e.transaction(o.name).objectStore(o.name).index(t).getAll(n)})}},{key:"getByIndex",value:function(t,n){var o=this;return this.dbPromise.then(function(e){return e.transaction(o.name).objectStore(o.name).index(t).get(n)})}},{key:"set",value:function(n,o){var r=this;return this.dbPromise.then(function(e){var t=e.transaction(r.name,"readwrite");return t.objectStore(r.name).put(o,n),t.complete})}},{key:"remove",value:function(n){var o=this;return this.dbPromise.then(function(e){var t=e.transaction(o.name,"readwrite");return t.objectStore(o.name).delete(n),t.complete})}},{key:"clear",value:function(){var n=this;return this.dbPromise.then(function(e){var t=e.transaction(n.name,"readwrite");return t.objectStore(n.name).clear(),t.complete})}},{key:"keys",value:function(){var r=this;return this.dbPromise.then(function(e){var t=e.transaction(r.name),n=[],o=t.objectStore(r.name);return(o.iterateKeyCursor||o.iterateCursor).call(o,function(e){e&&(n.push(e.key),e.continue())}),t.complete.then(function(){return n})})}}]),n}()},{"../execution-context":40,"../job-execution":44,"../job-instance":45,"../job-result":54,"../step-execution":59,"./job-repository":51,idb:1,"sd-model":"sd-model","sd-utils":"sd-utils"}],51:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobRepository=void 0;var r=e("../job-key-generator"),i=e("../job-instance"),u=e("sd-utils"),a=e("../job-execution"),s=e("../exceptions/job-execution-already-running-exception"),c=e("../job-status"),l=e("../exceptions/job-instance-already-complete-exception"),f=e("../execution-context"),p=e("../step-execution"),b=e("sd-model"),y=e("../job-result");function d(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.jobByName={}}var t,n,o;return t=e,(n=[{key:"registerJob",value:function(e){this.jobByName[e.name]=e}},{key:"getJobByName",value:function(e){return this.jobByName[e]}},{key:"getJobInstance",value:function(e,t){throw"JobRepository getJobInstance function not implemented!"}},{key:"saveJobInstance",value:function(e,t){throw"JobRepository.saveJobInstance function not implemented!"}},{key:"getJobExecutionById",value:function(e){throw"JobRepository.getJobExecutionById function not implemented!"}},{key:"saveJobExecution",value:function(e){throw"JobRepository.saveJobInstance function not implemented!"}},{key:"updateJobExecutionProgress",value:function(e,t){throw"JobRepository.saveJobInstance function not implemented!"}},{key:"getJobExecutionProgress",value:function(e){throw"JobRepository.getJobExecutionProgress function not implemented!"}},{key:"saveJobExecutionFlag",value:function(e,t){throw"JobRepository.saveJobExecutionFlag function not implemented!"}},{key:"getJobExecutionFlag",value:function(e){throw"JobRepository.getJobExecutionFlag function not implemented!"}},{key:"saveStepExecution",value:function(e){throw"JobRepository.saveStepExecution function not implemented!"}},{key:"findJobExecutions",value:function(e){throw"JobRepository.findJobExecutions function not implemented!"}},{key:"getJobResult",value:function(e){throw"JobRepository.getJobResult function not implemented!"}},{key:"getJobResultByInstance",value:function(e){throw"JobRepository.getJobResultByInstance function not implemented!"}},{key:"getJobResultByExecution",value:function(e){throw"JobRepository.getJobResultByExecution function not implemented!"}},{key:"saveJobResult",value:function(e){throw"JobRepository.setJobResult function not implemented!"}},{key:"removeJobInstance",value:function(e,t){throw"JobRepository.removeJobInstance function not implemented!"}},{key:"removeJobExecution",value:function(e){throw"JobRepository.removeJobExecution function not implemented!"}},{key:"removeStepExecution",value:function(e){throw"JobRepository.removeStepExecution function not implemented!"}},{key:"removeJobResult",value:function(e){throw"JobRepository.removeJobResult function not implemented!"}},{key:"createJobInstance",value:function(e,t){var n=new i.JobInstance(u.Utils.guid(),e);return this.saveJobInstance(n,t)}},{key:"isJobInstanceExists",value:function(e,t){return this.getJobInstance(e,t).then(function(e){return!!e}).catch(function(e){return!1})}},{key:"generateJobInstanceKey",value:function(e,t){return e+"|"+r.JobKeyGenerator.generateKey(t)}},{key:"createJobExecution",value:function(o,r,i){var u=this;return this.getJobInstance(o,r).then(function(n){if(null!=n)return u.findJobExecutions(n).then(function(e){e.forEach(function(e){if(e.isRunning())throw new s.JobExecutionAlreadyRunningException("A job execution for this job is already running: "+n.jobName);if(e.status==c.JOB_STATUS.COMPLETED||e.status==c.JOB_STATUS.ABANDONED)throw new l.JobInstanceAlreadyCompleteException("A job instance already exists and is complete for parameters="+r+".  If you want to run this job again, change the parameters.")});var t=e[e.length-1].executionContext;return[n,t]});n=u.createJobInstance(o,r);var e=new f.ExecutionContext,t=new b.DataModel;return t._setNewState(i.createStateSnapshot()),e.setData(t),Promise.all([n,e])}).then(function(e){var t=new a.JobExecution(e[0],r);return t.executionContext=e[1],t.lastUpdated=new Date,u.saveJobExecution(t)}).catch(function(e){throw e})}},{key:"getLastJobExecution",value:function(e,t){var n=this;return this.getJobInstance(e,t).then(function(e){return e?n.getLastJobExecutionByInstance(e):null})}},{key:"getLastJobExecutionByInstance",value:function(e){return this.findJobExecutions(e).then(function(e){return e[e.length-1]})}},{key:"getLastStepExecution",value:function(e,o){return this.findJobExecutions(e).then(function(e){var t=[];e.forEach(function(e){return e.stepExecutions.filter(function(e){return e.stepName===o}).forEach(function(e){return t.push(e)})});var n=null;return t.forEach(function(e){(null==n||n.startTime.getTime()<e.startTime.getTime())&&(n=e)}),n})}},{key:"addStepExecution",value:function(e){return e.lastUpdated=new Date,this.saveStepExecution(e)}},{key:"update",value:function(e){if(e.lastUpdated=new Date,e instanceof a.JobExecution)return this.saveJobExecution(e);if(e instanceof p.StepExecution)return this.saveStepExecution(e);throw"Object not updatable: "+e}},{key:"remove",value:function(e){return e instanceof a.JobExecution?this.removeJobExecution(e):e instanceof p.StepExecution?this.removeStepExecution(e):e instanceof y.JobResult?this.removeJobResult():Promise.reject("Object not removable: "+e)}},{key:"reviveJobInstance",value:function(e){return e}},{key:"reviveExecutionContext",value:function(e){return e}},{key:"reviveJobExecution",value:function(e){return e}},{key:"reviveStepExecution",value:function(e,t){return e}}])&&d(t.prototype,n),o&&d(t,o),e}();n.JobRepository=o},{"../exceptions/job-execution-already-running-exception":35,"../exceptions/job-instance-already-complete-exception":36,"../execution-context":40,"../job-execution":44,"../job-instance":45,"../job-key-generator":46,"../job-result":54,"../job-status":55,"../step-execution":59,"sd-model":"sd-model","sd-utils":"sd-utils"}],52:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.SimpleJobRepository=void 0;var r=e("./job-repository"),i=e("sd-utils");function u(e){return(u="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==u(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=function(e){function u(){var e,t,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u);for(var o=arguments.length,r=new Array(o),i=0;i<o;i++)r[i]=arguments[i];return s(n,(t=n=s(this,(e=c(u)).call.apply(e,[this].concat(r))),n.jobInstancesByKey={},n.jobExecutions=[],n.stepExecutions=[],n.executionProgress={},n.executionFlags={},n.jobResults=[],t))}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(u,r.JobRepository),t=u,(n=[{key:"removeJobInstance",value:function(n){var o=this;return i.Utils.forOwn(this.jobInstancesByKey,function(e,t){e===n&&delete o.jobInstancesByKey[t]}),this.jobExecutions.filter(function(e){return e.jobInstance.id==n.id}).reverse().forEach(this.removeJobExecution,this),this.jobResults.filter(function(e){return e.jobInstance.id==n.id}).reverse().forEach(this.removeJobResult,this),Promise.resolve()}},{key:"removeJobExecution",value:function(t){var e=this.jobExecutions.indexOf(t);return-1<e&&this.jobExecutions.splice(e,1),this.stepExecutions.filter(function(e){return e.jobExecution.id===t.id}).reverse().forEach(this.removeStepExecution,this),Promise.resolve()}},{key:"removeStepExecution",value:function(e){var t=this.stepExecutions.indexOf(e);return-1<t&&this.stepExecutions.splice(t,1),Promise.resolve()}},{key:"removeJobResult",value:function(e){var t=this.jobResults.indexOf(e);return-1<t&&this.jobResults.splice(t,1),Promise.resolve()}},{key:"getJobInstance",value:function(e,t){var n=this.generateJobInstanceKey(e,t);return Promise.resolve(this.jobInstancesByKey[n])}},{key:"saveJobInstance",value:function(e,t){var n=this.generateJobInstanceKey(e.jobName,t);return this.jobInstancesByKey[n]=e,Promise.resolve(e)}},{key:"getJobResult",value:function(t){return Promise.resolve(i.Utils.find(this.jobResults,function(e){return e.id===t}))}},{key:"getJobResultByInstance",value:function(t){return Promise.resolve(i.Utils.find(this.jobResults,function(e){return e.jobInstance.id===t.id}))}},{key:"getJobResultByExecution",value:function(e){return this.getJobResultByInstance(e.jobInstance)}},{key:"saveJobResult",value:function(e){return this.jobResults.push(e),Promise.resolve(e)}},{key:"getJobExecutionById",value:function(t){return Promise.resolve(i.Utils.find(this.jobExecutions,function(e){return e.id===t}))}},{key:"saveJobExecution",value:function(e){return this.jobExecutions.push(e),Promise.resolve(e)}},{key:"updateJobExecutionProgress",value:function(e,t){return this.executionProgress[e]=t,Promise.resolve(t)}},{key:"getJobExecutionProgress",value:function(e){return Promise.resolve(this.executionProgress[e])}},{key:"saveJobExecutionFlag",value:function(e,t){return this.executionFlags[e]=t,Promise.resolve(t)}},{key:"getJobExecutionFlag",value:function(e){return Promise.resolve(this.executionFlags[e])}},{key:"saveStepExecution",value:function(e){return this.stepExecutions.push(e),Promise.resolve(e)}},{key:"findJobExecutions",value:function(t){return Promise.resolve(this.jobExecutions.filter(function(e){return e.jobInstance.id==t.id}).sort(function(e,t){return e.createTime.getTime()-t.createTime.getTime()}))}}])&&a(t.prototype,n),o&&a(t,o),u}();n.SimpleJobRepository=f},{"./job-repository":51,"sd-utils":"sd-utils"}],53:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.TimeoutJobRepository=void 0;e("./job-repository");var i=e("sd-utils"),u=e("./simple-job-repository");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(this,c(t).apply(this,arguments))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,u.SimpleJobRepository),n=t,(o=[{key:"createTimeoutPromise",value:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return new Promise(function(e){setTimeout(function(){e(t)},n)})}},{key:"getJobInstance",value:function(e,t){var n=this.generateJobInstanceKey(e,t);return this.createTimeoutPromise(this.jobInstancesByKey[n])}},{key:"saveJobInstance",value:function(e,t){var n=this.generateJobInstanceKey(e.jobName,t);return this.jobInstancesByKey[n]=e,this.createTimeoutPromise(e)}},{key:"getJobResult",value:function(t){return this.createTimeoutPromise(i.Utils.find(this.jobResults,function(e){return e.id===t}))}},{key:"getJobResultByInstance",value:function(t){return this.createTimeoutPromise(i.Utils.find(this.jobResults,function(e){return e.jobInstance.id===t.id}))}},{key:"getJobResultByExecution",value:function(e){return this.getJobResultByInstance(e.jobInstance)}},{key:"saveJobResult",value:function(e){return this.jobResults.push(e),this.createTimeoutPromise(e)}},{key:"getJobExecutionById",value:function(t){return this.createTimeoutPromise(i.Utils.find(this.jobExecutions,function(e){return e.id===t}))}},{key:"saveJobExecution",value:function(e){return this.jobExecutions.push(e),this.createTimeoutPromise(e)}},{key:"updateJobExecutionProgress",value:function(e,t){return this.executionProgress[e]=t,this.createTimeoutPromise(t)}},{key:"getJobExecutionProgress",value:function(e){return this.createTimeoutPromise(this.executionProgress[e])}},{key:"saveJobExecutionFlag",value:function(e,t){return this.executionFlags[e]=t,this.createTimeoutPromise(t)}},{key:"getJobExecutionFlag",value:function(e){return this.createTimeoutPromise(this.executionFlags[e])}},{key:"saveStepExecution",value:function(e){return this.stepExecutions.push(e),this.createTimeoutPromise(e)}},{key:"findJobExecutions",value:function(t){return this.createTimeoutPromise(this.jobExecutions.filter(function(e){return e.jobInstance.id==t.id}).sort(function(e,t){return e.createTime.getTime()-t.createTime.getTime()}))}},{key:"remove",value:function(e){}}])&&a(n.prototype,o),r&&a(n,r),t}();n.TimeoutJobRepository=f},{"./job-repository":51,"./simple-job-repository":52,"sd-utils":"sd-utils"}],54:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JobResult=void 0;e("./job-status"),e("./step-execution");var i=e("sd-utils");e("./execution-context"),e("./job-execution");function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.lastUpdated=null,this.id=null==t?i.Utils.guid():t,this.jobInstance=e,this.data=n}var e,t,n;return e=o,(t=[{key:"getDTO",value:function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],t=i.Utils.cloneDeepWith;return e||(t=i.Utils.cloneWith),i.Utils.assign({},t(this,function(e,t,n,o){return-1<r.indexOf(t)?null:e&&e.$ObjectWithIdAndEditableFields&&e.id?{$ObjectWithIdAndEditableFields:!0,id:e.id}:e instanceof Error?i.Utils.getErrorDTO(e):void 0}))}}])&&r(e.prototype,t),n&&r(e,n),o}();n.JobResult=o},{"./execution-context":40,"./job-execution":44,"./job-status":55,"./step-execution":59,"sd-utils":"sd-utils"}],55:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.JOB_STATUS=void 0;n.JOB_STATUS={COMPLETED:"COMPLETED",STARTING:"STARTING",STARTED:"STARTED",STOPPING:"STOPPING",STOPPED:"STOPPED",FAILED:"FAILED",UNKNOWN:"UNKNOWN",ABANDONED:"ABANDONED",EXECUTING:"EXECUTING"}},{}],56:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Job=void 0;var i=e("sd-utils"),u=e("./job-status"),a=e("./exceptions/job-interrupted-exception"),s=e("./exceptions/job-parameters-invalid-exception"),c=e("./exceptions/job-data-invalid-exception"),o=e("./job-execution-flag"),l=e("./job-result");function f(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var r=function(){function r(e,t,n,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.steps=[],this.isRestartable=!0,this.executionListeners=[],this.name=e,this.jobParametersValidator=this.getJobParametersValidator(),this.jobDataValidator=this.getJobDataValidator(),this.jobRepository=t,this.expressionsEvaluator=n,this.objectiveRulesManager=o}var e,t,n;return e=r,(t=[{key:"setJobRepository",value:function(e){this.jobRepository=e}},{key:"execute",value:function(t){var n,o=this;return i.log.debug("Job execution starting: ",t),this.checkExecutionFlags(t).then(function(t){if(t.status===u.JOB_STATUS.STOPPING)return t.status=u.JOB_STATUS.STOPPED,t.exitStatus=u.JOB_STATUS.COMPLETED,i.log.debug("Job execution was stopped: "+t),t;if(o.jobParametersValidator&&!o.jobParametersValidator.validate(t.jobParameters))throw new s.JobParametersInvalidException("Invalid job parameters in job execute");if(o.jobDataValidator&&!o.jobDataValidator.validate(t.getData()))throw new c.JobDataInvalidException("Invalid job data in job execute");return t.startTime=new Date,Promise.all([o.updateStatus(t,u.JOB_STATUS.STARTED),o.getResult(t),o.updateProgress(t)]).then(function(e){return t=e[0],(n=e[1])||(n=new l.JobResult(t.jobInstance)),o.executionListeners.forEach(function(e){return e.beforeJob(t)}),o.doExecute(t,n)})}).then(function(e){return i.log.debug("Job execution complete: ",e),e}).catch(function(e){return e instanceof a.JobInterruptedException?(i.log.info("Encountered interruption executing job",e),t.status=u.JOB_STATUS.STOPPED,t.exitStatus=u.JOB_STATUS.STOPPED):(i.log.error("Encountered fatal error executing job",e),t.status=u.JOB_STATUS.FAILED,t.exitStatus=u.JOB_STATUS.FAILED),t.failureExceptions.push(e),t}).then(function(e){return n?o.jobRepository.saveJobResult(n).then(function(){return e}):e}).catch(function(e){return i.log.error("Encountered fatal error saving job results",e),e&&t.failureExceptions.push(e),t.status=u.JOB_STATUS.FAILED,t.exitStatus=u.JOB_STATUS.FAILED,t}).then(function(e){return e.endTime=new Date,Promise.all([o.jobRepository.update(e),o.updateProgress(e)]).then(function(e){return e[0]})}).then(function(t){try{o.executionListeners.forEach(function(e){return e.afterJob(t)})}catch(e){i.log.error("Exception encountered in afterStep callback",e)}return t})}},{key:"updateStatus",value:function(e,t){return e.status=t,this.jobRepository.update(e)}},{key:"updateProgress",value:function(e){return this.jobRepository.updateJobExecutionProgress(e.id,this.getProgress(e))}},{key:"doExecute",value:function(e,t){throw"doExecute function not implemented for job: "+this.name}},{key:"getJobParametersValidator",value:function(){return{validate:function(e){return e.validate()}}}},{key:"getJobDataValidator",value:function(){return{validate:function(e){return!0}}}},{key:"addStep",value:function(e){this.steps.push(e)}},{key:"createJobParameters",value:function(e){throw"createJobParameters function not implemented for job: "+this.name}},{key:"getProgress",value:function(e){return{total:1,current:e.status===u.JOB_STATUS.COMPLETED?1:0}}},{key:"registerExecutionListener",value:function(e){this.executionListeners.push(e)}},{key:"checkExecutionFlags",value:function(t){return this.jobRepository.getJobExecutionFlag(t.id).then(function(e){return o.JOB_EXECUTION_FLAG.STOP===e&&t.stop(),t})}},{key:"getResult",value:function(e){return this.jobRepository.getJobResultByExecution(e)}},{key:"reviveResultData",value:function(e,t){return e}},{key:"jobResultToCsvRows",value:function(e,t){throw"jobResultToCsvRows function not implemented for job: "+this.name}}])&&f(e.prototype,t),n&&f(e,n),r}();n.Job=r},{"./exceptions/job-data-invalid-exception":34,"./exceptions/job-interrupted-exception":37,"./exceptions/job-parameters-invalid-exception":38,"./job-execution-flag":42,"./job-result":54,"./job-status":55,"sd-utils":"sd-utils"}],57:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.SimpleJob=void 0;var l=e("sd-utils"),f=e("./job-status"),i=e("./job"),p=e("./execution-context"),u=e("./step"),b=e("./exceptions/job-interrupted-exception"),a=e("./exceptions/job-restart-exception");e("./job-execution-flag");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function y(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function d(e,t,n){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(o){var r=Object.getOwnPropertyDescriptor(o,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var v=function(e){function r(e,t,n,o){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),y(this,h(r).call(this,e,t,n,o))}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(r,i.Job),t=r,(n=[{key:"getStep",value:function(t){return l.Utils.find(this.steps,function(e){return e.name==t})}},{key:"doExecute",value:function(n,e){return this.handleNextStep(n,e).then(function(e){var t;null!=e&&(l.log.debug("Updating JobExecution status: ",e),n.status=e.status,n.exitStatus=e.exitStatus,(t=n.failureExceptions).push.apply(t,s(e.failureExceptions)));return n})}},{key:"handleNextStep",value:function(t,n){var o=this,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,i=0;if(e&&(i=this.steps.indexOf(e)+1),i>=this.steps.length)return Promise.resolve(r);var u=this.steps[i];return this.handleStep(u,t,n).then(function(e){return e.status!==f.JOB_STATUS.COMPLETED?e:o.handleNextStep(t,n,u,e)})}},{key:"handleStep",value:function(i,u,a){var s=this,c=u.jobInstance;return this.checkExecutionFlags(u).then(function(e){if(e.isStopping())throw new b.JobInterruptedException("JobExecution interrupted.");return s.jobRepository.getLastStepExecution(c,i.name)}).then(function(e){s.stepExecutionPartOfExistingJobExecution(u,e)&&(l.log.info("Duplicate step detected in execution of job. step: "+i.name+" jobName: ",c.jobName),e=null);var t=e;if(!s.shouldStart(t,u,i))return t;t=u.createStepExecution(i.name);var n=null!=e&&e.status===f.JOB_STATUS.COMPLETED,o=null!=e&&!n,r=n&&i.skipOnRestartIfCompleted;return o?(t.executionContext=e.executionContext,e.executionContext.containsKey("executed")&&t.executionContext.remove("executed")):t.executionContext=new p.ExecutionContext,r&&(t.exitStatus=f.JOB_STATUS.COMPLETED,t.status=f.JOB_STATUS.COMPLETED,t.executionContext.put("skipped",!0)),s.jobRepository.addStepExecution(t).then(function(e){return t=e,r?(l.log.info("Skipping completed step execution: ["+i.name+"]"),t):(l.log.info("Executing step: ["+i.name+"]"),i.execute(t,a))}).then(function(){return t.executionContext.put("executed",!0),t}).catch(function(t){return u.status=f.JOB_STATUS.FAILED,s.jobRepository.update(u).then(function(e){throw t})})}).then(function(e){return e.status!=f.JOB_STATUS.STOPPING&&e.status!=f.JOB_STATUS.STOPPED||(u.status=f.JOB_STATUS.STOPPING),s.updateProgress(u).then(function(){return e})})}},{key:"stepExecutionPartOfExistingJobExecution",value:function(e,t){return null!=t&&t.jobExecution.id==e.id}},{key:"shouldStart",value:function(e,t,n){var o;if((o=null==e?f.JOB_STATUS.STARTING:e.status)==f.JOB_STATUS.UNKNOWN)throw new a.JobRestartException("Cannot restart step from UNKNOWN status");return o!=f.JOB_STATUS.COMPLETED||n.isRestartable}},{key:"getProgress",value:function(e){var t=e.stepExecutions.length,n={total:this.steps.length,current:t};return t&&f.JOB_STATUS.COMPLETED!==e.stepExecutions[e.stepExecutions.length-1].status&&n.current--,n}},{key:"addStep",value:function(){if(1===arguments.length)return d(h(r.prototype),"addStep",this).call(this,arguments[0]);var e=new u.Step(arguments[0],this.jobRepository);return e.doExecute=arguments[1],d(h(r.prototype),"addStep",this).call(this,e)}}])&&c(t.prototype,n),o&&c(t,o),r}();n.SimpleJob=v},{"./exceptions/job-interrupted-exception":37,"./exceptions/job-restart-exception":39,"./execution-context":40,"./job":56,"./job-execution-flag":42,"./job-status":55,"./step":60,"sd-utils":"sd-utils"}],58:[function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.StepExecutionListener=void 0;var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,(n=[{key:"beforeStep",value:function(e){}},{key:"afterStep",value:function(e){}}])&&r(t.prototype,n),o&&r(t,o),e}();n.StepExecutionListener=o},{}],59:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.StepExecution=void 0;var u=e("sd-utils"),r=e("./execution-context"),i=e("./job-status"),a=e("./job-execution");function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.status=i.JOB_STATUS.STARTING,this.exitStatus=i.JOB_STATUS.EXECUTING,this.executionContext=new r.ExecutionContext,this.startTime=new Date,this.endTime=null,this.lastUpdated=null,this.terminateOnly=!1,this.failureExceptions=[],this.id=null==n?u.Utils.guid():n,this.stepName=e,this.jobExecution=t,this.jobExecutionId=t.id}var e,t,n;return e=o,(t=[{key:"getJobParameters",value:function(){return this.jobExecution.jobParameters}},{key:"getJobExecutionContext",value:function(){return this.jobExecution.executionContext}},{key:"getData",value:function(){return this.jobExecution.getData()}},{key:"getDTO",value:function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],e=u.Utils.cloneDeepWith;return i||(e=u.Utils.cloneWith),u.Utils.assign({},e(this,function(e,t,n,o){return-1<r.indexOf(t)?null:-1<["executionContext"].indexOf(t)?e.getDTO():e instanceof Error?u.Utils.getErrorDTO(e):e instanceof a.JobExecution?e.getDTO(["stepExecutions"],i):void 0}))}}])&&s(e.prototype,t),n&&s(e,n),o}();n.StepExecution=o},{"./execution-context":40,"./job-execution":44,"./job-status":55,"sd-utils":"sd-utils"}],60:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Step=void 0;var r=e("./job-status"),i=e("sd-utils"),u=e("./exceptions/job-interrupted-exception");function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function n(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.isRestartable=!0,this.skipOnRestartIfCompleted=!0,this.steps=[],this.executionListeners=[],this.name=e,this.jobRepository=t}var e,t,o;return e=n,(t=[{key:"setJobRepository",value:function(e){this.jobRepository=e}},{key:"execute",value:function(t,e){var n,o=this;return i.log.debug("Executing step: name="+this.name),t.startTime=new Date,t.status=r.JOB_STATUS.STARTED,this.jobRepository.update(t).then(function(t){return n=r.JOB_STATUS.EXECUTING,o.executionListeners.forEach(function(e){return e.beforeStep(t)}),o.open(t.executionContext),o.doExecute(t,e)}).then(function(e){if(n=(t=e).exitStatus,t.terminateOnly)throw new u.JobInterruptedException("JobExecution interrupted.");return t.status=r.JOB_STATUS.COMPLETED,i.log.debug("Step execution success: name="+o.name),t}).catch(function(e){return t.status=o.determineJobStatus(e),n=t.status,t.failureExceptions.push(e),t.status==r.JOB_STATUS.STOPPED?i.log.info("Encountered interruption executing step: "+o.name+" in job: "+t.jobExecution.jobInstance.jobName,e):i.log.error("Encountered an error executing step: "+o.name+" in job: "+t.jobExecution.jobInstance.jobName,e),t}).then(function(t){try{t.exitStatus=n,o.executionListeners.forEach(function(e){return e.afterStep(t)})}catch(e){i.log.error("Exception in afterStep callback in step "+o.name+" in job: "+t.jobExecution.jobInstance.jobName,e)}return t.endTime=new Date,t.exitStatus=n,o.jobRepository.update(t)}).then(function(t){try{o.close(t.executionContext)}catch(e){i.log.error("Exception while closing step execution resources in step: "+o.name+" in job: "+t.jobExecution.jobInstance.jobName,e),t.failureExceptions.push(e)}try{o.close(t.executionContext)}catch(e){i.log.error("Exception while closing step execution resources in step: "+o.name+" in job: "+t.jobExecution.jobInstance.jobName,e),t.failureExceptions.push(e)}return i.log.debug("Step execution complete: "+t.id),t})}},{key:"determineJobStatus",value:function(e){return e instanceof u.JobInterruptedException?r.JOB_STATUS.STOPPED:r.JOB_STATUS.FAILED}},{key:"doExecute",value:function(e,t){}},{key:"open",value:function(e){}},{key:"close",value:function(e){}},{key:"getProgress",value:function(e){return{total:1,current:e.status===r.JOB_STATUS.COMPLETED?1:0}}}])&&a(e.prototype,t),o&&a(e,o),n}();n.Step=o},{"./exceptions/job-interrupted-exception":37,"./job-status":55,"sd-utils":"sd-utils"}],61:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o={engine:!0};n.engine=void 0;var r=function(e){if(e&&e.__esModule)return e;var t=a();if(t&&t.has(e))return t.get(e);var n={};if(null!=e){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=o?Object.getOwnPropertyDescriptor(e,r):null;i&&(i.get||i.set)?Object.defineProperty(n,r,i):n[r]=e[r]}}n.default=e,t&&t.set(e,n);return n}(e("./engine/index"));n.engine=r;var i=e("./jobs-manager");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}}))});var u=e("./job-worker");function a(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return a=function(){return e},e}Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}}))})},{"./engine/index":41,"./job-worker":63,"./jobs-manager":64}],62:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobInstanceManager=n.JobInstanceManagerConfig=void 0;var i=e("./engine/job-execution-listener"),u=e("./engine/job-status"),a=e("./engine/job-instance"),s=e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?p(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var d=function e(t){y(this,e),this.onJobStarted=function(){},this.onJobCompleted=function(e){},this.onJobFailed=function(e){},this.onJobStopped=function(){},this.onJobTerminated=function(){},this.onProgress=function(e){},this.updateInterval=100,t&&s.Utils.deepExtend(this,t)};n.JobInstanceManagerConfig=d;var h=function(e){function r(e,t,n){var o;return y(this,r),(o=l(this,f(r).call(this))).progress=null,o.config=new d(n),o.jobsManger=e,t instanceof a.JobInstance?(o.jobInstance=t,o.getLastJobExecution().then(function(e){o.checkProgress()})):(o.lastJobExecution=t,o.jobInstance=o.lastJobExecution.jobInstance,o.checkProgress()),o.lastJobExecution&&!o.lastJobExecution.isRunning()?(o.afterJob(o.lastJobExecution),l(o)):(e.registerJobExecutionListener(p(o)),o)}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}(r,i.JobExecutionListener),t=r,(n=[{key:"checkProgress",value:function(){var t=this,n=this;!this.terminated&&this.lastJobExecution.isRunning()&&100!==this.getProgressPercents(this.progress)&&this.jobsManger.getProgress(this.lastJobExecution).then(function(e){t.lastUpdateTime=new Date,e&&(t.progress=e,t.config.onProgress.call(t.config.callbacksThisArg||t,e)),setTimeout(function(){n.checkProgress()},t.config.updateInterval)})}},{key:"beforeJob",value:function(e){e.jobInstance.id===this.jobInstance.id&&(this.lastJobExecution=e,this.config.onJobStarted.call(this.config.callbacksThisArg||this))}},{key:"getProgressPercents",value:function(e){return e?100*e.current/e.total:0}},{key:"getProgressFromExecution",value:function(e){return this.jobsManger.getJobByName(e.jobInstance.jobName).getProgress(e)}},{key:"afterJob",value:function(e){var t=this;e.jobInstance.id===this.jobInstance.id&&(this.lastJobExecution=e,u.JOB_STATUS.COMPLETED===e.status?(this.jobsManger.deregisterJobExecutionListener(this),this.progress=this.getProgressFromExecution(e),this.config.onProgress.call(this.config.callbacksThisArg||this,this.progress),this.jobsManger.getResult(e).then(function(e){t.config.onJobCompleted.call(t.config.callbacksThisArg||t,e.data)}).catch(function(e){s.log.error(e)})):u.JOB_STATUS.FAILED===e.status?this.config.onJobFailed.call(this.config.callbacksThisArg||this,e.failureExceptions):u.JOB_STATUS.STOPPED===e.status&&this.config.onJobStopped.call(this.config.callbacksThisArg||this))}},{key:"getLastJobExecution",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return!this.lastJobExecution||e?this.jobsManger.jobRepository.getLastJobExecutionByInstance(this.jobInstance).then(function(e){return t.lastJobExecution=e}):Promise.resolve(this.lastJobExecution)}},{key:"stop",value:function(){var e=this;return this.getLastJobExecution().then(function(){return e.jobsManger.stop(e.lastJobExecution)})}},{key:"resume",value:function(){var t=this;return this.getLastJobExecution().then(function(){return t.jobsManger.run(t.jobInstance.jobName,t.lastJobExecution.jobParameters.values,t.lastJobExecution.getData()).then(function(e){return t.lastJobExecution=e,t.checkProgress(),!0}).catch(function(e){return s.log.error(e),!1})})}},{key:"terminate",value:function(){var e=this;return this.getLastJobExecution().then(function(){return e.jobsManger.terminate(e.jobInstance).then(function(){return e.terminated=!0,e.config.onJobTerminated.call(e.config.callbacksThisArg||e,e.lastJobExecution),e.jobsManger.deregisterJobExecutionListener(e),e.lastJobExecution})}).catch(function(e){return s.log.error(e),!1})}}])&&c(t.prototype,n),o&&c(t,o),r}();n.JobInstanceManager=h},{"./engine/job-execution-listener":43,"./engine/job-instance":45,"./engine/job-status":55,"sd-utils":"sd-utils"}],63:[function(e,t,n){"use strict";function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.JobWorker=void 0;var r=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.listeners={};var o=this;this.worker=new Worker(e),this.defaultListener=t||function(){},n&&(this.worker.onerror=n),this.worker.onmessage=function(e){if(e.data instanceof Object&&e.data.hasOwnProperty("queryMethodListener")&&e.data.hasOwnProperty("queryMethodArguments")){var t=o.listeners[e.data.queryMethodListener],n=e.data.queryMethodArguments;t.deserializer&&(n=t.deserializer(n)),t.fn.apply(t.thisArg,n)}else this.defaultListener.call(o,e.data)}}var e,t,n;return e=r,(t=[{key:"sendQuery",value:function(){if(arguments.length<1)throw new TypeError("JobWorker.sendQuery takes at least one argument");this.worker.postMessage({queryMethod:arguments[0],queryArguments:Array.prototype.slice.call(arguments,1)})}},{key:"runJob",value:function(e,t,n){this.sendQuery("runJob",e,t,n)}},{key:"executeJob",value:function(e){this.sendQuery("executeJob",e)}},{key:"recompute",value:function(e,t,n,o){this.sendQuery("recompute",e,t,n,o)}},{key:"postMessage",value:function(e){this.worker.postMessage(e)}},{key:"terminate",value:function(){this.worker.terminate()}},{key:"addListener",value:function(e,t,n,o){this.listeners[e]={fn:t,thisArg:n||this,deserializer:o}}},{key:"removeListener",value:function(e){delete this.listeners[e]}}])&&o(e.prototype,t),n&&o(e,n),r}();n.JobWorker=r},{}],64:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobsManager=n.JobsManagerConfig=void 0;var i=e("sd-utils"),u=e("./configurations/sensitivity-analysis/n-way/sensitivity-analysis-job"),a=e("./engine/job-launcher"),s=e("./job-worker"),c=e("./engine/job-execution-listener"),l=e("./engine/job-parameters"),f=e("./engine/job-repository/idb-job-repository"),p=e("./engine/job-execution-flag"),b=e("./configurations/recompute/recompute-job"),y=e("./configurations/sensitivity-analysis/probabilistic/probabilistic-sensitivity-analysis-job"),d=e("./engine/job-repository/timeout-job-repository"),h=e("./configurations/sensitivity-analysis/tornado-diagram/tornado-diagram-job"),m=e("./engine/job-status"),v=e("./engine/job-repository/simple-job-repository"),g=e("./configurations/league-table/league-table-job"),E=e("./configurations/sensitivity-analysis/spider-plot/spider-plot-job"),j=e("./configurations/payoffs-transformation/payoffs-transformation-job");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function x(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function P(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function O(e){return(O=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _=function e(t){w(this,e),this.workerUrl=null,this.repositoryType="idb",this.clearRepository=!1,t&&i.Utils.deepExtend(this,t)};n.JobsManagerConfig=_;var T=function(e){function r(e,t,n){var o;return w(this,r),(o=P(this,O(r).call(this))).jobExecutionListeners=[],o.afterJobExecutionPromiseResolves={},o.jobInstancesToTerminate={},o.setConfig(n),o.expressionEngine=e.expressionEngine,o.expressionsEvaluator=e,o.objectiveRulesManager=t,o.useWorker=!!o.config.workerUrl,o.useWorker&&o.initWorker(o.config.workerUrl),o.initRepository(),o.registerJobs(),o.jobLauncher=new a.JobLauncher(o.jobRepository,o.jobWorker,function(e){return o.serializeData(e)}),o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&S(e,t)}(r,c.JobExecutionListener),t=r,(n=[{key:"setConfig",value:function(e){return this.config=new _(e),this}},{key:"initRepository",value:function(){switch(this.config.repositoryType){case"idb":this.jobRepository=new f.IdbJobRepository(this.expressionEngine.getJsonReviver(),"sd-job-repository",this.config.clearRepository);break;case"timeout":this.jobRepository=new d.TimeoutJobRepository(this.expressionEngine.getJsonReviver());break;case"simple":this.jobRepository=new v.SimpleJobRepository(this.expressionEngine.getJsonReviver());break;default:i.log.error("JobsManager configuration error! Unknown repository type: "+this.config.repositoryType+". Using default: idb"),this.config.repositoryType="idb",this.initRepository()}}},{key:"serializeData",value:function(e){return e.serialize(!0,!1,!1,this.expressionEngine.getJsonReplacer())}},{key:"getProgress",value:function(e){var t=e;return i.Utils.isString(e)||(t=e.id),this.jobRepository.getJobExecutionProgress(t)}},{key:"getResult",value:function(e){var t=e;return e.jobInstance&&(t=e.jobInstance),this.jobRepository.getJobResultByInstance(t)}},{key:"run",value:function(e,t,n){var o=this,r=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return this.jobLauncher.run(e,t,n,r).then(function(n){return r||!n.isRunning()?n:new Promise(function(e,t){o.afterJobExecutionPromiseResolves[n.id]=e})})}},{key:"execute",value:function(e){return this.jobLauncher.execute(e)}},{key:"stop",value:function(t){var n=this,e=t;return i.Utils.isString(t)||(e=t.id),this.jobRepository.getJobExecutionById(e).then(function(e){return e?e.isRunning()?n.jobRepository.saveJobExecutionFlag(e.id,p.JOB_EXECUTION_FLAG.STOP).then(function(){return e}):(i.log.warn("Job Execution not running, status: "+e.status+", endTime: "+e.endTime),e):(i.log.error("Job Execution not found: "+t),null)})}},{key:"terminate",value:function(t){var n=this;return this.jobRepository.getLastJobExecutionByInstance(t).then(function(e){if(e)return e.isRunning()?n.jobRepository.saveJobExecutionFlag(e.id,p.JOB_EXECUTION_FLAG.STOP).then(function(){return e}):n.jobRepository.removeJobInstance(t,e.jobParameters)}).then(function(){n.jobInstancesToTerminate[t.id]=t})}},{key:"getJobByName",value:function(e){return this.jobRepository.getJobByName(e)}},{key:"createJobParameters",value:function(e,t){return this.jobRepository.getJobByName(e).createJobParameters(t)}},{key:"getLastJobExecution",value:function(e,t){return this.useWorker?this.jobWorker:(t instanceof l.JobParameters||(t=this.createJobParameters(t)),this.jobRepository.getLastJobExecution(e,t))}},{key:"initWorker",value:function(e){var t=arguments,n=this;this.jobWorker=new s.JobWorker(e,function(){i.log.error("error in worker",t)});var o=function(e){return[n.jobRepository.reviveJobExecution(e[0])]};this.jobWorker.addListener("beforeJob",this.beforeJob,this,o),this.jobWorker.addListener("afterJob",this.afterJob,this,o),this.jobWorker.addListener("jobFatalError",this.onJobFatalError,this)}},{key:"registerJobs",value:function(){var e=new u.SensitivityAnalysisJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager),t=new y.ProbabilisticSensitivityAnalysisJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager);i.Utils.isWorker()||(e.setBatchSize(1),t.setBatchSize(1)),this.registerJob(e),this.registerJob(new h.TornadoDiagramJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager)),this.registerJob(t),this.registerJob(new b.RecomputeJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager)),this.registerJob(new g.LeagueTableJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager)),this.registerJob(new E.SpiderPlotJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager)),this.registerJob(new j.PayoffsTransformationJob(this.jobRepository,this.expressionsEvaluator,this.objectiveRulesManager))}},{key:"registerJob",value:function(e){this.jobRepository.registerJob(e),e.registerExecutionListener(this)}},{key:"registerJobExecutionListener",value:function(e){this.jobExecutionListeners.push(e)}},{key:"deregisterJobExecutionListener",value:function(e){var t=this.jobExecutionListeners.indexOf(e);-1<t&&this.jobExecutionListeners.splice(t,1)}},{key:"beforeJob",value:function(t){i.log.debug("beforeJob",this.useWorker,t),this.jobExecutionListeners.forEach(function(e){return e.beforeJob(t)})}},{key:"afterJob",value:function(t){i.log.debug("afterJob",this.useWorker,t),this.jobExecutionListeners.forEach(function(e){return e.afterJob(t)});var e=this.afterJobExecutionPromiseResolves[t.id];e&&e(t),this.jobInstancesToTerminate[t.jobInstance.id]&&this.jobRepository.removeJobInstance(t.jobInstance,t.jobParameters)}},{key:"onJobFatalError",value:function(e,t){var n=this,o=this.afterJobExecutionPromiseResolves[e];o&&this.jobRepository.getJobExecutionById(e).then(function(e){return e.status=m.JOB_STATUS.FAILED,t&&e.failureExceptions.push(t),n.jobRepository.saveJobExecution(e).then(function(){o(e)})}).catch(function(e){i.log.error(e)}),i.log.debug("onJobFatalError",e,t)}}])&&x(t.prototype,n),o&&x(t,o),r}();n.JobsManager=T},{"./configurations/league-table/league-table-job":8,"./configurations/payoffs-transformation/payoffs-transformation-job":11,"./configurations/recompute/recompute-job":13,"./configurations/sensitivity-analysis/n-way/sensitivity-analysis-job":15,"./configurations/sensitivity-analysis/probabilistic/probabilistic-sensitivity-analysis-job":20,"./configurations/sensitivity-analysis/spider-plot/spider-plot-job":24,"./configurations/sensitivity-analysis/tornado-diagram/tornado-diagram-job":29,"./engine/job-execution-flag":42,"./engine/job-execution-listener":43,"./engine/job-launcher":47,"./engine/job-parameters":49,"./engine/job-repository/idb-job-repository":50,"./engine/job-repository/simple-job-repository":52,"./engine/job-repository/timeout-job-repository":53,"./engine/job-status":55,"./job-worker":63,"sd-utils":"sd-utils"}],65:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ObjectiveRulesManager=void 0;var a=e("./rules"),s=e("sd-utils"),o=function(e){if(e&&e.__esModule)return e;var t=u();if(t&&t.has(e))return t.get(e);var n={};if(null!=e){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=o?Object.getOwnPropertyDescriptor(e,r):null;i&&(i.get||i.set)?Object.defineProperty(n,r,i):n[r]=e[r]}}n.default=e,t&&t.set(e,n);return n}(e("sd-model")),c=e("./rules/min-max-rule"),l=e("./rules/max-min-rule"),f=e("./rules/min-min-rule"),p=e("./rules/max-max-rule");function u(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return u=function(){return e},e}function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var i=function(){function u(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),this.ruleByName={},this.rules=[],this.flipPair={},this.payoffIndex=0,this.expressionEngine=e,this.addRule(new a.ExpectedValueMaximizationRule(e)),this.addRule(new a.ExpectedValueMinimizationRule(e)),this.addRule(new a.MaxiMinRule(e)),this.addRule(new a.MaxiMaxRule(e)),this.addRule(new a.MiniMinRule(e)),this.addRule(new a.MiniMaxRule(e));var n=new c.MinMaxRule(e);this.addRule(n);var o=new l.MaxMinRule(e);this.addRule(o),this.addFlipPair(n,o);var r=new f.MinMinRule(e);this.addRule(r);var i=new p.MaxMaxRule(e);this.addRule(i),this.currentRule=t?this.ruleByName[t]:this.rules[0]}var e,t,n;return e=u,(t=[{key:"setPayoffIndex",value:function(e){this.payoffIndex=e||0}},{key:"addRule",value:function(e){this.ruleByName[e.name]=e,this.rules.push(e)}},{key:"isRuleName",value:function(e){return!!this.ruleByName[e]}},{key:"setCurrentRuleByName",value:function(e){this.currentRule=this.ruleByName[e]}},{key:"getObjectiveRuleByName",value:function(e){return this.ruleByName[e]}},{key:"flipRule",value:function(){var e=this.flipPair[this.currentRule.name];e&&(this.currentRule=e)}},{key:"updateDefaultCriterion1Weight",value:function(t){this.rules.filter(function(e){return e.multiCriteria}).forEach(function(e){return e.setDefaultCriterion1Weight(t)})}},{key:"recompute",value:function(e,t){var n=this,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=(new Date).getTime();s.log.trace("recomputing rules, all: "+t),e.getRoots().forEach(function(e){n.recomputeTree(e,t,o)});var i=(new Date).getTime()-r/1e3;return s.log.trace("recomputation took "+i+"s"),this}},{key:"recomputeTree",value:function(t,e){var n=this,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;s.log.trace("recomputing rules for tree ...",t);var r=(new Date).getTime(),i=[this.currentRule];e&&(i=this.rules),i.forEach(function(e){e.setPayoffIndex(n.payoffIndex),e.setDecisionPolicy(o),e.computePayoff(t),e.computeOptimal(t),e.clearDecisionPolicy()});var u=((new Date).getTime()-r)/1e3;return s.log.trace("recomputation took "+u+"s"),this}},{key:"getNodeDisplayValue",value:function(e,t){return e.computedValue(this.currentRule.name,t)}},{key:"getEdgeDisplayValue",value:function(e,t){return"probability"===t?e.parentNode instanceof o.domain.DecisionNode?e.computedValue(this.currentRule.name,"probability"):e.parentNode instanceof o.domain.ChanceNode?e.computedBaseProbability():null:"payoff"===t?this.currentRule.multiCriteria?e.computedValue(null,"payoff"):e.computedValue(null,"payoff["+this.payoffIndex+"]"):"optimal"===t?e.computedValue(this.currentRule.name,"optimal"):void 0}},{key:"addFlipPair",value:function(e,t){this.flipPair[e.name]=t,this.flipPair[t.name]=e}}])&&r(e.prototype,t),n&&r(e,n),u}();n.ObjectiveRulesManager=i},{"./rules":68,"./rules/max-max-rule":69,"./rules/max-min-rule":70,"./rules/min-max-rule":73,"./rules/min-min-rule":74,"sd-model":"sd-model","sd-utils":"sd-utils"}],66:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.ExpectedValueMaximizationRule=void 0;var i=e("sd-model"),u=e("./objective-rule");e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(this,c(t).call(this,t.NAME,!0,e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,u.ObjectiveRule),n=t,(o=[{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof i.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r),t.childEdges.forEach(function(e){!n.subtract(n.computedPayoff(t),o).equals(n.computedPayoff(e.childNode))&&t instanceof i.domain.DecisionNode?n.cValue(e,"optimal",!1):(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.basePayoff(e),n.multiply(r,n.cValue(e,"probability"))))})}}])&&a(n.prototype,o),r&&a(n,r),t}();(n.ExpectedValueMaximizationRule=f).NAME="expected-value-maximization"},{"./objective-rule":78,"sd-model":"sd-model","sd-utils":"sd-utils"}],67:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.ExpectedValueMinimizationRule=void 0;var i=e("sd-model"),u=e("./objective-rule");e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(this,c(t).call(this,t.NAME,!1,e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,u.ObjectiveRule),n=t,(o=[{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof i.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r),t.childEdges.forEach(function(e){!n.subtract(n.computedPayoff(t),o).equals(n.computedPayoff(e.childNode))&&t instanceof i.domain.DecisionNode?n.cValue(e,"optimal",!1):(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.basePayoff(e),n.multiply(r,n.cValue(e,"probability"))))})}}])&&a(n.prototype,o),r&&a(n,r),t}();(n.ExpectedValueMinimizationRule=f).NAME="expected-value-minimization"},{"./objective-rule":78,"sd-model":"sd-model","sd-utils":"sd-utils"}],68:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./objective-rule");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var r=e("./expected-value-maximization-rule");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var i=e("./expected-value-minimization-rule");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var u=e("./maxi-max-rule");Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return u[e]}})});var a=e("./maxi-min-rule");Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return a[e]}})});var s=e("./mini-max-rule");Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return s[e]}})});var c=e("./mini-min-rule");Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return c[e]}})})},{"./expected-value-maximization-rule":66,"./expected-value-minimization-rule":67,"./maxi-max-rule":71,"./maxi-min-rule":72,"./mini-max-rule":75,"./mini-min-rule":76,"./objective-rule":78}],69:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MaxMaxRule=void 0;var r=e("./multi-criteria-rule");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).call(this,t.NAME,[1,1],e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.MultiCriteriaRule),t}();(n.MaxMaxRule=c).NAME="max-max"},{"./multi-criteria-rule":77}],70:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MaxMinRule=void 0;var r=e("./multi-criteria-rule");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).call(this,t.NAME,[1,-1],e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.MultiCriteriaRule),t}();(n.MaxMinRule=c).NAME="max-min"},{"./multi-criteria-rule":77}],71:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MaxiMaxRule=void 0;var u=e("sd-model"),i=e("./objective-rule"),a=e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).call(this,t.NAME,!0,e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.ObjectiveRule),n=t,(o=[{key:"modifyChanceProbability",value:function(e,t,n,o,r){var i=this;e.forEach(function(e){i.clearComputedValues(e),i.cValue(e,"probability",i.computedPayoff(e.childNode)<t?0:1/n)})}},{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof u.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r);var i=null;t instanceof u.domain.ChanceNode&&(i=a.Utils.maxBy(t.childEdges,function(e){return n.computedPayoff(e.childNode)})),t.childEdges.forEach(function(e){(i?n.computedPayoff(i.childNode).equals(n.computedPayoff(e.childNode)):!(!n.subtract(n.computedPayoff(t),o).equals(n.computedPayoff(e.childNode))&&t instanceof u.domain.DecisionNode))?(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.basePayoff(e),n.multiply(r,n.cValue(e,"probability")))):n.cValue(e,"optimal",!1)})}}])&&s(n.prototype,o),r&&s(n,r),t}();(n.MaxiMaxRule=p).NAME="maxi-max"},{"./objective-rule":78,"sd-model":"sd-model","sd-utils":"sd-utils"}],72:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MaxiMinRule=void 0;var u=e("sd-model"),i=e("./objective-rule"),a=e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).call(this,t.NAME,!0,e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.ObjectiveRule),n=t,(o=[{key:"modifyChanceProbability",value:function(e,t,n,o,r){var i=this;e.forEach(function(e){i.clearComputedValues(e),i.cValue(e,"probability",i.computedPayoff(e.childNode)>o?0:1/r)})}},{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof u.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r);var i=null;t instanceof u.domain.ChanceNode&&(i=a.Utils.minBy(t.childEdges,function(e){return n.computedPayoff(e.childNode)})),t.childEdges.forEach(function(e){(i?n.computedPayoff(i.childNode).equals(n.computedPayoff(e.childNode)):!(!n.subtract(n.computedPayoff(t),o).equals(n.computedPayoff(e.childNode))&&t instanceof u.domain.DecisionNode))?(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.basePayoff(e),n.multiply(r,n.cValue(e,"probability")))):n.cValue(e,"optimal",!1)})}}])&&s(n.prototype,o),r&&s(n,r),t}();(n.MaxiMinRule=p).NAME="maxi-min"},{"./objective-rule":78,"sd-model":"sd-model","sd-utils":"sd-utils"}],73:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MinMaxRule=void 0;var r=e("./multi-criteria-rule");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).call(this,t.NAME,[-1,1],e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.MultiCriteriaRule),t}();(n.MinMaxRule=c).NAME="min-max"},{"./multi-criteria-rule":77}],74:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MinMinRule=void 0;var r=e("./multi-criteria-rule");function i(e){return(i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,a(t).call(this,t.NAME,[-1,-1],e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,r.MultiCriteriaRule),t}();(n.MinMinRule=c).NAME="min-min"},{"./multi-criteria-rule":77}],75:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MiniMaxRule=void 0;var u=e("sd-model"),i=e("./objective-rule"),a=e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).call(this,t.NAME,!1,e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.ObjectiveRule),n=t,(o=[{key:"modifyChanceProbability",value:function(e,t,n,o,r){var i=this;e.forEach(function(e){i.clearComputedValues(e),i.cValue(e,"probability",i.computedPayoff(e.childNode)<t?0:1/n)})}},{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof u.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r);var i=null;t instanceof u.domain.ChanceNode&&(i=a.Utils.maxBy(t.childEdges,function(e){return n.computedPayoff(e.childNode)})),t.childEdges.forEach(function(e){(i?n.computedPayoff(i.childNode).equals(n.computedPayoff(e.childNode)):!(!n.subtract(n.computedPayoff(t),o).equals(n.computedPayoff(e.childNode))&&t instanceof u.domain.DecisionNode))?(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.basePayoff(e),n.multiply(r,n.cValue(e,"probability")))):n.cValue(e,"optimal",!1)})}}])&&s(n.prototype,o),r&&s(n,r),t}();(n.MiniMaxRule=p).NAME="mini-max"},{"./objective-rule":78,"sd-model":"sd-model","sd-utils":"sd-utils"}],76:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MiniMinRule=void 0;var u=e("sd-model"),i=e("./objective-rule"),a=e("sd-utils");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),c(this,l(t).call(this,t.NAME,!1,e))}var n,o,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,i.ObjectiveRule),n=t,(o=[{key:"modifyChanceProbability",value:function(e,t,n,o,r){var i=this;e.forEach(function(e){i.clearComputedValues(e),i.cValue(e,"probability",i.computedPayoff(e.childNode)>o?0:1/r)})}},{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof u.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r);var i=null;t instanceof u.domain.ChanceNode&&(i=a.Utils.minBy(t.childEdges,function(e){return n.computedPayoff(e.childNode)})),t.childEdges.forEach(function(e){(i?n.computedPayoff(i.childNode).equals(n.computedPayoff(e.childNode)):!(!n.subtract(n.computedPayoff(t),o).equals(n.computedPayoff(e.childNode))&&t instanceof u.domain.DecisionNode))?(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.basePayoff(e),n.multiply(r,n.cValue(e,"probability")))):n.cValue(e,"optimal",!1)})}}])&&s(n.prototype,o),r&&s(n,r),t}();(n.MiniMinRule=p).NAME="mini-min"},{"./objective-rule":78,"sd-model":"sd-model","sd-utils":"sd-utils"}],77:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MultiCriteriaRule=void 0;var l=e("sd-model"),i=e("./objective-rule"),f=e("../../policies/policy");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function a(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function r(e,t,n){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),(o=a(this,s(r).call(this,e,!0,n,!0))).criterion1Weight=1,o.payoffCoeffs=[1,-1],o.payoffCoeffs=t,o}var t,n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(r,i.ObjectiveRule),t=r,(n=[{key:"setDefaultCriterion1Weight",value:function(e){this.criterion1Weight=e}},{key:"computePayoff",value:function(e){var r=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[0,0],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[0,0],u=[0,0];if(e.childEdges.length){if(e instanceof l.domain.DecisionNode){var a=[],s=-1/0;if(e.childEdges.forEach(function(e,t){var n=[r.basePayoff(e,0),r.basePayoff(e,1)],o=(r.computePayoff(e.childNode,n,[r.add(n[0],i[0]),r.add(n[1],i[1])]),r.cValue(e.childNode,"combinedPayoff"));s<o?(s=o,a=[t]):s.equals(o)&&a.push(t)}),this.decisionPolicy){a=[];var t=f.Policy.getDecision(this.decisionPolicy,e);t&&(a=[t.decisionValue])}e.childEdges.forEach(function(e,t){r.clearComputedValues(e),r.cValue(e,"probability",a.indexOf(t)<0?0:1)})}else e.childEdges.forEach(function(e){var t=[r.basePayoff(e,0),r.basePayoff(e,1)];r.computePayoff(e.childNode,t,[r.add(t[0],i[0]),r.add(t[1],i[1])]),r.clearComputedValues(e),r.cValue(e,"probability",r.baseProbability(e))});var c=0;e.childEdges.forEach(function(e){c=r.add(c,r.cValue(e,"probability"))}),0<c&&e.childEdges.forEach(function(o){u.forEach(function(e,t){var n=r.cValue(o.childNode,"payoff["+t+"]");u[t]=r.add(e,r.multiply(r.cValue(o,"probability"),n).div(c))})})}return n.forEach(function(e,t){n[t]=r.add(e,u[t])}),this.clearComputedValues(e),e instanceof l.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff",i),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff",u),this.cValue(e,"combinedPayoff",this.computeCombinedPayoff(n)),this.cValue(e,"payoff",n)}},{key:"computeCombinedPayoff",value:function(e){return this.criterion1Weight===1/0?this.multiply(this.payoffCoeffs[0],e[0]):this.add(this.multiply(this.payoffCoeffs[0],this.multiply(this.criterion1Weight,e[0])),this.multiply(this.payoffCoeffs[1],e[1]))}},{key:"computeOptimal",value:function(t){var n=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this.cValue(t,"optimal",!0),t instanceof l.domain.TerminalNode&&this.cValue(t,"probabilityToEnter",r),t.childEdges.forEach(function(e){!n.subtract(n.cValue(t,"combinedPayoff"),o).equals(n.cValue(e.childNode,"combinedPayoff"))&&t instanceof l.domain.DecisionNode?n.cValue(e,"optimal",!1):(n.cValue(e,"optimal",!0),n.computeOptimal(e.childNode,n.computeCombinedPayoff([n.basePayoff(e,0),n.basePayoff(e,1)]),n.multiply(r,n.cValue(e,"probability"))))})}}])&&u(t.prototype,n),o&&u(t,o),r}();n.MultiCriteriaRule=p},{"../../policies/policy":86,"./objective-rule":78,"sd-model":"sd-model"}],78:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ObjectiveRule=void 0;var i=e("sd-expression-engine"),f=e("sd-model"),o=e("../../policies/policy");function u(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var r=function(){function r(e,t,n){var o=3<arguments.length&&void 0!==arguments[3]&&arguments[3];!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.payoffIndex=0,this.multiCriteria=!1,this.name=e,this.maximization=t,this.expressionEngine=n,this.multiCriteria=o}var e,t,n;return e=r,(t=[{key:"setDecisionPolicy",value:function(e){this.decisionPolicy=e}},{key:"setPayoffIndex",value:function(e){this.payoffIndex=e}},{key:"clearDecisionPolicy",value:function(){this.decisionPolicy=null}},{key:"makeDecision",value:function(e,t){var n;n=this.maximization?this.max.apply(this,u(t)):this.min.apply(this,u(t));var o=[];return t.forEach(function(e,t){0==i.ExpressionEngine.compare(n,e)&&o.push(t)}),o}},{key:"_makeDecision",value:function(e,t){if(this.decisionPolicy){var n=o.Policy.getDecision(this.decisionPolicy,e);return n?[n.decisionValue]:[]}return this.makeDecision(e,t)}},{key:"modifyChanceProbability",value:function(e,t,n,o,r){}},{key:"computePayoff",value:function(e){var n=this,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=0;if(e.childEdges.length){if(e instanceof f.domain.DecisionNode){var i=this._makeDecision(e,e.childEdges.map(function(e){return n.computePayoff(e.childNode,n.basePayoff(e),n.add(n.basePayoff(e),o))}));e.childEdges.forEach(function(e,t){n.clearComputedValues(e),n.cValue(e,"probability",i.indexOf(t)<0?0:1)})}else{var u=-1/0,a=1,s=1/0,c=1;e.childEdges.forEach(function(e){var t=n.computePayoff(e.childNode,n.basePayoff(e),n.add(n.basePayoff(e),o));t<s?(s=t,c=1):t.equals(s)&&c++,u<t?(u=t,a=1):t.equals(u)&&a++,n.clearComputedValues(e),n.cValue(e,"probability",n.baseProbability(e))}),this.modifyChanceProbability(e.childEdges,u,a,s,c)}var l=0;e.childEdges.forEach(function(e){l=n.add(l,n.cValue(e,"probability"))}),0<l&&e.childEdges.forEach(function(e){r=n.add(r,n.multiply(n.cValue(e,"probability"),n.computedPayoff(e.childNode)).div(l))})}return t=this.add(t,r),this.clearComputedValues(e),e instanceof f.domain.TerminalNode?(this.cValue(e,"aggregatedPayoff["+this.payoffIndex+"]",o),this.cValue(e,"probabilityToEnter",0)):this.cValue(e,"childrenPayoff["+this.payoffIndex+"]",r),this.computedPayoff(e,t)}},{key:"computeOptimal",value:function(e){throw"computeOptimal function not implemented for rule: "+this.name}},{key:"computedPayoff",value:function(e,t){return this.cValue(e,"payoff["+this.payoffIndex+"]",t)}},{key:"cValue",value:function(e,t,n){return e.computedValue(this.name,t,n)}},{key:"baseProbability",value:function(e){return e.computedBaseProbability()}},{key:"basePayoff",value:function(e,t){return e.computedBasePayoff(void 0,t||this.payoffIndex)}},{key:"clearComputedValues",value:function(e){e.clearComputedValues(this.name)}},{key:"add",value:function(e,t){return i.ExpressionEngine.add(e,t)}},{key:"subtract",value:function(e,t){return i.ExpressionEngine.subtract(e,t)}},{key:"divide",value:function(e,t){return i.ExpressionEngine.divide(e,t)}},{key:"multiply",value:function(e,t){return i.ExpressionEngine.multiply(e,t)}},{key:"max",value:function(){return i.ExpressionEngine.max.apply(i.ExpressionEngine,arguments)}},{key:"min",value:function(){return i.ExpressionEngine.min.apply(i.ExpressionEngine,arguments)}}])&&a(e.prototype,t),n&&a(e,n),r}();n.ObjectiveRule=r},{"../../policies/policy":86,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model"}],79:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.FlipSubtree=void 0;var E=e("sd-model"),j=e("sd-expression-engine"),i=e("sd-utils"),u=e("./operation"),a=e("../validation/tree-validator");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){function o(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(n=c(this,l(o).call(this,o.$NAME))).data=e,n.expressionEngine=t,n.treeValidator=new a.TreeValidator(t),n}var t,n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(o,u.Operation),t=o,(n=[{key:"isApplicable",value:function(e){return e instanceof E.domain.ChanceNode}},{key:"canPerform",value:function(e){if(!this.isApplicable(e))return!1;if(!this.treeValidator.validate(this.data.getAllNodesInSubtree(e)).isValid())return!1;if(e.childEdges.length<1)return!1;var n=null,o=[],r=new Set;return!!e.childEdges.every(function(e){var t=e.childNode;return t instanceof E.domain.ChanceNode&&(!r.has(e.name.trim())&&(r.add(e.name.trim()),null===n?!((n=t.childEdges.length)<1)&&(t.childEdges.forEach(function(e){o.push(e.name.trim())}),new Set(o).size===o.length):t.childEdges.length==n&&!!t.childEdges.every(function(e,t){return o[t]===e.name.trim()})))})}},{key:"perform",value:function(e){var t=this,n=this.data.cloneSubtree(e,!0),o=e.childEdges.length,r=e.childEdges[0].childNode.childEdges.length,i=r,u=o,a=this.data.callbacksDisabled;this.data.callbacksDisabled=!0;var s=e.childEdges[0].childNode.location.x,c=e.childEdges[0].childNode.childEdges[0].childNode.location.y,l=(e.childEdges[o-1].childNode.childEdges[r-1].childNode.location.y-c)/(i+1);e.childEdges.slice().forEach(function(e){return t.data.removeNode(e.childNode)});for(var f=0;f<i;f++){var p=new E.domain.ChanceNode(new E.domain.Point(s,c+(f+1)*l)),b=this.data.addNode(p,e);b.name=n.childEdges[0].childNode.childEdges[f].name;for(var y=b.probability=0;y<u;y++){var d=n.childEdges[y].childNode.childEdges[f].childNode,h=this.data.attachSubtree(d,p);h.name=n.childEdges[y].name,h.payoff=[j.ExpressionEngine.add(n.childEdges[y].computedBasePayoff(void 0,0),n.childEdges[y].childNode.childEdges[f].computedBasePayoff(void 0,0)),j.ExpressionEngine.add(n.childEdges[y].computedBasePayoff(void 0,1),n.childEdges[y].childNode.childEdges[f].computedBasePayoff(void 0,1))],h.probability=j.ExpressionEngine.multiply(n.childEdges[y].computedBaseProbability(),n.childEdges[y].childNode.childEdges[f].computedBaseProbability()),b.probability=j.ExpressionEngine.add(b.probability,h.probability)}var m=function(e){return j.ExpressionEngine.divide(e,b.probability)};if(b.probability.equals(0)){var v=j.ExpressionEngine.divide(1,u);m=function(e){return v}}var g=0;p.childEdges.forEach(function(e){e.probability=m(e.probability),g=j.ExpressionEngine.add(g,e.probability),e.probability=t.expressionEngine.serialize(e.probability)}),this._normalizeProbabilitiesAfterFlip(p.childEdges,g),b.probability=this.expressionEngine.serialize(b.probability)}this._normalizeProbabilitiesAfterFlip(e.childEdges),this.data.callbacksDisabled=a,this.data._fireNodeAddedCallback()}},{key:"_normalizeProbabilitiesAfterFlip",value:function(e,t){var n=this;if(t||(t=0,e.forEach(function(e){t=j.ExpressionEngine.add(t,e.probability)})),!t.equals(1)){i.log.info("Sum of the probabilities in child nodes is not equal to 1 : ",t);var o=0;e.forEach(function(e){e.probability=parseInt(1e12*j.ExpressionEngine.round(e.probability,12)),o+=e.probability});var r=1e12-o;i.log.info("Normalizing with rounding to precision: 12",r),e[0].probability=j.ExpressionEngine.add(r,e[0].probability),o=0,e.forEach(function(e){e.probability=n.expressionEngine.serialize(j.ExpressionEngine.divide(parseInt(e.probability),1e12))})}}}])&&s(t.prototype,n),r&&s(t,r),o}();(n.FlipSubtree=p).$NAME="flipSubtree"},{"../validation/tree-validator":90,"./operation":81,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model","sd-utils":"sd-utils"}],80:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.JobExecutingOperation=void 0;var i=e("./operation");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function a(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l=function(e){function o(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=a(this,s(o).call(this,e))).name=e,t.jobName=n,t}var t,n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(o,i.Operation),t=o,(n=[{key:"canPerform",value:function(e,t){throw"canPerform function not implemented for operation: "+this.name}},{key:"perform",value:function(e,t){}},{key:"postProcess",value:function(e,t){}}])&&u(t.prototype,n),r&&u(t,r),o}();n.JobExecutingOperation=l},{"./operation":81}],81:[function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.Operation=void 0;var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.name=e}var e,n,o;return e=t,(n=[{key:"isApplicable",value:function(e){throw"isApplicable function not implemented for operation: "+this.name}},{key:"canPerform",value:function(e){throw"canPerform function not implemented for operation: "+this.name}},{key:"perform",value:function(e,t){throw"perform function not implemented for operation: "+this.name}}])&&r(e.prototype,n),o&&r(e,o),t}();n.Operation=o},{}],82:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.OperationsManager=void 0;var r=e("./flip-subtree"),i=e("./payoffs-transformation.js");function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.operations=[],this.operationByName={},this.data=e,this.expressionEngine=t,this.jobsManger=n,this.registerOperation(new r.FlipSubtree(e,t)),this.registerOperation(new i.PayoffsTransformation(e,t))}var e,t,n;return e=o,(t=[{key:"registerOperation",value:function(e){this.operations.push(e),this.operationByName[e.name]=e}},{key:"getOperationByName",value:function(e){return this.operationByName[e]}},{key:"operationsForObject",value:function(t){return this.operations.filter(function(e){return e.isApplicable(t)})}},{key:"setData",value:function(t){this.data=t,this.operations.forEach(function(e){return e.data=t})}},{key:"performOperation",value:function(n,e,o){var r=this,i=this.getOperationByName(e);return i.jobName?(o.objectId=n.id,this.jobsManger.run(i.jobName,o,this.data,!1).then(function(e){var t=e.getData();return r.data.nodes=t.nodes,r.data.edges=t.edges,r.data.code=t.code,i.postProcess(n,o),!0})):Promise.resolve(i.perform(n,o))}}])&&u(e.prototype,t),n&&u(e,n),o}();n.OperationsManager=o},{"./flip-subtree":79,"./payoffs-transformation.js":83}],83:[function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.PayoffsTransformation=void 0;var i=e("sd-model"),u=e("../validation/tree-validator"),a=e("./job-executing-operation"),s=e("../jobs/configurations/payoffs-transformation/payoffs-transformation-job");function r(e){return(r="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var b=function(e){function o(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(n=l(this,f(o).call(this,o.$NAME,s.PayoffsTransformationJob.$NAME))).data=e,n.expressionEngine=t,n.treeValidator=new u.TreeValidator(t),n}var t,n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(o,a.JobExecutingOperation),t=o,(n=[{key:"isApplicable",value:function(e){return e instanceof i.domain.ChanceNode||e instanceof i.domain.DecisionNode}},{key:"canPerform",value:function(e){return!!this.isApplicable(e)&&(!!this.treeValidator.validate(this.data.getAllNodesInSubtree(e)).isValid()&&(!e.$parent&&0<e.childEdges.length))}}])&&c(t.prototype,n),r&&c(t,r),o}();(n.PayoffsTransformation=b).$NAME="payoffsTransformation"},{"../jobs/configurations/payoffs-transformation/payoffs-transformation-job":11,"../validation/tree-validator":90,"./job-executing-operation":80,"sd-model":"sd-model"}],84:[function(e,t,n){"use strict";function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.Decision=void 0;var r=function(){function u(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),this.children=[],this.node=e,this.decisionValue=t,this.key=u.generateKey(this)}var e,t,n;return e=u,n=[{key:"generateKey",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"id",n=e.node.childEdges[e.decisionValue];return(e.node[t]+":"+(n[t]?n[t]:e.decisionValue+1)).replace(/\n/g," ")}},{key:"getDecision",value:function(e,t){if(e.node===t||e.node.id===t.id)return e;for(var n=0;n<e.children.length;n++){var o=u.getDecision(e.children[n],t);if(o)return o}}},{key:"toDecisionString",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"name",o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"",r=u.generateKey(e,n),i="";return e.children.forEach(function(e){i&&(i+=t?"\n"+o:", "),i+=u.toDecisionString(e,t,n,o+"\t")}),e.children.length&&(i=t?"\n"+o+i:" - ("+i+")"),r+i}}],(t=[{key:"addDecision",value:function(e,t){var n=new u(e,t);return this.children.push(n),this.key=u.generateKey(this),n}},{key:"getDecision",value:function(e){return u.getDecision(this,e)}},{key:"toDecisionString",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return u.toDecisionString(this,e)}}])&&o(e.prototype,t),n&&o(e,n),u}();n.Decision=r},{}],85:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PoliciesCollector=void 0;var r=e("./policy"),u=e("sd-model"),a=e("sd-utils"),s=e("./decision");function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.policies=[],this.ruleName=!1,this.ruleName=t,this.collect(e).forEach(function(e,t){n.policies.push(new r.Policy("#"+(t+1),e))}),1===this.policies.length&&(this.policies[0].id="default")}var e,t,n;return e=o,(t=[{key:"collect",value:function(e){for(var t,i=this,n=[e],o=[];n.length;)t=n.shift(),this.ruleName&&!t.computedValue(this.ruleName,"optimal")||(t instanceof u.domain.DecisionNode?o.push(t):t.childEdges.forEach(function(e,t){n.push(e.childNode)}));return a.Utils.cartesianProductOf(o.map(function(o){var r=[];return o.childEdges.forEach(function(e,n){i.ruleName&&!e.computedValue(i.ruleName,"optimal")||i.collect(e.childNode).forEach(function(e){var t=new s.Decision(o,n);r.push(t),t.children=e})}),r}))}}])&&i(e.prototype,t),n&&i(e,n),o}();n.PoliciesCollector=o},{"./decision":84,"./policy":86,"sd-model":"sd-model","sd-utils":"sd-utils"}],86:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Policy=void 0;var r=e("./decision");function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function o(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.decisions=[],this.id=e,this.decisions=t||[],this.key=o.generateKey(this)}var e,t,n;return e=o,n=[{key:"generateKey",value:function(e){var t="";return e.decisions.forEach(function(e){return t+=(t?"&":"")+e.key}),t}},{key:"getDecision",value:function(e,t){for(var n=0;n<e.decisions.length;n++){var o=r.Decision.getDecision(e.decisions[n],t);if(o)return o}return null}},{key:"toPolicyString",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],o="";return e.decisions.forEach(function(e){o&&(o+=t?"\n":", "),o+=r.Decision.toDecisionString(e,t,"name","\t")}),n&&void 0!==e.id?e.id+" "+o:o}}],(t=[{key:"addDecision",value:function(e,t){var n=new r.Decision(e,t);return this.decisions.push(n),this.key=o.generateKey(this),n}},{key:"equals",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.key==e.key&&(t||this.id===e.id)}},{key:"getDecision",value:function(e){return o.getDecision(this,e)}},{key:"toPolicyString",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return o.toPolicyString(this,e)}}])&&i(e.prototype,t),n&&i(e,n),o}();n.Policy=o},{"./decision":84}],87:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.McdmWeightValueValidator=void 0;var r=e("sd-expression-engine");e("sd-utils");function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.additionalValidator=null,this.additionalValidator=e}var e,n,o;return e=t,(n=[{key:"validate",value:function(e){if(null==e)return!1;if(parseFloat(e)!==1/0&&!r.ExpressionEngine.validate(e,{},!1))return!1;e=r.ExpressionEngine.toNumber(e);var t=Number.MAX_SAFE_INTEGER||9007199254740991;return!(r.ExpressionEngine.compare(e,0)<0||e!==1/0&&0<r.ExpressionEngine.compare(e,t))&&(!this.additionalValidator||this.additionalValidator(r.ExpressionEngine.toNumber(e)))}}])&&i(e.prototype,n),o&&i(e,o),t}();n.McdmWeightValueValidator=o},{"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],88:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PayoffValueValidator=void 0;var r=e("sd-expression-engine");e("sd-utils");function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.expressionEngine=e}var e,n,o;return e=t,(n=[{key:"validate",value:function(e){if(null==e)return!1;e=r.ExpressionEngine.toNumber(e);var t=Number.MAX_SAFE_INTEGER||9007199254740991;return 0<=r.ExpressionEngine.compare(e,-t)&&r.ExpressionEngine.compare(e,t)<=0}}])&&i(e.prototype,n),o&&i(e,o),t}();n.PayoffValueValidator=o},{"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],89:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ProbabilityValueValidator=void 0;var r=e("sd-expression-engine");e("sd-utils");function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.expressionEngine=e}var e,n,o;return e=t,(n=[{key:"validate",value:function(e,t){return null!=e&&(0<=(e=r.ExpressionEngine.toNumber(e)).compare(0)&&e.compare(1)<=0)}}])&&i(e.prototype,n),o&&i(e,o),t}();n.ProbabilityValueValidator=o},{"sd-expression-engine":"sd-expression-engine","sd-utils":"sd-utils"}],90:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.TreeValidator=void 0;var c=e("sd-model"),l=e("sd-expression-engine"),r=e("./probability-value-validator"),i=e("./payoff-value-validator");function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.expressionEngine=e,this.probabilityValueValidator=new r.ProbabilityValueValidator(e),this.payoffValueValidator=new i.PayoffValueValidator(e)}var e,n,o;return e=t,(n=[{key:"validate",value:function(e){var t=this,n=new c.ValidationResult;return e.forEach(function(e){t.validateNode(e,n)}),n}},{key:"validateNode",value:function(u){var a=this,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new c.ValidationResult;if(!(u instanceof c.domain.TerminalNode)){u.childEdges.length||s.addError("incompletePath",u);var t=l.ExpressionEngine.toNumber(0);return u.childEdges.forEach(function(r,i){if(r.setValueValidity("probability",!0),u instanceof c.domain.ChanceNode){var e=r.computedBaseProbability();a.probabilityValueValidator.validate(e)?t=l.ExpressionEngine.add(t,e):l.ExpressionEngine.isHash(r.probability)||(s.addError({name:"invalidProbability",data:{number:i+1}},u),r.setValueValidity("probability",!1))}r.payoff.forEach(function(e,t){var n="payoff["+t+"]";r.setValueValidity(n,!0);var o=r.computedBasePayoff(void 0,t);a.payoffValueValidator.validate(o)||(s.addError({name:"invalidPayoff",data:{number:i+1}},u),r.setValueValidity(n,!1))})}),u instanceof c.domain.ChanceNode&&(!isNaN(t)&&t.equals(1)||s.addError("probabilityDoNotSumUpTo1",u)),s}}}])&&u(e.prototype,n),o&&u(e,o),t}();n.TreeValidator=o},{"./payoff-value-validator":88,"./probability-value-validator":89,"sd-expression-engine":"sd-expression-engine","sd-model":"sd-model"}],"sd-computations":[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./src/index");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})})},{"./src/index":6}]},{},[]);
//# sourceMappingURL=sd-computations.min.js.map
